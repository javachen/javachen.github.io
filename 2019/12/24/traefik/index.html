<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Traefik使用 - JavaChen Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="JavaChen" /><meta name="description" content="traefik 是一个开源的反向代理和负载均衡工具，现在官方介绍中将其定位为云原生的边缘路由器，且用了一堆修饰词：简单、自动、高速、全面、开源、产品级、内" /><meta name="keywords" content="Java, Hadoop, Docker, Kubernetes" />


<meta name="baidu-site-verification" content="OMsbiDfo1G" />



<meta name="generator" content="Hugo 0.54.0 with theme even" />


<link rel="canonical" href="https://blog.javachen.space/2019/12/24/traefik/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.b90a1cc1.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="Traefik使用" />
<meta property="og:description" content="traefik 是一个开源的反向代理和负载均衡工具，现在官方介绍中将其定位为云原生的边缘路由器，且用了一堆修饰词：简单、自动、高速、全面、开源、产品级、内" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.javachen.space/2019/12/24/traefik/" />
<meta property="article:published_time" content="2019-12-24T08:00:00&#43;08:00"/>
<meta property="article:modified_time" content="2019-12-24T08:00:00&#43;08:00"/>

<meta itemprop="name" content="Traefik使用">
<meta itemprop="description" content="traefik 是一个开源的反向代理和负载均衡工具，现在官方介绍中将其定位为云原生的边缘路由器，且用了一堆修饰词：简单、自动、高速、全面、开源、产品级、内">


<meta itemprop="datePublished" content="2019-12-24T08:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2019-12-24T08:00:00&#43;08:00" />
<meta itemprop="wordCount" content="8958">



<meta itemprop="keywords" content="traefik," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Traefik使用"/>
<meta name="twitter:description" content="traefik 是一个开源的反向代理和负载均衡工具，现在官方介绍中将其定位为云原生的边缘路由器，且用了一堆修饰词：简单、自动、高速、全面、开源、产品级、内"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">JavaChen Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">JavaChen Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Traefik使用</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-12-24 </span>
        <div class="post-category">
            <a href="/categories/kubernetes/"> kubernetes </a>
            </div>
          <span class="more-meta"> 约 8958 字 </span>
          <span class="more-meta"> 预计阅读 18 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#安装traefik">安装Traefik</a>
<ul>
<li><a href="#使用docker安装">使用Docker安装</a></li>
<li><a href="#使用docker-compose安装">使用docker-compose安装</a></li>
</ul></li>
<li><a href="#测试路由">测试路由</a></li>
<li><a href="#traefik配置">Traefik配置</a>
<ul>
<li><a href="#静态配置">静态配置</a></li>
<li><a href="#动态配置">动态配置</a></li>
<li><a href="#traefik-toml">traefik.toml</a>
<ul>
<li><a href="#global">global</a></li>
<li><a href="#serverstransport">serversTransport</a></li>
<li><a href="#entrypoints">entryPoints</a></li>
<li><a href="#log">log</a></li>
<li><a href="#accesslog">accessLog</a></li>
<li><a href="#metrics">metrics</a></li>
<li><a href="#tracing">tracing</a></li>
<li><a href="#api">api</a></li>
<li><a href="#ping">ping</a></li>
<li><a href="#providers">providers</a>
<ul>
<li><a href="#docker">Docker</a></li>
<li><a href="#file">File</a></li>
</ul></li>
<li><a href="#hostresolver">hostResolver</a></li>
<li><a href="#certificatesresolvers">certificatesResolvers</a>
<ul>
<li><a href="#配置示例">配置示例</a></li>
<li><a href="#acme-challenges">ACME Challenges</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#示例">示例</a>
<ul>
<li><a href="#docker通过traefik-toml部署traefik">docker通过traefik.toml部署traefik</a></li>
<li><a href="#开启prometheus-metrics">开启prometheus metrics</a></li>
<li><a href="#traefik开启tls">Traefik开启TLS</a></li>
<li><a href="#给应用配置letsencrypt证书">给应用配置LetsEncrypt证书</a></li>
<li><a href="#测试mongo-tcp路由">测试Mongo TCP路由</a></li>
<li><a href="#测试mysql-tcp路由">测试Mysql TCP路由</a></li>
</ul></li>
<li><a href="#参考文章">参考文章</a></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<p>traefik 是一个开源的反向代理和负载均衡工具，现在官方介绍中将其定位为云原生的边缘路由器，且用了一堆修饰词：简单、自动、高速、全面、开源、产品级、内置监控指标和主流集群技术集成等等。</p>

<p>本文使用的Traefik版本为V2.1.1。中文文档，请参考 <a href="https://www.qikqiak.com/traefik-book/">https://www.qikqiak.com/traefik-book/</a></p>

<h1 id="安装traefik">安装Traefik</h1>

<h2 id="使用docker安装">使用Docker安装</h2>

<p>使用<a href="https://hub.docker.com/_/traefik">官方镜像</a>安装并设置<a href="https://raw.githubusercontent.com/containous/traefik/master/traefik.sample.toml">配置参数</a>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker run -d -p <span class="m">8080</span>:8080 -p <span class="m">80</span>:80 --name traefik<span class="se">\
</span><span class="se"></span>    -v <span class="nv">$PWD</span>/traefik.toml:/etc/traefik/traefik.toml traefik:latest</code></pre></td></tr></table>
</div>
</div>
<p>说明：</p>

<ul>
<li>traefik使用8080和80端口，因为宿主机这两个被使用，所以将这两个映射到其他端口</li>
<li>traefik镜像使用最新版本，镜像都是基于  <a href="https://hub.docker.com/_/alpine">Alpine Linux Official image</a></li>
<li>默认traefik会寻找/etc/traefik/traefik.toml下的配置文件</li>
</ul>

<p>因为初次接触traefik，所以对traefik.toml的配置不熟悉，如果上面启动的traefik出现问题，没有关系，可以跳过，往下看，等对traefik有了全面的立即之后，再回过头来配置traefik.toml。</p>

<h2 id="使用docker-compose安装">使用docker-compose安装</h2>

<p>我们使用 <code>traefik:latest</code> 作为镜像启动<code>traefik</code> 服务。<code>docker-compose.yaml</code> 配置文件如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>traefik<span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># The official Traefik docker image</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>traefik<span class="p">:</span>latest<span class="w">
</span><span class="w">    </span><span class="c"># Enables the web UI and tells Traefik to listen to docker</span><span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w"> </span>--api.insecure=<span class="kc">true</span><span class="w"> </span>--providers.docker<span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># The HTTP port</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;80:80&#34;</span><span class="w">
</span><span class="w">      </span><span class="c"># The Web UI (enabled by --api.insecure=true)</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8080:8080&#34;</span><span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># So that Traefik can listen to the Docker events</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/var/run/docker.sock<span class="p">:</span>/var/run/docker.sock</code></pre></td></tr></table>
</div>
</div>
<p>此时我们使用命令 <code>docker-compose up -d</code> 开启 <code>traefik</code> 服务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up -d </code></pre></td></tr></table>
</div>
</div>
<p>查看状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ docker-compose ps
     Name                   Command               State                     Ports
--------------------------------------------------------------------------------------------
root_traefik_1   /entrypoint.sh --api.insec ...   Up      <span class="m">0</span>.0.0.0:80-&gt;80/tcp, <span class="m">0</span>.0.0.0:8080-&gt;8080/tcp</code></pre></td></tr></table>
</div>
</div>
<p>通过命令行访问traefik对外暴露的http接口：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">curl -s <span class="s2">&#34;http://localhost:8080/api/rawdata&#34;</span> <span class="p">|</span> python -m json.tool
<span class="o">{</span>
    <span class="s2">&#34;middlewares&#34;</span>: <span class="o">{</span>
        <span class="s2">&#34;dashboard_redirect@internal&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;redirectRegex&#34;</span>: <span class="o">{</span>
                <span class="s2">&#34;permanent&#34;</span>: true,
                <span class="s2">&#34;regex&#34;</span>: <span class="s2">&#34;^(http:\\/\\/[^:]+(:\\d+)?)/</span>$<span class="s2">&#34;</span>,
                <span class="s2">&#34;replacement&#34;</span>: <span class="s2">&#34;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">/dashboard/&#34;</span>
            <span class="o">}</span>,
            <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;enabled&#34;</span>,
            <span class="s2">&#34;usedBy&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;dashboard@internal&#34;</span>
            <span class="o">]</span>
        <span class="o">}</span>,
        <span class="s2">&#34;dashboard_stripprefix@internal&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;enabled&#34;</span>,
            <span class="s2">&#34;stripPrefix&#34;</span>: <span class="o">{</span>
                <span class="s2">&#34;prefixes&#34;</span>: <span class="o">[</span>
                    <span class="s2">&#34;/dashboard/&#34;</span>,
                    <span class="s2">&#34;/dashboard&#34;</span>
                <span class="o">]</span>
            <span class="o">}</span>,
            <span class="s2">&#34;usedBy&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;dashboard@internal&#34;</span>
            <span class="o">]</span>
        <span class="o">}</span>
    <span class="o">}</span>,
    <span class="s2">&#34;routers&#34;</span>: <span class="o">{</span>
        <span class="s2">&#34;api@internal&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;entryPoints&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;traefik&#34;</span>
            <span class="o">]</span>,
            <span class="s2">&#34;priority&#34;</span>: <span class="m">2147483646</span>,
            <span class="s2">&#34;rule&#34;</span>: <span class="s2">&#34;PathPrefix(`/api`)&#34;</span>,
            <span class="s2">&#34;service&#34;</span>: <span class="s2">&#34;api@internal&#34;</span>,
            <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;enabled&#34;</span>,
            <span class="s2">&#34;using&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;traefik&#34;</span>
            <span class="o">]</span>
        <span class="o">}</span>,
        <span class="s2">&#34;dashboard@internal&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;entryPoints&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;traefik&#34;</span>
            <span class="o">]</span>,
            <span class="s2">&#34;middlewares&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;dashboard_redirect@internal&#34;</span>,
                <span class="s2">&#34;dashboard_stripprefix@internal&#34;</span>
            <span class="o">]</span>,
            <span class="s2">&#34;priority&#34;</span>: <span class="m">2147483645</span>,
            <span class="s2">&#34;rule&#34;</span>: <span class="s2">&#34;PathPrefix(`/`)&#34;</span>,
            <span class="s2">&#34;service&#34;</span>: <span class="s2">&#34;dashboard@internal&#34;</span>,
            <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;enabled&#34;</span>,
            <span class="s2">&#34;using&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;traefik&#34;</span>
            <span class="o">]</span>
        <span class="o">}</span>,
        <span class="s2">&#34;traefik-root@docker&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;rule&#34;</span>: <span class="s2">&#34;Host(`traefik-root`)&#34;</span>,
            <span class="s2">&#34;service&#34;</span>: <span class="s2">&#34;traefik-root&#34;</span>,
            <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;enabled&#34;</span>,
            <span class="s2">&#34;using&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;http&#34;</span>,
                <span class="s2">&#34;traefik&#34;</span>
            <span class="o">]</span>
        <span class="o">}</span>
    <span class="o">}</span>,
    <span class="s2">&#34;services&#34;</span>: <span class="o">{</span>
        <span class="s2">&#34;api@internal&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;enabled&#34;</span>,
            <span class="s2">&#34;usedBy&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;api@internal&#34;</span>
            <span class="o">]</span>
        <span class="o">}</span>,
        <span class="s2">&#34;dashboard@internal&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;enabled&#34;</span>,
            <span class="s2">&#34;usedBy&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;dashboard@internal&#34;</span>
            <span class="o">]</span>
        <span class="o">}</span>,
        <span class="s2">&#34;traefik-root@docker&#34;</span>: <span class="o">{</span>
            <span class="s2">&#34;loadBalancer&#34;</span>: <span class="o">{</span>
                <span class="s2">&#34;passHostHeader&#34;</span>: true,
                <span class="s2">&#34;servers&#34;</span>: <span class="o">[</span>
                    <span class="o">{</span>
                        <span class="s2">&#34;url&#34;</span>: <span class="s2">&#34;http://172.18.0.2:80&#34;</span>
                    <span class="o">}</span>
                <span class="o">]</span>
            <span class="o">}</span>,
            <span class="s2">&#34;serverStatus&#34;</span>: <span class="o">{</span>
                <span class="s2">&#34;http://172.18.0.2:80&#34;</span>: <span class="s2">&#34;UP&#34;</span>
            <span class="o">}</span>,
            <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;enabled&#34;</span>,
            <span class="s2">&#34;usedBy&#34;</span>: <span class="o">[</span>
                <span class="s2">&#34;traefik-root@docker&#34;</span>
            <span class="o">]</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>
<p>通过宿主机访问dashboard：<a href="http://192.168.56.11:8080/dashboard，可以看到：">http://192.168.56.11:8080/dashboard，可以看到：</a></p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9alpf2ruj31bk0kcmz5.jpg" alt="image-20191225213250883" /></p>

<p>可以看到traefik创建了两个<strong>Entrypoints</strong>：</p>

<ul>
<li>HTTP：端口为80</li>
<li>TRAEFIK：端口为8080，是Dashboard的入口端点</li>
</ul>

<h1 id="测试路由">测试路由</h1>

<p>接下来我们使用 <code>docker-compose</code> 启动一个简单的 <code>http</code> 服务，<code>docker-compose.yaml</code> 配置文件如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">version: <span class="s1">&#39;3&#39;</span>
services:
  traefik:
    <span class="c1"># The official Traefik docker image</span>
    image: traefik:latest
    <span class="c1"># Enables the web UI and tells Traefik to listen to docker</span>
    command: --api.insecure<span class="o">=</span><span class="nb">true</span> --providers.docker
    ports:
      <span class="c1"># The HTTP port</span>
      - <span class="s2">&#34;80:80&#34;</span>
      <span class="c1"># The Web UI (enabled by --api.insecure=true)</span>
      - <span class="s2">&#34;8080:8080&#34;</span>
    volumes:
      <span class="c1"># So that Traefik can listen to the Docker events</span>
      - /var/run/docker.sock:/var/run/docker.sock
      
  whoami:
    image: containous/whoami
    labels:
      <span class="c1"># Explicitly tell Traefik to expose this container</span>
      - <span class="s2">&#34;traefik.enable=true&#34;</span>
      <span class="c1"># The domain the service will respond to</span>
      - <span class="s2">&#34;traefik.http.routers.whoami.rule=Host(`whoami.docker.localhost`)&#34;</span>
      <span class="c1"># Allow request only from the predefined entry point named &#34;http&#34;</span>
      - <span class="s2">&#34;traefik.http.routers.whoami.entrypoints=http&#34;</span></code></pre></td></tr></table>
</div>
</div>
<ul>
<li>如果设置了 <code>--providers.docker.exposedbydefault=false</code>，则必须设置traefik.enable=true，才会暴露容器给traefik。</li>
<li>配置了容器的 <code>labels</code>，设置该服务的 <code>Host</code> 为 <code>whoami.docker.localhost</code>，给 <code>traefik</code> 提供标记</li>
</ul>

<p>创建服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up -d </code></pre></td></tr></table>
</div>
</div>
<p>查看新创建的服务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose ps
     Name                   Command               State                     Ports
----------------------------------------------------------------------------------------------------
root_traefik_1   /entrypoint.sh --api.insec ...   Up      <span class="m">0</span>.0.0.0:80-&gt;80/tcp, <span class="m">0</span>.0.0.0:8080-&gt;8080/tcp
root_whoami_1    /whoami                          Up      <span class="m">80</span>/tcp</code></pre></td></tr></table>
</div>
</div>
<p>再次查看traefik中的路由信息(就会发现服务自动加载进去了)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">curl -s <span class="s2">&#34;http://localhost:8880/api/rawdata&#34;</span> <span class="p">|</span> python -m json.tool</code></pre></td></tr></table>
</div>
</div>
<p>查看dashboard：</p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1ga80dd5i5qj32440k8788.jpg" alt="image-20191224185315155" /></p>

<p>此时我们可以通过主机名 <code>whoami.docker.localhost</code> 来访问 <code>whoami</code> 服务，我们使用 <code>curl</code> 做测试</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">curl -H Host:whoami.docker.localhost http://localhost</code></pre></td></tr></table>
</div>
</div>
<p>返回内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">Hostname: ac6e8f48820e
IP: <span class="m">127</span>.0.0.1
IP: <span class="m">172</span>.18.0.3
RemoteAddr: <span class="m">172</span>.18.0.2:38018
GET / HTTP/1.1
Host: whoami.docker.localhost
User-Agent: curl/7.29.0
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: <span class="m">172</span>.18.0.1
X-Forwarded-Host: whoami.docker.localhost
X-Forwarded-Port: <span class="m">80</span>
X-Forwarded-Proto: http
X-Forwarded-Server: 1410f6164208
X-Real-Ip: <span class="m">172</span>.18.0.1</code></pre></td></tr></table>
</div>
</div>
<p>服务正常访问。此时如果把 <code>Host</code> 配置为自己的域名，则已经可以使用自己的域名来提供服务。</p>

<p>单机扩容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up -d --scale <span class="nv">whoami</span><span class="o">=</span><span class="m">2</span></code></pre></td></tr></table>
</div>
</div>
<p>再次访问(就会发现自动负载到两个不同的实例上去了)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ curl -H Host:whoami.docker.localhost http://localhost
Hostname: ac6e8f48820e
IP: <span class="m">127</span>.0.0.1
IP: <span class="m">172</span>.18.0.3
RemoteAddr: <span class="m">172</span>.18.0.2:38018
GET / HTTP/1.1
Host: whoami.docker.localhost
User-Agent: curl/7.29.0
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: <span class="m">172</span>.18.0.1
X-Forwarded-Host: whoami.docker.localhost
X-Forwarded-Port: <span class="m">80</span>
X-Forwarded-Proto: http
X-Forwarded-Server: 1410f6164208
X-Real-Ip: <span class="m">172</span>.18.0.1


$ curl -H Host:whoami.docker.localhost http://localhost
Hostname: 3f64539c40b0
IP: <span class="m">127</span>.0.0.1
IP: <span class="m">172</span>.18.0.4
RemoteAddr: <span class="m">172</span>.18.0.2:44564
GET / HTTP/1.1
Host: whoami.docker.localhost
User-Agent: curl/7.29.0
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: <span class="m">172</span>.18.0.1
X-Forwarded-Host: whoami.docker.localhost
X-Forwarded-Port: <span class="m">80</span>
X-Forwarded-Proto: http
X-Forwarded-Server: 1410f6164208
X-Real-Ip: <span class="m">172</span>.18.0.1</code></pre></td></tr></table>
</div>
</div>
<p>查看dashboard上的<strong>whoami-traefik</strong> Service：</p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9at051xyj31fi0pugoe.jpg" alt="image-20191225213952227" /></p>

<p>可以查看镜像的ip：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ docker inspect root_whoami_1<span class="p">|</span>grep IPAddress
            <span class="s2">&#34;SecondaryIPAddresses&#34;</span>: null,
            <span class="s2">&#34;IPAddress&#34;</span>: <span class="s2">&#34;&#34;</span>,
                    <span class="s2">&#34;IPAddress&#34;</span>: <span class="s2">&#34;172.18.0.3&#34;</span>,
                    
$ docker inspect root_whoami_2<span class="p">|</span>grep IPAddress
            <span class="s2">&#34;SecondaryIPAddresses&#34;</span>: null,
            <span class="s2">&#34;IPAddress&#34;</span>: <span class="s2">&#34;&#34;</span>,
                    <span class="s2">&#34;IPAddress&#34;</span>: <span class="s2">&#34;172.18.0.4&#34;</span>,</code></pre></td></tr></table>
</div>
</div>
<h1 id="traefik配置">Traefik配置</h1>

<h2 id="静态配置">静态配置</h2>

<ul>
<li><p>File配置：<a href="https://docs.traefik.io/v2.0/reference/static-configuration/file/">https://docs.traefik.io/v2.0/reference/static-configuration/file/</a></p></li>

<li><p>CLI参数：<a href="https://docs.traefik.io/v2.0/reference/static-configuration/cli/">https://docs.traefik.io/v2.0/reference/static-configuration/cli/</a></p></li>

<li><p>环境变量：<a href="https://docs.traefik.io/v2.0/reference/static-configuration/env/">https://docs.traefik.io/v2.0/reference/static-configuration/env/</a></p></li>
</ul>

<p>Traefik在以下为主查找配置文件：</p>

<ul>
<li><code>/etc/traefik/</code></li>
<li><code>$XDG_CONFIG_HOME/</code></li>
<li><code>$HOME/.config/</code></li>
<li><code>.</code> (<em>the working directory</em>).</li>
</ul>

<p>可以通过环境变量参数覆盖配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">traefik --configFile<span class="o">=</span>foo/bar/myconfigfile.toml</code></pre></td></tr></table>
</div>
</div>
<h2 id="动态配置">动态配置</h2>

<ul>
<li><p>File配置：<a href="https://docs.traefik.io/v2.0/reference/dynamic-configuration/file/">https://docs.traefik.io/v2.0/reference/dynamic-configuration/file/</a></p></li>

<li><p>Docker配置：<a href="https://docs.traefik.io/v2.0/reference/dynamic-configuration/docker/">https://docs.traefik.io/v2.0/reference/dynamic-configuration/docker/</a></p></li>

<li><p>Kubernetes配置：<a href="https://docs.traefik.io/v2.0/reference/dynamic-configuration/kubernetes-crd/">https://docs.traefik.io/v2.0/reference/dynamic-configuration/kubernetes-crd/</a></p></li>

<li><p>Marathon：<a href="https://docs.traefik.io/v2.0/reference/dynamic-configuration/marathon/">https://docs.traefik.io/v2.0/reference/dynamic-configuration/marathon/</a></p></li>

<li><p>Rancher：<a href="https://docs.traefik.io/v2.0/reference/dynamic-configuration/rancher/">https://docs.traefik.io/v2.0/reference/dynamic-configuration/rancher/</a></p></li>
</ul>

<h2 id="traefik-toml">traefik.toml</h2>

<p>一个示例traefik.toml内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="c">################################################################</span>
<span class="c">#</span>
<span class="c"># Configuration sample for Traefik v2.</span>
<span class="c">#</span>
<span class="c"># For Traefik v1: https://github.com/containous/traefik/blob/v1.7/traefik.sample.toml</span>
<span class="c">#</span>
<span class="c">################################################################</span>

<span class="c">################################################################</span>
<span class="c"># 全局设置</span>
<span class="c">################################################################</span>
<span class="p">[</span><span class="nx">global</span><span class="p">]</span>
  <span class="nx">checkNewVersion</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="c">#默认为true</span>
  <span class="nx">sendAnonymousUsage</span> <span class="p">=</span> <span class="kc">false</span>

<span class="p">[</span><span class="nx">serversTransport</span><span class="p">]</span>
  <span class="nx">insecureSkipVerify</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">rootCAs</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;foobar&#34;</span><span class="p">,</span> <span class="s2">&#34;foobar&#34;</span><span class="p">]</span>
  <span class="nx">maxIdleConnsPerHost</span> <span class="p">=</span> <span class="mi">42</span>
  <span class="p">[</span><span class="nx">serversTransport</span><span class="p">.</span><span class="nx">forwardingTimeouts</span><span class="p">]</span>
    <span class="nx">dialTimeout</span> <span class="p">=</span> <span class="mi">42</span>
    <span class="nx">responseHeaderTimeout</span> <span class="p">=</span> <span class="mi">42</span>
    <span class="nx">idleConnTimeout</span> <span class="p">=</span> <span class="mi">42</span>
    
<span class="c">################################################################</span>
<span class="c"># 入口点设置</span>
<span class="c">################################################################</span>
<span class="p">[</span><span class="nx">entryPoints</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">http</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:80&#34;</span>

  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">https</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:443&#34;</span>
  
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">traefik</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:8080&#34;</span>  

<span class="c">################################################################</span>
<span class="c"># 日志设置</span>
<span class="c">################################################################</span>
<span class="p">[</span><span class="nx">log</span><span class="p">]</span>
  <span class="c"># 日志级别，默认 ERROR</span>
  <span class="nx">level</span> <span class="p">=</span> <span class="s2">&#34;DEBUG&#34;</span>

  <span class="c"># 日志默认会打印到stdout，如果不指定filePath，默认使用stdout</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/traefik.log&#34;</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span>

<span class="c">################################################################</span>
<span class="c"># 访问日志 配置</span>
<span class="c">################################################################</span>
<span class="p">[</span><span class="nx">accessLog</span><span class="p">]</span>
  <span class="c"># 日志默认会打印到stdout，如果不指定filePath，默认使用 os.Stdout</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/access.log&#34;</span>

  <span class="c"># 格式目前支持 &#34;json&#34; 和 &#34;common&#34;（默认）</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span>

<span class="c">################################################################</span>
<span class="c"># API 及控制台配置</span>
<span class="c">################################################################</span>
<span class="p">[</span><span class="nx">api</span><span class="p">]</span>
  <span class="c"># Enable the API in insecure mode</span>
  <span class="c">#</span>
  <span class="c"># Optional</span>
  <span class="c"># Default: true</span>
  <span class="c">#</span>
  <span class="c"># insecure = false</span>

  <span class="c"># 开启控制台（默认开启）</span>
  <span class="nx">dashboard</span> <span class="p">=</span> <span class="kc">true</span>

<span class="c">################################################################</span>
<span class="c"># Ping 配置</span>
<span class="c">################################################################</span>
<span class="p">[</span><span class="nx">ping</span><span class="p">]</span>
  <span class="c"># 入口点名称，默认为traefik</span>
  <span class="c"># entryPoint = &#34;traefik&#34;</span>

<span class="p">[</span><span class="nx">providers</span><span class="p">.</span><span class="nx">file</span><span class="p">]</span>
  <span class="nx">directory</span> <span class="p">=</span> <span class="s2">&#34;/etc/traefik/dynamic-conf.toml&#34;</span>
  
<span class="c">################################################################</span>
<span class="c"># Docker 后端配置</span>
<span class="c">################################################################</span>
<span class="p">[</span><span class="nx">providers</span><span class="p">.</span><span class="nx">docker</span><span class="p">]</span>
  <span class="c"># Docker服务后端，默认为unix:///var/run/docker.sock，也可以设置为tcp://10.10.10.10:2375</span>
  <span class="nx">endpoint</span> <span class="p">=</span> <span class="s2">&#34;unix:///var/run/docker.sock&#34;</span>

  <span class="c"># Default host rule.</span>
  <span class="c">#</span>
  <span class="c"># Optional</span>
  <span class="c"># Default: &#34;Host(`{{ normalize .Name }}`)&#34;</span>
  <span class="c">#</span>
  <span class="c"># defaultRule = &#34;Host(`{{ normalize .Name }}.docker.localhost`)&#34;</span>

  <span class="c"># 对容器默认进行暴露（默认开启）</span>
	<span class="c">#   如果关闭选项，则容器不包含 `traefik.enable=true` 标签，就不会被暴露</span>
  <span class="c"># exposedByDefault = false</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="global">global</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">global</span><span class="p">]</span>
  <span class="nx">checkNewVersion</span> <span class="p">=</span> <span class="kc">true</span> <span class="c">#检查新版本</span>
  <span class="nx">sendAnonymousUsage</span> <span class="p">=</span> <span class="kc">true</span> <span class="c">#发送匿名使用数据</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="serverstransport">serversTransport</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">serversTransport</span><span class="p">]</span>
  <span class="nx">insecureSkipVerify</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">rootCAs</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;foobar&#34;</span><span class="p">,</span> <span class="s2">&#34;foobar&#34;</span><span class="p">]</span>
  <span class="nx">maxIdleConnsPerHost</span> <span class="p">=</span> <span class="mi">42</span>
  <span class="p">[</span><span class="nx">serversTransport</span><span class="p">.</span><span class="nx">forwardingTimeouts</span><span class="p">]</span>
    <span class="nx">dialTimeout</span> <span class="p">=</span> <span class="mi">42</span>
    <span class="nx">responseHeaderTimeout</span> <span class="p">=</span> <span class="mi">42</span>
    <span class="nx">idleConnTimeout</span> <span class="p">=</span> <span class="mi">42</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="entrypoints">entryPoints</h3>

<p>考虑到隐私以及安全，不对外公开的服务可以配置 <code>Basic Auth</code>，<code>Digest Auth</code> 或者 <code>WhiteList</code>，或者直接搭建 VPN，在内网内进行访问。至于 <code>Basic Auth</code> 等，可以参考 <strong>traefik middlewares</strong></p>

<p><img src="https://docs.traefik.io/assets/img/entrypoints.png" alt="entryPoints" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">entryPoints</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">http</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:80&#34;</span>

  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">https</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:443&#34;</span>
  
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">traefik</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:8080&#34;</span>  </code></pre></td></tr></table>
</div>
</div>
<p>上面定义了三个entryPoints，名称分别为web、websecure、traefik，关于entryPoints完整的定义如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="c">## Static configuration</span>
<span class="p">[</span><span class="nx">entryPoints</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:8888&#34;</span>
    <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">transport</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">lifeCycle</span><span class="p">]</span>
        <span class="nx">requestAcceptGraceTimeout</span> <span class="p">=</span> <span class="mi">42</span>
        <span class="nx">graceTimeOut</span> <span class="p">=</span> <span class="mi">42</span>
      <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">respondingTimeouts</span><span class="p">]</span>
        <span class="nx">readTimeout</span> <span class="p">=</span> <span class="mi">42</span>
        <span class="nx">writeTimeout</span> <span class="p">=</span> <span class="mi">42</span>
        <span class="nx">idleTimeout</span> <span class="p">=</span> <span class="mi">42</span>
    <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">proxyProtocol</span><span class="p">]</span>
      <span class="nx">insecure</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="nx">trustedIPs</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span> <span class="s2">&#34;192.168.0.1&#34;</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">forwardedHeaders</span><span class="p">]</span>
      <span class="nx">insecure</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="nx">trustedIPs</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span> <span class="s2">&#34;192.168.0.1&#34;</span><span class="p">]</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="log">log</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">log</span><span class="p">]</span>
  <span class="c"># 日志级别，默认 ERROR</span>
  <span class="nx">level</span> <span class="p">=</span> <span class="s2">&#34;DEBUG&#34;</span>
  <span class="c"># 日志默认会打印到stdout，如果不指定filePath，默认使用stdout</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/traefik.log&#34;</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span> <span class="c"># 格式目前支持 &#34;json&#34; 和 &#34;common&#34;（默认）</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="accesslog">accessLog</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">accessLog</span><span class="p">]</span>
  <span class="c"># 日志默认会打印到stdout，如果不指定filePath，默认使用 os.Stdout</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/access.log&#34;</span>
	<span class="nx">bufferingSize</span> <span class="p">=</span> <span class="mi">100</span>
	
  <span class="c"># 格式目前支持 &#34;json&#34; 和 &#34;common&#34;（默认）</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span>
  
  <span class="c">#过滤日志</span>
  <span class="p">[</span><span class="nx">accessLog</span><span class="p">.</span><span class="nx">filters</span><span class="p">]</span>    
    <span class="nx">statusCodes</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;200&#34;</span><span class="p">,</span> <span class="s2">&#34;300-302&#34;</span><span class="p">]</span>
    <span class="nx">retryAttempts</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">minDuration</span> <span class="p">=</span> <span class="s2">&#34;10ms&#34;</span>
    
  <span class="c">#定义日志的字段，有三种模式：keep、drop、redact  </span>
  <span class="p">[</span><span class="nx">accessLog</span><span class="p">.</span><span class="nx">fields</span><span class="p">]</span>
    <span class="nx">defaultMode</span> <span class="p">=</span> <span class="s2">&#34;keep&#34;</span>
    <span class="p">[</span><span class="nx">accessLog</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">names</span><span class="p">]</span>
      <span class="s2">&#34;ClientUsername&#34;</span> <span class="p">=</span> <span class="s2">&#34;drop&#34;</span>
    <span class="p">[</span><span class="nx">accessLog</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">headers</span><span class="p">]</span>
      <span class="nx">defaultMode</span> <span class="p">=</span> <span class="s2">&#34;keep&#34;</span>
      <span class="p">[</span><span class="nx">accessLog</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">names</span><span class="p">]</span>
        <span class="s2">&#34;User-Agent&#34;</span> <span class="p">=</span> <span class="s2">&#34;redact&#34;</span>
        <span class="s2">&#34;Authorization&#34;</span> <span class="p">=</span> <span class="s2">&#34;drop&#34;</span>
        <span class="s2">&#34;Content-Type&#34;</span> <span class="p">=</span> <span class="s2">&#34;keep&#34;</span>  
  </code></pre></td></tr></table>
</div>
</div>
<p>可用的字段：</p>

<table>
<thead>
<tr>
<th align="left">Field</th>
<th align="left">Description</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left"><code>StartUTC</code></td>
<td align="left">The time at which request processing started.</td>
</tr>

<tr>
<td align="left"><code>StartLocal</code></td>
<td align="left">The local time at which request processing started.</td>
</tr>

<tr>
<td align="left"><code>Duration</code></td>
<td align="left">The total time taken (in nanoseconds) by processing the response, including the origin server&rsquo;s time but not the log writing time.</td>
</tr>

<tr>
<td align="left"><code>FrontendName</code></td>
<td align="left">The name of the Traefik frontend.</td>
</tr>

<tr>
<td align="left"><code>BackendName</code></td>
<td align="left">The name of the Traefik backend.</td>
</tr>

<tr>
<td align="left"><code>BackendURL</code></td>
<td align="left">The URL of the Traefik backend.</td>
</tr>

<tr>
<td align="left"><code>BackendAddr</code></td>
<td align="left">The IP:port of the Traefik backend (extracted from <code>BackendURL</code>)</td>
</tr>

<tr>
<td align="left"><code>ClientAddr</code></td>
<td align="left">The remote address in its original form (usually IP:port).</td>
</tr>

<tr>
<td align="left"><code>ClientHost</code></td>
<td align="left">The remote IP address from which the client request was received.</td>
</tr>

<tr>
<td align="left"><code>ClientPort</code></td>
<td align="left">The remote TCP port from which the client request was received.</td>
</tr>

<tr>
<td align="left"><code>ClientUsername</code></td>
<td align="left">The username provided in the URL, if present.</td>
</tr>

<tr>
<td align="left"><code>RequestAddr</code></td>
<td align="left">The HTTP Host header (usually IP:port). This is treated as not a header by the Go API.</td>
</tr>

<tr>
<td align="left"><code>RequestHost</code></td>
<td align="left">The HTTP Host server name (not including port).</td>
</tr>

<tr>
<td align="left"><code>RequestPort</code></td>
<td align="left">The TCP port from the HTTP Host.</td>
</tr>

<tr>
<td align="left"><code>RequestMethod</code></td>
<td align="left">The HTTP method.</td>
</tr>

<tr>
<td align="left"><code>RequestPath</code></td>
<td align="left">The HTTP request URI, not including the scheme, host or port.</td>
</tr>

<tr>
<td align="left"><code>RequestProtocol</code></td>
<td align="left">The version of HTTP requested.</td>
</tr>

<tr>
<td align="left"><code>RequestLine</code></td>
<td align="left"><code>RequestMethod</code> + <code>RequestPath</code> + <code>RequestProtocol</code></td>
</tr>

<tr>
<td align="left"><code>RequestContentSize</code></td>
<td align="left">The number of bytes in the request entity (a.k.a. body) sent by the client.</td>
</tr>

<tr>
<td align="left"><code>OriginDuration</code></td>
<td align="left">The time taken by the origin server (&lsquo;upstream&rsquo;) to return its response.</td>
</tr>

<tr>
<td align="left"><code>OriginContentSize</code></td>
<td align="left">The content length specified by the origin server, or 0 if unspecified.</td>
</tr>

<tr>
<td align="left"><code>OriginStatus</code></td>
<td align="left">The HTTP status code returned by the origin server. If the request was handled by this Traefik instance (e.g. with a redirect), then this value will be absent.</td>
</tr>

<tr>
<td align="left"><code>OriginStatusLine</code></td>
<td align="left"><code>OriginStatus</code> + Status code explanation</td>
</tr>

<tr>
<td align="left"><code>DownstreamStatus</code></td>
<td align="left">The HTTP status code returned to the client.</td>
</tr>

<tr>
<td align="left"><code>DownstreamStatusLine</code></td>
<td align="left"><code>DownstreamStatus</code> + Status code explanation</td>
</tr>

<tr>
<td align="left"><code>DownstreamContentSize</code></td>
<td align="left">The number of bytes in the response entity returned to the client. This is in addition to the &ldquo;Content-Length&rdquo; header, which may be present in the origin response.</td>
</tr>

<tr>
<td align="left"><code>RequestCount</code></td>
<td align="left">The number of requests received since the Traefik instance started.</td>
</tr>

<tr>
<td align="left"><code>GzipRatio</code></td>
<td align="left">The response body compression ratio achieved.</td>
</tr>

<tr>
<td align="left"><code>Overhead</code></td>
<td align="left">The processing time overhead caused by Traefik.</td>
</tr>

<tr>
<td align="left"><code>RetryAttempts</code></td>
<td align="left">The amount of attempts the request was retried.</td>
</tr>
</tbody>
</table>

<h3 id="metrics">metrics</h3>

<p>支持以下几种：</p>

<ul>
<li><a href="https://docs.traefik.io/v2.0/observability/metrics/datadog/">Datadog</a></li>
<li><a href="https://docs.traefik.io/v2.0/observability/metrics/influxdb/">InfluxDB</a></li>
<li><a href="https://docs.traefik.io/v2.0/observability/metrics/prometheus/">Prometheus</a></li>
<li><a href="https://docs.traefik.io/v2.0/observability/metrics/statsd/">StatsD</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">metrics</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">prometheus</span><span class="p">]</span>
    <span class="nx">buckets</span> <span class="p">=</span> <span class="p">[</span><span class="mf">42.0</span><span class="p">,</span> <span class="mf">42.0</span><span class="p">]</span>
    <span class="nx">addEntryPointsLabels</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">addServicesLabels</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">entryPoint</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
  <span class="p">[</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">datadog</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">pushInterval</span> <span class="p">=</span> <span class="s2">&#34;10s&#34;</span>
    <span class="nx">addEntryPointsLabels</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">addServicesLabels</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">[</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">statsD</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">pushInterval</span> <span class="p">=</span> <span class="s2">&#34;10s&#34;</span>
    <span class="nx">addEntryPointsLabels</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">addServicesLabels</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="p">[</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">influxDB</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">protocol</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">pushInterval</span> <span class="p">=</span> <span class="s2">&#34;10s&#34;</span>
    <span class="nx">database</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">retentionPolicy</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">username</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">password</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">addEntryPointsLabels</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">addServicesLabels</span> <span class="p">=</span> <span class="kc">true</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="tracing">tracing</h3>

<p>支持以下几种：</p>

<ul>
<li><a href="https://docs.traefik.io/v2.0/observability/tracing/jaeger/">Jaeger</a></li>
<li><a href="https://docs.traefik.io/v2.0/observability/tracing/zipkin/">Zipkin</a></li>
<li><a href="https://docs.traefik.io/v2.0/observability/tracing/datadog/">Datadog</a></li>
<li><a href="https://docs.traefik.io/v2.0/observability/tracing/instana/">Instana</a></li>
<li><a href="https://docs.traefik.io/v2.0/observability/tracing/haystack/">Haystack</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">tracing</span><span class="p">]</span>
  <span class="nx">serviceName</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
  <span class="nx">spanNameLimit</span> <span class="p">=</span> <span class="mi">42</span>
  <span class="p">[</span><span class="nx">tracing</span><span class="p">.</span><span class="nx">jaeger</span><span class="p">]</span>
    <span class="nx">samplingServerURL</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">samplingType</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">samplingParam</span> <span class="p">=</span> <span class="mf">42.0</span>
    <span class="nx">localAgentHostPort</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">gen128Bit</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">propagation</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">traceContextHeaderName</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="p">[</span><span class="nx">tracing</span><span class="p">.</span><span class="nx">jaeger</span><span class="p">.</span><span class="nx">collector</span><span class="p">]</span>
      <span class="nx">endpoint</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
      <span class="nx">user</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
      <span class="nx">password</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
  <span class="p">[</span><span class="nx">tracing</span><span class="p">.</span><span class="nx">zipkin</span><span class="p">]</span>
    <span class="nx">httpEndpoint</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">sameSpan</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">id128Bit</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">sampleRate</span> <span class="p">=</span> <span class="mf">42.0</span>
  <span class="p">[</span><span class="nx">tracing</span><span class="p">.</span><span class="nx">datadog</span><span class="p">]</span>
    <span class="nx">localAgentHostPort</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">globalTag</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">debug</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">prioritySampling</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">traceIDHeaderName</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">parentIDHeaderName</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">samplingPriorityHeaderName</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">bagagePrefixHeaderName</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
  <span class="p">[</span><span class="nx">tracing</span><span class="p">.</span><span class="nx">instana</span><span class="p">]</span>
    <span class="nx">localAgentHost</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">localAgentPort</span> <span class="p">=</span> <span class="mi">42</span>
    <span class="nx">logLevel</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
  <span class="p">[</span><span class="nx">tracing</span><span class="p">.</span><span class="nx">haystack</span><span class="p">]</span>
    <span class="nx">localAgentHost</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">localAgentPort</span> <span class="p">=</span> <span class="mi">42</span>
    <span class="nx">globalTag</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">traceIDHeaderName</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">parentIDHeaderName</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">spanIDHeaderName</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
    <span class="nx">baggagePrefixHeaderName</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="api">api</h3>

<p>暴露API，在生产环境不建议开启。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">api</span><span class="p">]</span>
  <span class="c">#如果为true，则会使用名称为traefik的entryPoint，如果该entryPoint不存在，则会自动创建一个名称为traefik端口为8080的entryPoint</span>
  <span class="nx">insecure</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="c">#开启dashboard，默认为true http://&lt;Traefik IP&gt;:8080/dashboard/</span>
  <span class="nx">dashboard</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="c">#开启Endpoints调试，默认为false  http://&lt;Traefik IP&gt;:8080/debug/</span>
  <span class="nx">debug</span> <span class="p">=</span> <span class="kc">true</span></code></pre></td></tr></table>
</div>
</div>
<p>如果开启了API，则一个名称为api@internal的特别服务将会被创建，并且可在route中被引用。</p>

<p>例如：在Traefik上通过docker定义动态配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># Dynamic Configuration</span><span class="w">
</span><span class="w"></span>labels<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span><span class="s2">&#34;traefik.http.routers.api.rule=Host(`traefik.domain.com`)&#34;</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span><span class="s2">&#34;traefik.http.routers.api.service=api@internal&#34;</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span><span class="s2">&#34;traefik.http.routers.api.middlewares=auth&#34;</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span><span class="s2">&#34;traefik.http.middlewares.auth.basicauth.users=test:$$apr1$$H6uskkkW$$IgXLP6ewTrSuBkTrqE8wj&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>注意：</p>

<p>路由规则必须指定<strong>/api</strong>的请求：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Matches http://traefik.domain.com, http://traefik.domain.com/api</span>
<span class="c1"># or http://traefik.domain.com/hello</span>
<span class="nv">rule</span> <span class="o">=</span> <span class="s2">&#34;Host(`traefik.domain.com`)&#34;</span>

<span class="c1"># Matches http://api.traefik.domain.com/api or http://domain.com/api</span>
<span class="c1"># but does not match http://api.traefik.domain.com/hello</span>
<span class="nv">rule</span> <span class="o">=</span> <span class="s2">&#34;PathPrefix(`/api`)&#34;</span>

<span class="c1"># Matches http://traefik.domain.com/api or http://traefik.domain.com/dashboard</span>
<span class="c1"># but does not match http://traefik.domain.com/hello</span>
<span class="nv">rule</span> <span class="o">=</span> <span class="s2">&#34;Host(`traefik.domain.com`) &amp;&amp; (PathPrefix(`/api`) || PathPrefix(`/dashboard`))&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>所有Endpoints如下：</p>

<table>
<thead>
<tr>
<th align="left">Path</th>
<th align="left">Description</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left"><code>/api/http/routers</code></td>
<td align="left">Lists all the HTTP routers information.</td>
</tr>

<tr>
<td align="left"><code>/api/http/routers/{name}</code></td>
<td align="left">Returns the information of the HTTP router specified by <code>name</code>.</td>
</tr>

<tr>
<td align="left"><code>/api/http/services</code></td>
<td align="left">Lists all the HTTP services information.</td>
</tr>

<tr>
<td align="left"><code>/api/http/services/{name}</code></td>
<td align="left">Returns the information of the HTTP service specified by <code>name</code>.</td>
</tr>

<tr>
<td align="left"><code>/api/http/middlewares</code></td>
<td align="left">Lists all the HTTP middlewares information.</td>
</tr>

<tr>
<td align="left"><code>/api/http/middlewares/{name}</code></td>
<td align="left">Returns the information of the HTTP middleware specified by <code>name</code>.</td>
</tr>

<tr>
<td align="left"><code>/api/tcp/routers</code></td>
<td align="left">Lists all the TCP routers information.</td>
</tr>

<tr>
<td align="left"><code>/api/tcp/routers/{name}</code></td>
<td align="left">Returns the information of the TCP router specified by <code>name</code>.</td>
</tr>

<tr>
<td align="left"><code>/api/tcp/services</code></td>
<td align="left">Lists all the TCP services information.</td>
</tr>

<tr>
<td align="left"><code>/api/tcp/services/{name}</code></td>
<td align="left">Returns the information of the TCP service specified by <code>name</code>.</td>
</tr>

<tr>
<td align="left"><code>/api/entrypoints</code></td>
<td align="left">Lists all the entry points information.</td>
</tr>

<tr>
<td align="left"><code>/api/entrypoints/{name}</code></td>
<td align="left">Returns the information of the entry point specified by <code>name</code>.</td>
</tr>

<tr>
<td align="left"><code>/api/overview</code></td>
<td align="left">Returns statistic information about http and tcp as well as enabled features and providers.</td>
</tr>

<tr>
<td align="left"><code>/api/version</code></td>
<td align="left">Returns information about Traefik version.</td>
</tr>

<tr>
<td align="left"><code>/debug/vars</code></td>
<td align="left">See the <a href="https://golang.org/pkg/expvar/">expvar</a> Go documentation.</td>
</tr>

<tr>
<td align="left"><code>/debug/pprof/</code></td>
<td align="left">See the <a href="https://golang.org/pkg/net/http/pprof/#Index">pprof Index</a> Go documentation.</td>
</tr>

<tr>
<td align="left"><code>/debug/pprof/cmdline</code></td>
<td align="left">See the <a href="https://golang.org/pkg/net/http/pprof/#Cmdline">pprof Cmdline</a> Go documentation.</td>
</tr>

<tr>
<td align="left"><code>/debug/pprof/profile</code></td>
<td align="left">See the <a href="https://golang.org/pkg/net/http/pprof/#Profile">pprof Profile</a> Go documentation.</td>
</tr>

<tr>
<td align="left"><code>/debug/pprof/symbol</code></td>
<td align="left">See the <a href="https://golang.org/pkg/net/http/pprof/#Symbol">pprof Symbol</a> Go documentation.</td>
</tr>

<tr>
<td align="left"><code>/debug/pprof/trace</code></td>
<td align="left">See the <a href="https://golang.org/pkg/net/http/pprof/#Trace">pprof Trace</a> Go documentation.</td>
</tr>
</tbody>
</table>

<h3 id="ping">ping</h3>

<p>开启健康检查，/ping，对应entryPoint名称默认为traefik</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">ping</span><span class="p">]</span>
  <span class="nx">entryPoint</span> <span class="p">=</span> <span class="s2">&#34;traefik&#34;</span> <span class="c">#默认为traefik</span></code></pre></td></tr></table>
</div>
</div>
<p>可以自定义一个<code>entryPoint</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">entryPoints</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">ping</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:8082&#34;</span>

<span class="p">[</span><span class="nx">ping</span><span class="p">]</span>
  <span class="nx">entryPoint</span> <span class="p">=</span> <span class="s2">&#34;ping&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="providers">providers</h3>

<p>支持的providers：</p>

<table>
<thead>
<tr>
<th align="left">Provider</th>
<th align="left">Type</th>
<th align="left">Configuration Type</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left"><a href="https://docs.traefik.io/v2.0/providers/docker/">Docker</a></td>
<td align="left">Orchestrator</td>
<td align="left">Label</td>
</tr>

<tr>
<td align="left"><a href="https://docs.traefik.io/v2.0/providers/kubernetes-crd/">Kubernetes</a></td>
<td align="left">Orchestrator</td>
<td align="left">Custom Resource</td>
</tr>

<tr>
<td align="left"><a href="https://docs.traefik.io/v2.0/providers/marathon/">Marathon</a></td>
<td align="left">Orchestrator</td>
<td align="left">Label</td>
</tr>

<tr>
<td align="left"><a href="https://docs.traefik.io/v2.0/providers/rancher/">Rancher</a></td>
<td align="left">Orchestrator</td>
<td align="left">Label</td>
</tr>

<tr>
<td align="left"><a href="https://docs.traefik.io/v2.0/providers/file/">File</a></td>
<td align="left">Manual</td>
<td align="left">TOML/YAML format</td>
</tr>
</tbody>
</table>

<p>配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">providers</span><span class="p">]</span>
  <span class="c">#Configuration加载频率</span>
  <span class="nx">providers</span><span class="p">.</span><span class="nx">providersThrottleDuration</span> <span class="p">=</span> <span class="mi">10</span><span class="nx">s</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="docker">Docker</h4>

<p><img src="https://docs.traefik.io/assets/img/providers/docker.png" alt="Docker" /></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">providers</span><span class="p">.</span><span class="nx">docker</span><span class="p">]</span>
  <span class="c"># Docker服务后端，默认为unix:///var/run/docker.sock，也可以设置为tcp://10.10.10.10:2375</span>
  <span class="nx">endpoint</span> <span class="p">=</span> <span class="s2">&#34;unix:///var/run/docker.sock&#34;</span>

  <span class="c"># Default host rule.</span>
  <span class="c">#</span>
  <span class="c"># Optional</span>
  <span class="c"># Default: &#34;Host(`{{ normalize .Name }}`)&#34;</span>
  <span class="c"># 如果没有配置 Rule，将默认通过 &lt;container-name&gt;.docker.localhost 来发现路由</span>
  <span class="c"># defaultRule = &#34;Host(`{{ normalize .Name }}.docker.localhost`)&#34;</span>

  <span class="c"># 对容器默认进行暴露（默认开启）</span>
	<span class="c">#   如果关闭选项，则容器不包含 `traefik.enable=true` 标签，就不会被暴露</span>
  <span class="c"># exposedByDefault = false</span>
  
  <span class="c">#开启swarmMode模式，默认为 false</span>
  <span class="c">#swarmMode = false</span>
  
  <span class="c">#默认为empty</span>
  <span class="c">#network = &#34;test&#34;</span>
  
  <span class="c">#设置Docker TLS</span>
  <span class="p">[</span><span class="nx">providers</span><span class="p">.</span><span class="nx">docker</span><span class="p">.</span><span class="nx">tls</span><span class="p">]</span>
    <span class="nx">ca</span> <span class="p">=</span> <span class="s2">&#34;path/to/ca.crt&#34;</span>
    <span class="nx">caOptional</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">cert</span> <span class="p">=</span> <span class="s2">&#34;path/to/foo.cert&#34;</span>
  	<span class="nx">key</span> <span class="p">=</span> <span class="s2">&#34;path/to/foo.key&#34;</span>
  	<span class="nx">insecureSkipVerify</span> <span class="p">=</span> <span class="kc">true</span></code></pre></td></tr></table>
</div>
</div>
<p>在docker-compose的配置中可以这样使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="nx">version</span><span class="err">:</span> <span class="s2">&#34;3&#34;</span>
<span class="nx">services</span><span class="err">:</span>
  <span class="nx">my</span><span class="err">-</span><span class="nx">container</span><span class="err">:</span>
    <span class="c"># ...</span>
    <span class="nx">labels</span><span class="err">:</span>
      <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">my</span><span class="err">-</span><span class="nx">container</span><span class="p">.</span><span class="nx">rule</span><span class="p">=</span><span class="nx">Host</span><span class="err">(`</span><span class="nx">mydomain</span><span class="p">.</span><span class="nx">com</span><span class="err">`)</span></code></pre></td></tr></table>
</div>
</div>
<p><img src="https://docs.traefik.io/assets/img/routers.png" alt="routers" /></p>

<p>支持的http routers标签：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">- <span class="s2">&#34;traefik.http.routers.myrouter.rule=Host(`mydomain.com`)&#34;</span>
- <span class="s2">&#34;traefik.http.routers.myrouter.entrypoints=ep1,ep2&#34;</span>
- <span class="s2">&#34;traefik.http.routers.myrouter.middlewares=auth,prefix,cb&#34;</span>
- <span class="s2">&#34;traefik.http.routers.myrouter.service=myservice&#34;</span>
- <span class="s2">&#34;traefik.http.routers.myrouter.tls=true&#34;</span>
- <span class="s2">&#34;traefik.http.routers.myrouter.tls.certresolver=myresolver&#34;</span>
- <span class="s2">&#34;traefik.http.routers.myrouter.tls.domains[0].main=foobar.com&#34;</span>
- <span class="s2">&#34;traefik.http.routers.myrouter.tls.domains[0].sans=test.foobar.com,dev.foobar.com&#34;</span>
- <span class="s2">&#34;traefik.http.routers.myrouter.tls.options=foobar&#34;</span>
- <span class="s2">&#34;traefik.http.routers.myrouter.priority=42&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p><img src="https://docs.traefik.io/assets/img/services.png" alt="services" /></p>

<p>支持的Services标签：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.server.port=8080&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.server.scheme=http&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.passhostheader=true&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.healthcheck.headers.X-Foo=foobar&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.healthcheck.hostname=foobar.com&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.healthcheck.interval=10&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.healthcheck.path=/foo&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.healthcheck.port=42&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.healthcheck.scheme=http&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.healthcheck.timeout=10&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.sticky=true&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.sticky.cookie.httponly=true&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.sticky.cookie.name=foobar&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.sticky.cookie.secure=true&#34;</span>
- <span class="s2">&#34;traefik.http.services.myservice.loadbalancer.responseforwarding.flushinterval=10&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p><img src="https://docs.traefik.io/assets/img/middleware/overview.png" alt="Overview" /></p>

<p>支持的Middleware标签：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">- traefik.http.middlewares.my-redirect.redirectscheme.scheme<span class="o">=</span>https</code></pre></td></tr></table>
</div>
</div>
<p>支持的tcp routers标签：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">- <span class="s2">&#34;traefik.tcp.routers.mytcprouter.rule=HostSNI(`mydomain.com`)&#34;</span>
- <span class="s2">&#34;traefik.tcp.routers.mytcprouter.entrypoints=ep1,ep2&#34;</span>
- <span class="s2">&#34;traefik.tcp.routers.mytcprouter.middlewares=auth,prefix,cb&#34;</span>
- <span class="s2">&#34;traefik.tcp.routers.mytcprouter.service=myservice&#34;</span>
- <span class="s2">&#34;traefik.tcp.routers.mytcprouter.tls=true&#34;</span>
- <span class="s2">&#34;traefik.tcp.routers.mytcprouter.tls.certresolver=myresolver&#34;</span>
- <span class="s2">&#34;traefik.tcp.routers.mytcprouter.tls.domains[0].main=foobar.com&#34;</span>
- <span class="s2">&#34;traefik.tcp.routers.mytcprouter.tls.domains[0].sans=test.foobar.com,dev.foobar.com&#34;</span>
- <span class="s2">&#34;traefik.tcp.routers.mytcprouter.tls.options=foobar&#34;</span>
- <span class="s2">&#34;traefik.tcp.routers.mytcprouter.tls.passthrough=true&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>支持的TCP Services标签</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">- <span class="s2">&#34;traefik.tcp.services.mytcpservice.loadbalancer.server.port=423&#34;</span>
- <span class="s2">&#34;traefik.tcp.services.mytcpservice.loadbalancer.terminationdelay=100&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="file">File</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml">  <span class="p">[</span><span class="nx">providers</span><span class="p">.</span><span class="nx">file</span><span class="p">]</span>
    <span class="nx">directory</span> <span class="p">=</span> <span class="s2">&#34;/etc/traefik/conf&#34;</span>
    <span class="nx">filename</span> <span class="p">=</span> <span class="s2">&#34;dynamic_conf.toml&#34;</span>
    <span class="nx">watch</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">debugLogGeneratedTemplate</span> <span class="p">=</span> <span class="kc">true</span></code></pre></td></tr></table>
</div>
</div>
<p>动态配置文件可以设置如下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">http</span><span class="p">]</span>
    <span class="c"># Add the router</span>
    <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">routerfoo</span><span class="p">]</span>
    	  <span class="nx">rule</span> <span class="p">=</span> <span class="s2">&#34;Host(`snitest.com`) &amp;&amp; Path(`/foo`)&#34;</span>
        <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">routerfoo</span><span class="p">.</span><span class="nx">tls</span><span class="p">]</span>
          <span class="nx">certResolver</span> <span class="p">=</span> <span class="s2">&#34;foo&#34;</span>
          
      <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">routerbar</span><span class="p">]</span>
        <span class="nx">rule</span> <span class="p">=</span> <span class="s2">&#34;Host(`snitest.com`) &amp;&amp; Path(`/bar`)&#34;</span>
        <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">routerbar</span><span class="p">.</span><span class="nx">tls</span><span class="p">]</span>
          <span class="nx">certResolver</span> <span class="p">=</span> <span class="s2">&#34;bar&#34;</span>
          <span class="p">[[</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">routerbar</span><span class="p">.</span><span class="nx">tls</span><span class="p">.</span><span class="nx">domains</span><span class="p">]]</span>
            <span class="nx">main</span> <span class="p">=</span> <span class="s2">&#34;snitest.com&#34;</span>
            <span class="nx">sans</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;*.snitest.com&#34;</span><span class="p">]</span>

    <span class="c"># Add the middleware</span>
    <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">]</span>    
      <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">.</span><span class="nx">my</span><span class="err">-</span><span class="nx">basic</span><span class="err">-</span><span class="nx">auth</span><span class="p">.</span><span class="nx">basicAuth</span><span class="p">]</span>
        <span class="nx">users</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;test:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/&#34;</span><span class="p">,</span> 
                  <span class="s2">&#34;test2:$apr1$d9hr9HBB$4HxwgUir3HP4EsggP/QNo0&#34;</span><span class="p">]</span>
        <span class="nx">usersFile</span> <span class="p">=</span> <span class="s2">&#34;/etc/traefik/.htpasswd&#34;</span>

    <span class="c"># Add the service</span>
    <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">services</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">service</span><span class="err">-</span><span class="nx">foo</span><span class="p">]</span>
        <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">service</span><span class="err">-</span><span class="nx">foo</span><span class="p">.</span><span class="nx">loadBalancer</span><span class="p">]</span>
          <span class="p">[[</span><span class="nx">http</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">service</span><span class="err">-</span><span class="nx">foo</span><span class="p">.</span><span class="nx">loadBalancer</span><span class="p">.</span><span class="nx">servers</span><span class="p">]]</span>
            <span class="nx">url</span> <span class="p">=</span> <span class="s2">&#34;http://foo/&#34;</span>
          <span class="p">[[</span><span class="nx">http</span><span class="p">.</span><span class="nx">services</span><span class="p">.</span><span class="nx">service</span><span class="err">-</span><span class="nx">foo</span><span class="p">.</span><span class="nx">loadBalancer</span><span class="p">.</span><span class="nx">servers</span><span class="p">]]</span>
            <span class="nx">url</span> <span class="p">=</span> <span class="s2">&#34;http://bar/&#34;</span>
            
<span class="p">[</span><span class="nx">tls</span><span class="p">]</span>
  <span class="p">[[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">certificates</span><span class="p">]]</span>
    <span class="nx">certFile</span> <span class="p">=</span> <span class="s2">&#34;path/to/cert.crt&#34;</span>
    <span class="nx">keyFile</span> <span class="p">=</span> <span class="s2">&#34;path/to/cert.key&#34;</span>
    <span class="nx">stores</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;foobar&#34;</span><span class="p">,</span> <span class="s2">&#34;foobar&#34;</span><span class="p">]</span>

  <span class="p">[[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">certificates</span><span class="p">]]</span>
    <span class="nx">certFile</span> <span class="p">=</span> <span class="s2">&#34;path/to/cert.crt&#34;</span>
    <span class="nx">keyFile</span> <span class="p">=</span> <span class="s2">&#34;path/to/cert.key&#34;</span>
    <span class="nx">stores</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;foobar&#34;</span><span class="p">,</span> <span class="s2">&#34;foobar&#34;</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">options</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">Options0</span><span class="p">]</span>
      <span class="nx">minVersion</span> <span class="p">=</span> <span class="s2">&#34;VersionTLS12&#34;</span>
      <span class="nx">cipherSuites</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256&#34;</span><span class="p">]</span>
      <span class="nx">sniStrict</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">Options0</span><span class="p">.</span><span class="nx">clientAuth</span><span class="p">]</span>
        <span class="nx">caFiles</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;tests/clientca1.crt&#34;</span><span class="p">,</span> <span class="s2">&#34;tests/clientca2.crt&#34;</span><span class="p">]</span>
        <span class="nx">clientAuthType</span> <span class="p">=</span> <span class="s2">&#34;RequireAndVerifyClientCert&#34;</span>
    <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">Options1</span><span class="p">]</span>
      <span class="nx">minVersion</span> <span class="p">=</span> <span class="s2">&#34;VersionTLS13&#34;</span>
      <span class="nx">cipherSuites</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256&#34;</span><span class="p">]</span>
      <span class="nx">sniStrict</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">Options1</span><span class="p">.</span><span class="nx">clientAuth</span><span class="p">]</span>
        <span class="nx">ccaFiles</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;tests/clientca1.crt&#34;</span><span class="p">,</span> <span class="s2">&#34;tests/clientca2.crt&#34;</span><span class="p">]</span>
        <span class="nx">clientAuthType</span> <span class="p">=</span> <span class="s2">&#34;RequireAndVerifyClientCert&#34;</span>
  <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">stores</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">stores</span><span class="p">.</span><span class="nx">Store0</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">stores</span><span class="p">.</span><span class="nx">Store0</span><span class="p">.</span><span class="nx">defaultCertificate</span><span class="p">]</span>
        <span class="nx">certFile</span> <span class="p">=</span> <span class="s2">&#34;path/to/cert.crt&#34;</span>
        <span class="nx">keyFile</span> <span class="p">=</span> <span class="s2">&#34;path/to/cert.key&#34;</span>
    <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">stores</span><span class="p">.</span><span class="nx">Store1</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">stores</span><span class="p">.</span><span class="nx">Store1</span><span class="p">.</span><span class="nx">defaultCertificate</span><span class="p">]</span>
        <span class="nx">certFile</span> <span class="p">=</span> <span class="s2">&#34;path/to/cert.crt&#34;</span>
        <span class="nx">keyFile</span> <span class="p">=</span> <span class="s2">&#34;path/to/cert.key&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>clientAuth.clientAuthType：</p>

<ul>
<li>NoClientCert</li>
<li>RequestClientCert</li>
<li>RequireAnyClientCert</li>
<li>VerifyClientCertIfGiven</li>
<li>RequireAndVerifyClientCert</li>
</ul>

<h3 id="hostresolver">hostResolver</h3>

<h3 id="certificatesresolvers">certificatesResolvers</h3>

<p>设置证书：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">CertificateResolver0</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">CertificateResolver0</span><span class="p">.</span><span class="nx">acme</span><span class="p">]</span>
      <span class="nx">email</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
      <span class="nx">caServer</span> <span class="p">=</span> <span class="s2">&#34;https://acme-staging-v02.api.letsencrypt.org/directory&#34;</span>
      <span class="nx">storage</span> <span class="p">=</span> <span class="s2">&#34;acme.json&#34;</span>
      <span class="nx">keyType</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
      <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">CertificateResolver0</span><span class="p">.</span><span class="nx">acme</span><span class="p">.</span><span class="nx">dnsChallenge</span><span class="p">]</span>
        <span class="nx">provider</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
        <span class="nx">delayBeforeCheck</span> <span class="p">=</span> <span class="mi">42</span>
        <span class="nx">resolvers</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;foobar&#34;</span><span class="p">,</span> <span class="s2">&#34;foobar&#34;</span><span class="p">]</span>
        <span class="nx">disablePropagationCheck</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">CertificateResolver0</span><span class="p">.</span><span class="nx">acme</span><span class="p">.</span><span class="nx">httpChallenge</span><span class="p">]</span>
        <span class="nx">entryPoint</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
      <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">CertificateResolver0</span><span class="p">.</span><span class="nx">acme</span><span class="p">.</span><span class="nx">tlsChallenge</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">CertificateResolver1</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">CertificateResolver1</span><span class="p">.</span><span class="nx">acme</span><span class="p">]</span>
      <span class="nx">email</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
      <span class="nx">caServer</span> <span class="p">=</span> <span class="s2">&#34;https://acme-staging-v02.api.letsencrypt.org/directory&#34;</span>
      <span class="nx">storage</span> <span class="p">=</span> <span class="s2">&#34;acme.json&#34;</span>
      <span class="nx">keyType</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
      <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">CertificateResolver1</span><span class="p">.</span><span class="nx">acme</span><span class="p">.</span><span class="nx">dnsChallenge</span><span class="p">]</span>
        <span class="nx">provider</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
        <span class="nx">delayBeforeCheck</span> <span class="p">=</span> <span class="mi">42</span>
        <span class="nx">resolvers</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;foobar&#34;</span><span class="p">,</span> <span class="s2">&#34;foobar&#34;</span><span class="p">]</span>
        <span class="nx">disablePropagationCheck</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">CertificateResolver1</span><span class="p">.</span><span class="nx">acme</span><span class="p">.</span><span class="nx">httpChallenge</span><span class="p">]</span>
        <span class="nx">entryPoint</span> <span class="p">=</span> <span class="s2">&#34;foobar&#34;</span>
      <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">CertificateResolver1</span><span class="p">.</span><span class="nx">acme</span><span class="p">.</span><span class="nx">tlsChallenge</span><span class="p">]</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="配置示例">配置示例</h4>

<p>1、启用acme</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">entryPoints</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">http</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:80&#34;</span>

  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">https</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:443&#34;</span>

<span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">sample</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">sample</span><span class="p">.</span><span class="nx">acme</span><span class="p">]</span>
      <span class="nx">email</span> <span class="p">=</span> <span class="s2">&#34;your-email@your-domain.org&#34;</span>
      <span class="nx">storage</span> <span class="p">=</span> <span class="s2">&#34;acme.json&#34;</span>
      <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">sample</span><span class="p">.</span><span class="nx">acme</span><span class="p">.</span><span class="nx">dnsChallenge</span><span class="p">]</span>
        <span class="nx">provider</span> <span class="p">=</span> <span class="s2">&#34;dnspod&#34;</span>
        <span class="nx">delayBeforeCheck</span> <span class="p">=</span> <span class="mi">42</span>
        <span class="nx">resolvers</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;sample&#34;</span><span class="p">]</span>
        <span class="nx">disablePropagationCheck</span> <span class="p">=</span> <span class="kc">true</span></code></pre></td></tr></table>
</div>
</div>
<p>2、docker中设置路由规则标签</p>

<p>单域名：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="c">## Dynamic configuration</span>
<span class="nx">labels</span><span class="err">:</span>
  <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">blog</span><span class="p">.</span><span class="nx">rule</span><span class="p">=</span><span class="nx">Host</span><span class="err">(`</span><span class="nx">company</span><span class="p">.</span><span class="nx">com</span><span class="err">`)</span> <span class="err">&amp;&amp;</span> <span class="nx">Path</span><span class="err">(`/</span><span class="nx">blog</span><span class="err">`)</span>
  <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">blog</span><span class="p">.</span><span class="nx">tls</span><span class="p">=</span><span class="kc">true</span>
  <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">blog</span><span class="p">.</span><span class="nx">tls</span><span class="p">.</span><span class="nx">certresolver</span><span class="p">=</span><span class="nx">sample</span></code></pre></td></tr></table>
</div>
</div>
<p>多域名：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="c">## Dynamic configuration</span>
<span class="nx">labels</span><span class="err">:</span>
  <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">blog</span><span class="p">.</span><span class="nx">rule</span><span class="p">=</span><span class="err">(</span><span class="nx">Host</span><span class="err">(`</span><span class="nx">company</span><span class="p">.</span><span class="nx">com</span><span class="err">`)</span> <span class="err">&amp;&amp;</span> <span class="nx">Path</span><span class="err">(`/</span><span class="nx">blog</span><span class="err">`))</span> <span class="err">||</span> <span class="nx">Host</span><span class="err">(`</span><span class="nx">blog</span><span class="p">.</span><span class="nx">company</span><span class="p">.</span><span class="nx">org</span><span class="err">`)</span>
  <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">blog</span><span class="p">.</span><span class="nx">tls</span><span class="p">=</span><span class="kc">true</span>
  <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">blog</span><span class="p">.</span><span class="nx">tls</span><span class="p">.</span><span class="nx">certresolver</span><span class="p">=</span><span class="nx">sample</span></code></pre></td></tr></table>
</div>
</div>
<p>或者：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="c">## Dynamic configuration</span>
<span class="nx">labels</span><span class="err">:</span>
  <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">blog</span><span class="p">.</span><span class="nx">rule</span><span class="p">=</span><span class="nx">Host</span><span class="err">(`</span><span class="nx">company</span><span class="p">.</span><span class="nx">com</span><span class="err">`)</span> <span class="err">&amp;&amp;</span> <span class="nx">Path</span><span class="err">(`/</span><span class="nx">blog</span><span class="err">`)</span>
  <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">blog</span><span class="p">.</span><span class="nx">tls</span><span class="p">=</span><span class="kc">true</span>
  <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">blog</span><span class="p">.</span><span class="nx">tls</span><span class="p">.</span><span class="nx">certresolver</span><span class="p">=</span><span class="nx">sample</span>
  <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">blog</span><span class="p">.</span><span class="nx">tls</span><span class="p">.</span><span class="nx">domains</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">main</span><span class="p">=</span><span class="nx">company</span><span class="p">.</span><span class="nx">org</span>
  <span class="err">-</span> <span class="nx">traefik</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">blog</span><span class="p">.</span><span class="nx">tls</span><span class="p">.</span><span class="nx">domains</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">sans</span><span class="p">=</span><span class="err">*</span><span class="p">.</span><span class="nx">company</span><span class="p">.</span><span class="nx">org</span></code></pre></td></tr></table>
</div>
</div>
<p>3、也可以在动态配置中设置路由规则</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="c">## Dynamic configuration</span>
<span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">routerfoo</span><span class="p">]</span>
    <span class="nx">rule</span> <span class="p">=</span> <span class="s2">&#34;Host(`company.com`) &amp;&amp; Path(`/blog`)&#34;</span>
    <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">routerfoo</span><span class="p">.</span><span class="nx">tls</span><span class="p">]</span>
      <span class="nx">certResolver</span> <span class="p">=</span> <span class="s2">&#34;sample&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="acme-challenges">ACME Challenges</h4>

<p>ACME Challenges有以下几种类型：</p>

<ul>
<li><code>tlsChallenge</code></li>
<li><code>httpChallenge</code></li>
<li><code>dnsChallenge</code>：支持泛域名，支持的<code>providers</code>见 <a href="https://docs.traefik.io/v2.0/https/acme/#providers">https://docs.traefik.io/v2.0/https/acme/#providers</a></li>
</ul>

<p><code>dnsChallenge</code>示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">sample</span><span class="p">.</span><span class="nx">acme</span><span class="p">]</span>
  <span class="c"># ...</span>
  <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">sample</span><span class="p">.</span><span class="nx">acme</span><span class="p">.</span><span class="nx">dnsChallenge</span><span class="p">]</span>
    <span class="nx">provider</span> <span class="p">=</span> <span class="s2">&#34;digitalocean&#34;</span>
    <span class="nx">delayBeforeCheck</span> <span class="p">=</span> <span class="mi">0</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="示例">示例</h1>

<h2 id="docker通过traefik-toml部署traefik">docker通过traefik.toml部署traefik</h2>

<p>编辑traefik.toml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="c">## Static configuration</span>
<span class="p">[</span><span class="nx">global</span><span class="p">]</span>
  <span class="nx">checkNewVersion</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">sendAnonymousUsage</span> <span class="p">=</span> <span class="kc">false</span>

<span class="p">[</span><span class="nx">entryPoints</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">http</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:80&#34;</span>
  
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">traefik</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:8080&#34;</span>  
    
<span class="p">[</span><span class="nx">log</span><span class="p">]</span>
  <span class="nx">level</span> <span class="p">=</span> <span class="s2">&#34;DEBUG&#34;</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/traefik.log&#34;</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span>

<span class="p">[</span><span class="nx">accessLog</span><span class="p">]</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/access.log&#34;</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span>

<span class="p">[</span><span class="nx">api</span><span class="p">]</span>
  <span class="nx">insecure</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">dashboard</span> <span class="p">=</span> <span class="kc">true</span>

<span class="p">[</span><span class="nx">ping</span><span class="p">]</span>
  
<span class="p">[</span><span class="nx">providers</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">providers</span><span class="p">.</span><span class="nx">docker</span><span class="p">]</span>
    <span class="nx">endpoint</span> <span class="p">=</span> <span class="s2">&#34;unix:///var/run/docker.sock&#34;</span>
    <span class="nx">defaultRule</span> <span class="p">=</span> <span class="s2">&#34;Host(`{{ normalize .Name }}.docker.localhost`)&#34;</span>
    <span class="c"># 如果设置为 false, 则没有 traefik.enable=true 标签的容器将从生成的路由配置中忽略</span>
    <span class="nx">exposedByDefault</span> <span class="p">=</span> <span class="kc">false</span></code></pre></td></tr></table>
</div>
</div>
<p>部署：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">version: <span class="s1">&#39;3&#39;</span>

services:
  traefik:
    image: traefik:latest
    ports:
      <span class="c1"># The HTTP port</span>
      - <span class="s2">&#34;80:80&#34;</span>
      <span class="c1"># The Web UI (enabled by --api.insecure=true)</span>
      - <span class="s2">&#34;8080:8080&#34;</span>
    networks:
      - traefik  
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik.toml:/etc/traefik/traefik.toml
      - ./logs:/data/logs
      
networks:
  traefik:
    external: <span class="nb">true</span>      </code></pre></td></tr></table>
</div>
</div>
<p>需要先创建网络:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker network create traefik</code></pre></td></tr></table>
</div>
</div>
<p>访问 <a href="http://192.168.56.11:8080/">http://192.168.56.11:8080/</a> ，会跳到 <a href="http://192.168.56.11:8080/dashboard/#/">http://192.168.56.11:8080/dashboard/#/</a> ，可以看到页面如下：</p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9b2s4hdwj30yc0u0n3a.jpg" alt="image-20191225214914318" /></p>

<p>查看HTTP路由：</p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9b39bmicj31qs0skwjb.jpg" alt="image-20191225214942483" /></p>

<p>可以看到有三个HTTP路由规则，名称为XXX@internal，表明这是内部的服务。</p>

<ul>
<li>PathPrefix(<code>/dashboard</code>) 和 PathPrefix(<code>/api</code>) 是在静态配置[api]定义的</li>
<li>PathPrefix(<code>/ping</code>) 是通过静态配置 [ping] 定义的</li>
<li>traefik这个Entrypoints上有三个访问规则：

<ul>
<li><a href="http://192.168.56.11:8080/api">http://192.168.56.11:8080/api</a> 访问traefik提供的api</li>
<li><a href="http://192.168.56.11:8080/">http://192.168.56.11:8080/</a> 跳转到dashboard页面</li>
<li><a href="http://192.168.56.11:8880/ping">http://192.168.56.11:8880/ping</a> 健康检查</li>
</ul></li>
</ul>

<p>访问 <a href="http://192.168.56.11:8080/api/version">http://192.168.56.11:8080/api/version</a></p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9b40lp5cj30qi0dcta2.jpg" alt="image-20191225215026688" /></p>

<p>访问ping接口：<a href="http://192.168.56.11:8080/ping">http://192.168.56.11:8080/ping</a></p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9b4ckrr6j30z00g4q3j.jpg" alt="image-20191225215046735" /></p>

<p>查看访问日志：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ tailf logs/access.log
<span class="m">192</span>.168.2.107 - - <span class="o">[</span><span class="m">24</span>/Dec/2019:11:41:20 +0000<span class="o">]</span> <span class="s2">&#34;GET /api/overview HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">341</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;-&#34;</span> <span class="m">6</span> <span class="s2">&#34;api@internal&#34;</span> - 0ms
<span class="m">192</span>.168.2.107 - - <span class="o">[</span><span class="m">24</span>/Dec/2019:11:41:21 +0000<span class="o">]</span> <span class="s2">&#34;GET /api/overview HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">341</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;-&#34;</span> <span class="m">7</span> <span class="s2">&#34;api@internal&#34;</span> - 0ms
<span class="m">192</span>.168.2.107 - - <span class="o">[</span><span class="m">24</span>/Dec/2019:11:41:21 +0000<span class="o">]</span> <span class="s2">&#34;GET /api/http/routers?search=&amp;status=&amp;per_page=10&amp;page=1 HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">651</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;-&#34;</span> <span class="m">8</span> <span class="s2">&#34;api@internal&#34;</span> - 0ms
<span class="m">192</span>.168.2.107 - - <span class="o">[</span><span class="m">24</span>/Dec/2019:11:41:35 +0000<span class="o">]</span> <span class="s2">&#34;GET /ping HTTP/1.1&#34;</span> <span class="m">200</span> <span class="m">2</span> <span class="s2">&#34;-&#34;</span> <span class="s2">&#34;-&#34;</span> <span class="m">9</span> <span class="s2">&#34;ping@internal&#34;</span> - 0ms</code></pre></td></tr></table>
</div>
</div>
<h2 id="开启prometheus-metrics">开启prometheus metrics</h2>

<p>修改traefik.yml：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="c">## Static configuration</span>
<span class="p">[</span><span class="nx">global</span><span class="p">]</span>
  <span class="nx">checkNewVersion</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">sendAnonymousUsage</span> <span class="p">=</span> <span class="kc">false</span>

<span class="p">[</span><span class="nx">entryPoints</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">http</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:80&#34;</span>
  
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">traefik</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:8080&#34;</span>  
    
<span class="p">[</span><span class="nx">log</span><span class="p">]</span>
  <span class="nx">level</span> <span class="p">=</span> <span class="s2">&#34;DEBUG&#34;</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/traefik.log&#34;</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span>

<span class="p">[</span><span class="nx">accessLog</span><span class="p">]</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/access.log&#34;</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span>

<span class="p">[</span><span class="nx">api</span><span class="p">]</span>
  <span class="nx">insecure</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">dashboard</span> <span class="p">=</span> <span class="kc">true</span>

<span class="p">[</span><span class="nx">ping</span><span class="p">]</span>
  
<span class="p">[</span><span class="nx">providers</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">providers</span><span class="p">.</span><span class="nx">docker</span><span class="p">]</span>
    <span class="nx">endpoint</span> <span class="p">=</span> <span class="s2">&#34;unix:///var/run/docker.sock&#34;</span>
    <span class="nx">defaultRule</span> <span class="p">=</span> <span class="s2">&#34;Host(`{{ normalize .Name }}.docker.localhost`)&#34;</span>
    <span class="c"># 如果设置为 false, 则没有 traefik.enable=true 标签的容器将从生成的路由配置中忽略</span>
    <span class="nx">exposedByDefault</span> <span class="p">=</span> <span class="kc">false</span>

<span class="p">[</span><span class="nx">metrics</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">prometheus</span><span class="p">]</span></code></pre></td></tr></table>
</div>
</div>
<p>访问 <a href="http://192.168.56.11:8080/dashboard/#/">http://192.168.56.11:8080/dashboard/#/</a></p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9bc3tywpj31cj0u0tcu.jpg" alt="image-20191225215811386" /></p>

<p>查看路由：</p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9bd4c52sj31cg0smdka.jpg" alt="image-20191225215910475" /></p>

<p>访问：<a href="http://192.168.56.11:8080/metrics">http://192.168.56.11:8080/metrics</a> ，可以看到</p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9bdbw77bj315k0n8n3u.jpg" alt="image-20191225215921748" /></p>

<h2 id="traefik开启tls">Traefik开启TLS</h2>

<p>traefik.tom如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="c">## Static configuration</span>
<span class="p">[</span><span class="nx">global</span><span class="p">]</span>
  <span class="nx">checkNewVersion</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">sendAnonymousUsage</span> <span class="p">=</span> <span class="kc">false</span>

<span class="p">[</span><span class="nx">entryPoints</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">http</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:80&#34;</span>

  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">https</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:443&#34;</span>
  
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">traefik</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:8080&#34;</span>  
    
<span class="p">[</span><span class="nx">log</span><span class="p">]</span>
  <span class="nx">level</span> <span class="p">=</span> <span class="s2">&#34;DEBUG&#34;</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/traefik.log&#34;</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span>

<span class="p">[</span><span class="nx">accessLog</span><span class="p">]</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/access.log&#34;</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span>

<span class="p">[</span><span class="nx">api</span><span class="p">]</span>
  <span class="nx">insecure</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">dashboard</span> <span class="p">=</span> <span class="kc">true</span>

<span class="p">[</span><span class="nx">ping</span><span class="p">]</span>
  
<span class="p">[</span><span class="nx">providers</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">providers</span><span class="p">.</span><span class="nx">file</span><span class="p">]</span>
    <span class="nx">filename</span> <span class="p">=</span> <span class="s2">&#34;/etc/traefik/dynamic-conf.toml&#34;</span>
    <span class="nx">watch</span> <span class="p">=</span> <span class="kc">true</span>
  
  <span class="p">[</span><span class="nx">providers</span><span class="p">.</span><span class="nx">docker</span><span class="p">]</span>
    <span class="nx">endpoint</span> <span class="p">=</span> <span class="s2">&#34;unix:///var/run/docker.sock&#34;</span>
    <span class="nx">defaultRule</span> <span class="p">=</span> <span class="s2">&#34;Host(`{{ normalize .Name }}.docker.localhost`)&#34;</span>
    <span class="c"># 如果设置为 false, 则没有 traefik.enable=true 标签的容器将从生成的路由配置中忽略</span>
    <span class="nx">exposedByDefault</span> <span class="p">=</span> <span class="kc">false</span>

<span class="p">[</span><span class="nx">metrics</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">prometheus</span><span class="p">]</span></code></pre></td></tr></table>
</div>
</div>
<p>主要做以下改动：</p>

<ul>
<li><p>添加端口为443的entryPoints</p></li>

<li><p>api.insecure改为false，所以不能通过8080端口访问/api和/dashboard，需要使用443端口通过域名访问，并且通过80端口访问，会跳转到443端口。/ping接口还是通过8080端口访问</p>

<ul>
<li><a href="https://traefik.javachen.xyz/api/version">https://traefik.javachen.xyz/api/version</a></li>
<li><a href="https://traefik.javachen.xyz/dashboard/#/">https://traefik.javachen.xyz/dashboard/#/</a></li>
<li><a href="http://192.168.56.11:8080/ping">http://192.168.56.11:8080/ping</a> 或者 <a href="http://traefik.javachen.xyz:8080/ping">http://traefik.javachen.xyz:8080/ping</a></li>
</ul></li>
</ul>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1ga8xvr8d06j31sg0ng793.jpg" alt="image-20191225141243710" /></p>

<ul>
<li>添加动态配置文件 dynamic_conf.toml，用于设置动态路由和TLS。</li>
</ul>

<p>动态配置dynamic-conf.toml 内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="c">## Dynamic configuration</span>
<span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">traefik</span><span class="err">-</span><span class="nx">https</span><span class="p">]</span>
  <span class="nx">rule</span> <span class="p">=</span> <span class="s2">&#34;Host(`traefik.javachen.xyz`)&#34;</span>
  <span class="nx">entryPoints</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;https&#34;</span><span class="p">]</span>
  <span class="nx">service</span> <span class="p">=</span> <span class="s2">&#34;api@internal&#34;</span>
  <span class="nx">middlewares</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;auth&#34;</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">routers</span><span class="p">.</span><span class="nx">traefik</span><span class="err">-</span><span class="nx">https</span><span class="p">.</span><span class="nx">tls</span><span class="p">]</span>

<span class="c"># 用户：test 密码：test</span>
<span class="p">[</span><span class="nx">http</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">basicAuth</span><span class="p">]</span>
  <span class="nx">users</span> <span class="p">=</span> <span class="p">[</span>
    <span class="s2">&#34;test:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/&#34;</span><span class="p">,</span>
  <span class="p">]</span>

<span class="p">[</span><span class="nx">tls</span><span class="p">]</span>
  <span class="p">[[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">certificates</span><span class="p">]]</span>
    <span class="nx">certFile</span> <span class="p">=</span> <span class="s2">&#34;/etc/ssl/javachen.xyz.cer&#34;</span>
    <span class="nx">keyFile</span> <span class="p">=</span> <span class="s2">&#34;/etc/ssl/javachen.xyz.key&#34;</span>
  <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">stores</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">stores</span><span class="p">.</span><span class="nx">default</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">stores</span><span class="p">.</span><span class="nx">default</span><span class="p">.</span><span class="nx">defaultCertificate</span><span class="p">]</span>
        <span class="nx">certFile</span> <span class="p">=</span> <span class="s2">&#34;/etc/ssl/javachen.xyz.cer&#34;</span>
        <span class="nx">keyFile</span> <span class="p">=</span> <span class="s2">&#34;/etc/ssl/javachen.xyz.key&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>需要准备证书：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#安装：自动创建 cronjob, 每天 0:00 点自动检测所有的证书</span>
curl  https://get.acme.sh <span class="p">|</span> sh
<span class="nb">source</span> ~/.bashrc

<span class="c1">#https://console.dnspod.cn/account/token</span>
<span class="nb">export</span> <span class="nv">DP_Id</span><span class="o">=</span><span class="s2">&#34;127880&#34;</span>
<span class="nb">export</span> <span class="nv">DP_Key</span><span class="o">=</span><span class="s2">&#34;6847f9a4cdba562f574fe55944f689e7&#34;</span>
acme.sh --issue --dns dns_dp -d javachen.xyz -d *.javachen.xyz

mkdir ssl
cp ~/.acme.sh/javachen.xyz/javachen.xyz.cer ssl/
cp ~/.acme.sh/javachen.xyz/javachen.xyz.key ssl/</code></pre></td></tr></table>
</div>
</div>
<p>修改docker-compose：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>traefik<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>traefik<span class="p">:</span>latest<span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># The HTTP port</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;80:80&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;443:443&#34;</span><span class="w">
</span><span class="w">      </span><span class="c"># The Web UI (enabled by --api.insecure=true)</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8080:8080&#34;</span><span class="w">
</span><span class="w">    </span>networks<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>traefik<span class="w">  
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/var/run/docker.sock<span class="p">:</span>/var/run/docker.sock<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./traefik.toml<span class="p">:</span>/etc/traefik/traefik.toml<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./dynamic-conf.toml<span class="p">:</span>/etc/traefik/dynamic-conf.toml<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./logs<span class="p">:</span>/data/logs<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./ssl<span class="p">:</span>/etc/ssl<span class="w">
</span><span class="w">      
</span><span class="w"></span>networks<span class="p">:</span><span class="w">
</span><span class="w">  </span>traefik<span class="p">:</span><span class="w">
</span><span class="w">    </span>external<span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">      </span></code></pre></td></tr></table>
</div>
</div>
<p>启动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up -d</code></pre></td></tr></table>
</div>
</div>
<p>查看http路由：</p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9bvxbwl8j31bo0u0q83.jpg" alt="image-20191225221716306" /></p>

<p>访问 <a href="http://traefik.javachen.xyz/">http://traefik.javachen.xyz/</a> 和 <a href="https://traefik.javachen.xyz/">https://traefik.javachen.xyz/</a></p>

<p>修改配置文件中api.insecure=false，再次查看http路由：</p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9by0pt48j31f40regpr.jpg" alt="image-20191225221916691" /></p>

<p>访问ping接口</p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9bymzuu0j316s0f2t9e.jpg" alt="image-20191225221953437" /></p>

<h2 id="给应用配置letsencrypt证书">给应用配置LetsEncrypt证书</h2>

<p><img src="http://wiki.xglabc.com/objst/wiki/pzseopefst0gq3r3o7c1u9xv2cpp09s9-traefik-logic.png" alt="traefik-logic.png" /></p>

<p>修改traefik.tom，启用acme的dnsChallenge：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="c">## Static configuration</span>
<span class="p">[</span><span class="nx">global</span><span class="p">]</span>
  <span class="nx">checkNewVersion</span> <span class="p">=</span> <span class="kc">true</span>
  <span class="nx">sendAnonymousUsage</span> <span class="p">=</span> <span class="kc">false</span>

<span class="p">[</span><span class="nx">entryPoints</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">http</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:80&#34;</span>

  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">https</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:443&#34;</span>
  
  <span class="p">[</span><span class="nx">entryPoints</span><span class="p">.</span><span class="nx">traefik</span><span class="p">]</span>
    <span class="nx">address</span> <span class="p">=</span> <span class="s2">&#34;:8080&#34;</span>  
    
<span class="p">[</span><span class="nx">log</span><span class="p">]</span>
  <span class="nx">level</span> <span class="p">=</span> <span class="s2">&#34;DEBUG&#34;</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/traefik.log&#34;</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span>

<span class="p">[</span><span class="nx">accessLog</span><span class="p">]</span>
  <span class="nx">filePath</span> <span class="p">=</span> <span class="s2">&#34;/data/logs/access.log&#34;</span>
  <span class="nx">format</span> <span class="p">=</span> <span class="s2">&#34;common&#34;</span>

<span class="p">[</span><span class="nx">api</span><span class="p">]</span>
  <span class="nx">insecure</span> <span class="p">=</span> <span class="kc">false</span>
  <span class="nx">dashboard</span> <span class="p">=</span> <span class="kc">true</span>

<span class="p">[</span><span class="nx">ping</span><span class="p">]</span>
  
<span class="p">[</span><span class="nx">providers</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">providers</span><span class="p">.</span><span class="nx">file</span><span class="p">]</span>
    <span class="nx">filename</span> <span class="p">=</span> <span class="s2">&#34;/etc/traefik/dynamic-conf.toml&#34;</span>
    <span class="nx">watch</span> <span class="p">=</span> <span class="kc">true</span>
  
  <span class="p">[</span><span class="nx">providers</span><span class="p">.</span><span class="nx">docker</span><span class="p">]</span>
    <span class="nx">endpoint</span> <span class="p">=</span> <span class="s2">&#34;unix:///var/run/docker.sock&#34;</span>
    <span class="nx">defaultRule</span> <span class="p">=</span> <span class="s2">&#34;Host(`{{ normalize .Name }}.docker.localhost`)&#34;</span>
    <span class="c"># 如果设置为 false, 则没有 traefik.enable=true 标签的容器将从生成的路由配置中忽略</span>
    <span class="nx">exposedByDefault</span> <span class="p">=</span> <span class="kc">false</span>

<span class="p">[</span><span class="nx">metrics</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">prometheus</span><span class="p">]</span>
  
<span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">]</span>
  <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">sample</span><span class="p">]</span>
    <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">sample</span><span class="p">.</span><span class="nx">acme</span><span class="p">]</span>
      <span class="nx">email</span> <span class="p">=</span> <span class="s2">&#34;junecloud@163.com&#34;</span>
      <span class="nx">storage</span> <span class="p">=</span> <span class="s2">&#34;/etc/traefik/acme.json&#34;</span>
      <span class="nx">caServer</span> <span class="p">=</span> <span class="s2">&#34;https://acme-staging-v02.api.letsencrypt.org/directory&#34;</span>
      <span class="p">[</span><span class="nx">certificatesResolvers</span><span class="p">.</span><span class="nx">sample</span><span class="p">.</span><span class="nx">acme</span><span class="p">.</span><span class="nx">dnsChallenge</span><span class="p">]</span>
        <span class="nx">provider</span> <span class="p">=</span> <span class="s2">&#34;dnspod&#34;</span>
        <span class="nx">delayBeforeCheck</span> <span class="p">=</span> <span class="mi">42</span>
        <span class="nx">resolvers</span> <span class="p">=</span> <span class="p">[</span><span class="s2">&#34;sample&#34;</span><span class="p">]</span>
        <span class="nx">disablePropagationCheck</span> <span class="p">=</span> <span class="kc">true</span></code></pre></td></tr></table>
</div>
</div>
<p>使用docker-compose安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">version: <span class="s1">&#39;3&#39;</span>

services:
  traefik:
    image: traefik:latest
    ports:
      <span class="c1"># The HTTP port</span>
      - <span class="s2">&#34;80:80&#34;</span>
      - <span class="s2">&#34;443:443&#34;</span>
      <span class="c1"># The Web UI (enabled by --api.insecure=true)</span>
      - <span class="s2">&#34;8080:8080&#34;</span>
    environment:
    	- <span class="nv">DNSPOD_API_KEY</span><span class="o">=</span><span class="s2">&#34;127880,6847f9a4cdba562f574fe55944f689e7&#34;</span>
    networks:
      - traefik  
    volumes:
      <span class="c1"># So that Traefik can listen to the Docker events</span>
      - /var/run/docker.sock:/var/run/docker.sock
      - ./traefik.toml:/etc/traefik/traefik.toml
      - ./dynamic-conf.toml:/etc/traefik/dynamic-conf.toml
      - ./acme.json:/etc/traefik/acme.json
      - ./logs:/data/logs
      - ./ssl:/etc/ssl
  whoami:
    image: containous/whoami
    labels:
      - traefik.enable<span class="o">=</span><span class="nb">true</span>
      - traefik.docker.network<span class="o">=</span>traefik
      - traefik.http.routers.whoami.rule<span class="o">=</span>Host<span class="o">(</span><span class="sb">`</span>whoami.javachen.xyz<span class="sb">`</span><span class="o">)</span>
      - traefik.http.routers.whoami.entrypoints<span class="o">=</span>http
      - traefik.http.routers.whoami-https.rule<span class="o">=</span>Host<span class="o">(</span><span class="sb">`</span>whoami.javachen.xyz<span class="sb">`</span><span class="o">)</span>
      - traefik.http.routers.whoami-https.entrypoints<span class="o">=</span>https
      - traefik.http.routers.whoami-https.tls<span class="o">=</span><span class="nb">true</span>
      - traefik.http.routers.whoami-https.tls.certresolver<span class="o">=</span>sample
      <span class="c1"># http 重定向到 https</span>
      - traefik.http.routers.whoami.middlewares<span class="o">=</span>whoami
      - traefik.http.middlewares.whoami.redirectscheme.scheme<span class="o">=</span>https
      - traefik.http.middlewares.whoami.redirectscheme.port<span class="o">=</span><span class="m">443</span>
    networks:
      - traefik  
      
networks:
  traefik:
    external: true</code></pre></td></tr></table>
</div>
</div>
<p>至此traefik的配置工作已经准备好了，可以启动traefik容器了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">touch acme.json

docker-compose up -d</pre></td></tr></table>
</div>
</div>
<p>进行测试：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ curl -H Host:whoami.javachen.xyz http://127.0.0.1
Found


$ curl -kH Host:whoami.javachen.xyz https://127.0.0.1
Hostname: 7c944d7cadef
IP: <span class="m">127</span>.0.0.1
IP: <span class="m">172</span>.22.0.3
RemoteAddr: <span class="m">172</span>.22.0.2:54580
GET / HTTP/1.1
Host: whoami.javachen.xyz
User-Agent: curl/7.29.0
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: <span class="m">172</span>.22.0.1
X-Forwarded-Host: whoami.javachen.xyz
X-Forwarded-Port: <span class="m">443</span>
X-Forwarded-Proto: https
X-Forwarded-Server: aad4e7f1395d
X-Real-Ip: <span class="m">172</span>.22.0.1</code></pre></td></tr></table>
</div>
</div>
<p>浏览器访问 <a href="http://whoami.javachen.xyz/">http://whoami.javachen.xyz/</a> 会跳转到 <a href="https://whoami.javachen.xyz/">https://whoami.javachen.xyz/</a></p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1ga9c5u46qxj316c0jm0x2.jpg" alt="image-20191225222647700" /></p>

<h2 id="测试mongo-tcp路由">测试Mongo TCP路由</h2>

<p>以 <a href="https://github.com/containous/slides/tree/master/demo/traefik-v2">https://github.com/containous/slides/tree/master/demo/traefik-v2</a> 为例子进行测试。</p>

<p>1、测试简单TCP路由</p>

<p>docker-compose.yml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>reverse-proxy<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>traefik<span class="p">:</span>latest<span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--api<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--api.insecure<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--providers.docker<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--entrypoints.mongo.address=<span class="p">:</span><span class="m">27017</span><span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;27017:27017&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8080:8080&#34;</span><span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/var/run/docker.sock<span class="p">:</span>/var/run/docker.sock<span class="w">
</span><span class="w">
</span><span class="w">  </span>mongo<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>mongo<span class="p">:</span><span class="m">4.0</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>mongo.local<span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo.rule=HostSNI(`*`)&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo.entrypoints=mongo&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>启动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up -d</code></pre></td></tr></table>
</div>
</div>
<p>设置/etc/hosts:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">127.0.0.1 mongo.local</pre></td></tr></table>
</div>
</div>
<p>使用mongo客户端连接：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mongo --host mongo.local --port <span class="m">27017</span>
&gt; show dbs
&gt; exit</code></pre></td></tr></table>
</div>
</div>
<p>清理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose down -v</code></pre></td></tr></table>
</div>
</div>
<p>其实，可以修改mongo暴露的端口为80：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>reverse-proxy<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>traefik<span class="p">:</span>latest<span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--api<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--api.insecure<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--providers.docker<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--entrypoints.http.address=<span class="p">:</span><span class="m">80</span><span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;80:80&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8080:8080&#34;</span><span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/var/run/docker.sock<span class="p">:</span>/var/run/docker.sock<span class="w">
</span><span class="w">
</span><span class="w">  </span>mongo<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>mongo<span class="p">:</span><span class="m">4.0</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>mongo.local<span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo.rule=HostSNI(`*`)&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo.entrypoints=http&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>使用mongo客户端连接：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mongo --host mongo.local --port <span class="m">80</span>
&gt; show dbs
&gt; exit</code></pre></td></tr></table>
</div>
</div>
<p>2、配置TLS</p>

<p>docker-compose.yml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>reverse-proxy<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>traefik<span class="p">:</span>latest<span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--api<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--api.insecure<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--providers.docker<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--providers.file.filename=/etc/ssl/traefik-tls.toml<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--entrypoints.mongo.address=<span class="p">:</span><span class="m">27017</span><span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8080:8080&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;27017:27017&#34;</span><span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/var/run/docker.sock<span class="p">:</span>/var/run/docker.sock<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>../ssl<span class="p">:</span>/etc/ssl<span class="w">
</span><span class="w">
</span><span class="w">  </span>mongo1<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>mongo<span class="p">:</span><span class="m">4.0</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>mongo1.local<span class="w">
</span><span class="w">    </span>restart<span class="p">:</span><span class="w"> </span>always<span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo1.rule=HostSNI(`*`)&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo1.tls=true&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo1.entrypoints=mongo&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>traefik-tls.toml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">certificates</span><span class="p">]]</span>
  <span class="nx">certFile</span> <span class="p">=</span> <span class="s2">&#34;/etc/ssl/cert.pem&#34;</span>
  <span class="nx">keyFile</span> <span class="p">=</span> <span class="s2">&#34;/etc/ssl/key.pem&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>生成证书：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">rm -rf *.pem
sh ../ssl/generate-certificates.sh mongo1.local ./</code></pre></td></tr></table>
</div>
</div>
<p><strong>generate-certificates.sh</strong>内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>#
<span class="c1"># From https://medium.com/@rajanmaharjan/secure-your-mongodb-connections-ssl-tls-92e2addb3c89</span>

<span class="nb">set</span> -eu -o pipefail

<span class="nv">DOMAINS</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">1</span><span class="si">}</span><span class="s2">&#34;</span>
<span class="nv">CERTS_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">2</span><span class="si">}</span><span class="s2">&#34;</span>
<span class="o">[</span> -d <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CERTS_DIR</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">]</span>
<span class="nv">CURRENT_DIR</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">cd</span> <span class="s2">&#34;</span><span class="k">$(</span>dirname <span class="s2">&#34;</span><span class="si">${</span><span class="nv">0</span><span class="si">}</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span> -P<span class="k">)</span><span class="s2">&#34;</span>

<span class="nv">GENERATION_DIRNAME</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">DOMAINS</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">|</span> cut -d, -f1<span class="k">)</span><span class="s2">&#34;</span>

rm -rf <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CERTS_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nv">GENERATION_DIRNAME</span><span class="p">:?</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CERTS_DIR</span><span class="si">}</span><span class="s2">/ssl&#34;</span>

<span class="nb">echo</span> <span class="s2">&#34;== Checking Requirements...&#34;</span>
<span class="nb">command</span> -v go &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="o">||</span> <span class="nb">echo</span> <span class="s2">&#34;Golang is required&#34;</span>
<span class="nb">command</span> -v minica &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="o">||</span> go get github.com/jsha/minica &gt;/dev/null

<span class="nb">echo</span> <span class="s2">&#34;== Generating Certificates for the following domains: </span><span class="si">${</span><span class="nv">DOMAINS</span><span class="si">}</span><span class="s2">...&#34;</span>
<span class="nb">cd</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CERTS_DIR</span><span class="si">}</span><span class="s2">&#34;</span>
minica --ca-cert <span class="s2">&#34;</span><span class="si">${</span><span class="nv">CURRENT_DIR</span><span class="si">}</span><span class="s2">/minica.pem&#34;</span> --ca-key<span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">CURRENT_DIR</span><span class="si">}</span><span class="s2">/minica-key.pem&#34;</span> --domains<span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">DOMAINS</span><span class="si">}</span><span class="s2">&#34;</span>
mv <span class="s2">&#34;</span><span class="si">${</span><span class="nv">GENERATION_DIRNAME</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;ssl&#34;</span>
cat ssl/key.pem ssl/cert.pem &gt; ssl/mongo.pem

<span class="nb">echo</span> <span class="s2">&#34;== Certificates Generated in the directory </span><span class="si">${</span><span class="nv">CERTS_DIR</span><span class="si">}</span><span class="s2">/ssl&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>启动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up -d</code></pre></td></tr></table>
</div>
</div>
<p>设置/etc/hosts:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">127.0.0.1 mongo1.local</pre></td></tr></table>
</div>
</div>
<p>使用mongo客户端连接：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Should Error because no TLS</span>
mongo --host mongo1.local --port <span class="m">27017</span>
<span class="c1"># Should work</span>
mongo --host mongo1.local --port <span class="m">27017</span> --tls --tlsCAFile<span class="o">=</span>./ssl/minica.pem --tlsCertificateKeyFile<span class="o">=</span>./ssl/mongo.pem
&gt; show dbs
&gt; exit</code></pre></td></tr></table>
</div>
</div>
<p>清理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose down -v</code></pre></td></tr></table>
</div>
</div>
<p>3、配置TCP TLS通过域名访问</p>

<p>docker-compose.yml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>reverse-proxy<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>traefik<span class="p">:</span>latest<span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--api<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--api.insecure<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--providers.docker<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--providers.file.filename=/etc/traefik/traefik-tls.toml<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--entrypoints.mongo.address=<span class="p">:</span><span class="m">27017</span><span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8080:8080&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;27017:27017&#34;</span><span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/var/run/docker.sock<span class="p">:</span>/var/run/docker.sock<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./ssl<span class="p">:</span>/etc/ssl<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./traefik-tls.toml<span class="p">:</span>/etc/traefik/traefik-tls.toml<span class="w">
</span><span class="w">
</span><span class="w">  </span>mongo1<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>mongo<span class="p">:</span><span class="m">4.0</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>mongo1.local<span class="w">
</span><span class="w">    </span>restart<span class="p">:</span><span class="w"> </span>always<span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo1.rule=HostSNI(`mongo1.local`)&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo1.tls=true&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo1.entrypoints=mongo&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>mongo2<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>mongo<span class="p">:</span><span class="m">4.0</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>mongo2.local<span class="w">
</span><span class="w">    </span>restart<span class="p">:</span><span class="w"> </span>always<span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo2.rule=HostSNI(`mongo2.local`)&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo2.tls.passthrough=true&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo2.entrypoints=mongo&#34;</span><span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;mongod&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;--sslMode=requireSSL&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;--sslPEMKeyFile=/etc/ssl/mongo.pem&#34;</span><span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./ssl<span class="p">:</span>/etc/ssl</code></pre></td></tr></table>
</div>
</div>
<p>traefik-tls.toml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">certificates</span><span class="p">]]</span>
  <span class="nx">certFile</span> <span class="p">=</span> <span class="s2">&#34;/etc/ssl/cert.pem&#34;</span>
  <span class="nx">keyFile</span> <span class="p">=</span> <span class="s2">&#34;/etc/ssl/key.pem&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>生成证书：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ssl
rm -rf *.pem
sh generate-certificates.sh <span class="s2">&#34;mongo1.local,mongo2.local&#34;</span> ./
mv certs/* .</code></pre></td></tr></table>
</div>
</div>
<p>启动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up -d</code></pre></td></tr></table>
</div>
</div>
<p>设置/etc/hosts:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">127.0.0.1   mongo1.local mongo2.local</pre></td></tr></table>
</div>
</div>
<p>使用mongo客户端连接：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Mongo 1</span>
mongo --host mongo1.local --port <span class="m">27017</span> --ssl --sslCAFile<span class="o">=</span>./ssl/minica.pem --sslPEMKeyFile<span class="o">=</span>./ssl/mongo.pem
&gt; show dbs
&gt; use meetup
&gt; db.movie.insert<span class="o">({</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;Traefik-Awesome&#34;</span><span class="o">})</span>
&gt; db.movie.find<span class="o">()</span>
&gt; show dbs
&gt; <span class="nb">exit</span>


<span class="c1"># Mongo2</span>
mongo --host mongo2.local --port <span class="m">27017</span> --ssl --sslCAFile<span class="o">=</span>./ssl/minica.pem --sslPEMKeyFile<span class="o">=</span>./ssl/mongo.pem
&gt; show dbs
&gt; exit</code></pre></td></tr></table>
</div>
</div>
<p>清理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose down -v</code></pre></td></tr></table>
</div>
</div>
<p>3、配置TCP 和 HTTP TLS通过域名访问</p>

<p>docker-compose.yml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>reverse-proxy<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>traefik<span class="p">:</span>latest<span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--api<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--api.insecure<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--providers.docker<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--providers.file.filename=/etc/traefik/traefik-tls.toml<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--entrypoints.mongo.address=<span class="p">:</span><span class="m">27017</span><span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8080:8080&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;27017:27017&#34;</span><span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/var/run/docker.sock<span class="p">:</span>/var/run/docker.sock<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./ssl<span class="p">:</span>/etc/ssl<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./traefik-tls.toml<span class="p">:</span>/etc/traefik/traefik-tls.toml<span class="w">
</span><span class="w">
</span><span class="w">  </span>mongo1<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>mongo<span class="p">:</span><span class="m">4.0</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>mongo1.local<span class="w">
</span><span class="w">    </span>restart<span class="p">:</span><span class="w"> </span>always<span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo1.rule=HostSNI(`mongo1.local`)&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo1.tls=true&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo1.entrypoints=mongo&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span>mongo2<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>mongo<span class="p">:</span><span class="m">4.0</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>mongo2.local<span class="w">
</span><span class="w">    </span>restart<span class="p">:</span><span class="w"> </span>always<span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo2.rule=HostSNI(`mongo2.local`)&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo2.tls.passthrough=true&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mongo2.entrypoints=mongo&#34;</span><span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;mongod&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;--sslMode=requireSSL&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;--sslPEMKeyFile=/etc/ssl/mongo.pem&#34;</span><span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./ssl<span class="p">:</span>/etc/ssl<span class="w">
</span><span class="w">      
</span><span class="w">  </span>mongo-express<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>mongo-express<span class="p">:</span><span class="m">0.49</span><span class="w">
</span><span class="w">    </span>restart<span class="p">:</span><span class="w"> </span>always<span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.http.routers.mongo-express.rule=Host(`dashboard-mongo1.local`)&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.http.routers.mongo-express.tls=true&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.http.routers.mongo-express.entrypoints=mongo&#34;</span><span class="w">
</span><span class="w">    </span>environment<span class="p">:</span><span class="w">
</span><span class="w">      </span>ME_CONFIG_MONGODB_SERVER<span class="p">:</span><span class="w"> </span>mongo1</code></pre></td></tr></table>
</div>
</div>
<p>traefik-tls.toml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-toml" data-lang="toml"><span class="p">[[</span><span class="nx">tls</span><span class="p">.</span><span class="nx">certificates</span><span class="p">]]</span>
  <span class="nx">certFile</span> <span class="p">=</span> <span class="s2">&#34;/etc/ssl/cert.pem&#34;</span>
  <span class="nx">keyFile</span> <span class="p">=</span> <span class="s2">&#34;/etc/ssl/key.pem&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>生成证书：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> ssl
rm -rf *.pem
sh generate-certificates.sh <span class="s2">&#34;mongo1.local,mongo2.local,dashboard-mongo1.local&#34;</span> ./
mv certs/* .</code></pre></td></tr></table>
</div>
</div>
<p>启动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up -d</code></pre></td></tr></table>
</div>
</div>
<p>设置/etc/hosts:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">127.0.0.1 mongo1.local mongo2.local dashboard-mongo1.local</pre></td></tr></table>
</div>
</div>
<p>使用mongo客户端连接：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Mongo 1</span>
mongo --host mongo1.local --port <span class="m">27017</span> --ssl --sslCAFile<span class="o">=</span>./ssl/minica.pem --sslPEMKeyFile<span class="o">=</span>./ssl/mongo.pem
&gt; show dbs
&gt; use meetup
&gt; db.movie.insert<span class="o">({</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;Traefik-Awesome&#34;</span><span class="o">})</span>
&gt; db.movie.find<span class="o">()</span>
&gt; show dbs
&gt; <span class="nb">exit</span>


<span class="c1"># Mongo2</span>
mongo --host mongo2.local --port <span class="m">27017</span> --ssl --sslCAFile<span class="o">=</span>./ssl/minica.pem --sslPEMKeyFile<span class="o">=</span>./ssl/mongo.pem
&gt; show dbs
&gt; exit</code></pre></td></tr></table>
</div>
</div>
<p>浏览器访问  <a href="https://dashboard-mongo1.local:27017/">https://dashboard-mongo1.local:27017/</a> ，检查 meetup 数据库是否存在。</p>

<p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1ga9763dk72j31vu0pkq7a.jpg" alt="image-20191225193401174" /></p>

<p>证书不受信任，需要将 minica.pem ROOT CA证书加到浏览器。</p>

<p>清理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose down -v</code></pre></td></tr></table>
</div>
</div>
<p>5、使用ACME生成证书</p>

<p>docker-compose.yml：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>reverse-proxy<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>traefik<span class="p">:</span>latest<span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--api<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--api.insecure<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--providers.docker<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--providers.file.filename=/etc/ssl/traefik-tls.toml<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--entrypoints.mongo.address=<span class="p">:</span><span class="m">27017</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--certificatesResolvers.sample.acme.dnsChallenge.provider=dnspod<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--certificatesResolvers.sample.acme.email=chenzj@wesine.com<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--certificatesResolvers.sample.acme.storage=/etc/traefik/acme.json<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>--certificatesResolvers.sample.acme.caServer=https<span class="p">:</span>//acme-staging-v02.api.letsencrypt.org/directory<span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;27017:27017&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8080:8080&#34;</span><span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/var/run/docker.sock<span class="p">:</span>/var/run/docker.sock<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>../ssl<span class="p">:</span>/etc/ssl<span class="w">
</span><span class="w">
</span><span class="w">  </span>mongo1<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>mongo<span class="p">:</span><span class="m">4.0</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>mongo1.local<span class="w">
</span><span class="w">    </span>restart<span class="p">:</span><span class="w"> </span>always<span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>traefik.tcp.routers.mongo1.rule=HostSNI(`mongo1.local`)<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>traefik.tcp.routers.mongo1.entrypoints=http<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>traefik.http.routers.mongo1-https.rule=HostSNI(`mongo1.local`)<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>traefik.http.routers.mongo1-https.entrypoints=https<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>traefik.http.routers.mongo1-https.tls=<span class="kc">true</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>traefik.http.routers.mongo1-https.tls.certresolver=sample<span class="w">
</span><span class="w">      </span><span class="c"># http 重定向到 https</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>traefik.http.routers.mongo1.middlewares=redirect-http<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>traefik.http.middlewares.redirect-http.redirectscheme.scheme=https<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>traefik.http.middlewares.redirect-http.redirectscheme.port=<span class="m">443</span></code></pre></td></tr></table>
</div>
</div>
<p>启动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up -d</code></pre></td></tr></table>
</div>
</div>
<p>设置/etc/hosts:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">127.0.0.1 mongo1.local mongo2.local dashboard-mongo1.local</pre></td></tr></table>
</div>
</div>
<p>使用mongo客户端连接：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Mongo 1</span>
mongo --host mongo1.local --port <span class="m">443</span> --ssl 
&gt; show dbs
&gt; use meetup
&gt; db.movie.insert<span class="o">({</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;Traefik-Awesome&#34;</span><span class="o">})</span>
&gt; db.movie.find<span class="o">()</span>
&gt; show dbs
&gt; exit</code></pre></td></tr></table>
</div>
</div>
<h2 id="测试mysql-tcp路由">测试Mysql TCP路由</h2>

<p>1、测试简单TCP路由</p>

<p>docker-compose.yml</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s1">&#39;3&#39;</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>reverse-proxy<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>traefik<span class="p">:</span>latest<span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--api<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--api.insecure<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--providers.docker<span class="w">
</span><span class="w">    </span>-<span class="w"> </span>--entrypoints.mysql.address=<span class="p">:</span><span class="m">3306</span><span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;3306:3306&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;8080:8080&#34;</span><span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>/var/run/docker.sock<span class="p">:</span>/var/run/docker.sock<span class="w">
</span><span class="w">
</span><span class="w">  </span>mysql<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>mysql<span class="p">:</span><span class="m">5.7</span><span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mysql.rule=HostSNI(`*`)&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;traefik.tcp.routers.mysql.entrypoints=mysql&#34;</span><span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w"> </span>--character-set-server=utf8mb4<span class="w"> </span>--collation-server=utf8mb4_unicode_ci<span class="w">
</span><span class="w">    </span>environment<span class="p">:</span><span class="w">
</span><span class="w">      </span>MYSQL_ROOT_PASSWORD<span class="p">:</span><span class="w"> </span><span class="m">123456</span><span class="w">
</span><span class="w">      </span>MYSQL_DATABASE<span class="p">:</span><span class="w"> </span>gogs<span class="w">
</span><span class="w">      </span>MYSQL_USER<span class="p">:</span><span class="w"> </span>gogs<span class="w">
</span><span class="w">      </span>MYSQL_PASSWORD<span class="p">:</span><span class="w"> </span><span class="m">123456</span><span class="w">
</span><span class="w">      </span>TZ<span class="p">:</span><span class="w"> </span>Asia/Shanghai</code></pre></td></tr></table>
</div>
</div>
<p>启动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose up -d</code></pre></td></tr></table>
</div>
</div>
<p>设置/etc/hosts:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">127.0.0.1 mysql.local</pre></td></tr></table>
</div>
</div>
<p>使用mongo客户端连接：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mysql -h <span class="m">127</span>.0.0.1 -uroot -P3306 -p
&gt; show databases<span class="p">;</span>
&gt; exit</code></pre></td></tr></table>
</div>
</div>
<p>清理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker-compose down -v</code></pre></td></tr></table>
</div>
</div>
<h1 id="参考文章">参考文章</h1>

<ul>
<li><a href="https://docs.traefik.io/v2.0/">https://docs.traefik.io/v2.0/</a></li>
<li><a href="https://blog.containo.us/back-to-traefik-2-0-2f9aa17be305">https://blog.containo.us/back-to-traefik-2-0-2f9aa17be305</a></li>
<li><a href="https://www.jianshu.com/p/6eeefa2b5765">traefik v1 迁移 到treafik v2.0.0 配置</a></li>
<li><a href="https://www.jianshu.com/p/7ff09090e477">基于 traefik v2 的本地开发、部署一致环境方案</a></li>
<li><a href="https://www.cnblogs.com/rongfengliang/p/11552607.html">Traefik 2.0 tcp 路由试用</a></li>
<li><a href="http://wiki.xglabc.com/Traefik">http://wiki.xglabc.com/Traefik</a></li>
<li><a href="https://www.smarthomebeginner.com/traefik-reverse-proxy-tutorial-for-docker/">Traefik Tutorial: Traefik Reverse Proxy with LetsEncrypt for Docker Media Server</a></li>
<li><a href="https://stackoverflow.com/questions/59264410/how-to-connect-to-traefik-tcp-services-with-tls-configuration-enabled">https://stackoverflow.com/questions/59264410/how-to-connect-to-traefik-tcp-services-with-tls-configuration-enabled</a></li>
<li><a href="https://github.com/containous/slides/tree/master/demo/traefik-v2">https://github.com/containous/slides/tree/master/demo/traefik-v2</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">JavaChen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-12-24
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechatpay.jpg">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay.jpg">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/traefik/">traefik</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2019/12/26/some-usedfull-docker-images/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">一些有用的Docker镜像</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/2019/12/18/install-prometheus-and-grafana-and-alertmanager/">
            <span class="next-text nav-default">安装Prometheus、Grafana、Alertmanager</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="javachen/javachen.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:junecloud@163.com" class="iconfont icon-email" title="email"></a>
      <a href="http://github.com/javachen" class="iconfont icon-github" title="github"></a>
      <a href="http://weibo.com/chenzhijun" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://space.bilibili.com/287563020/" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://blog.javachen.space/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2009 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">JavaChen</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.e1476869.min.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?7eaf37274cf8796df56903a88389e82f";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>

<script id="baidu_push">
  (function(){
    if (window.location.hostname === 'localhost') return;
    var bp = document.createElement('script'); bp.async = true;
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>




</body>
</html>

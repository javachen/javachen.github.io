<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Keycloak安装和使用 - 关注Java、Hadoop、Kubernetes和BI</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="JavaChen" /><meta name="description" content="压缩包安装 参考 https://github.com/keycloak/keycloak-quickstarts/tree/latest/scripts 脚本下载安装： 1 2 3 4 5 6 7 8 9 10 export VERSION=`curl -s https://repo1.maven.org/maven2/org/keycloak/keycloak-server-dist/ | sed -e &amp;#39;s/&amp;lt;[^&amp;gt;]*&amp;gt;//g&amp;#39; | grep -i final | cut -d &amp;#39;/&amp;#39; -f1 | tail -n1` export KEYCLOAK=&amp;#34;keycloak-${VERSION}&amp;#34; ARCHIVE=&amp;#34;${KEYCLOAK}.tar.gz&amp;#34; DIST=&amp;#34;keycloak-server-dist&amp;#34; URL=&amp;#34;https://repo1.maven.org/maven2/org/keycloak/$DIST/${VERSION}/$DIST-${VERSION}.tar.gz&amp;#34; curl -o $ARCHIVE $URL tar xzf $ARCHIVE rm -f $ARCHIVE 创建admin账号，" /><meta name="keywords" content="Java, Hadoop, Docker, Kubernetes" />


<meta name="baidu-site-verification" content="OMsbiDfo1G" />



<meta name="generator" content="Hugo 0.54.0 with theme even" />


<link rel="canonical" href="https://blog.javachen.space/2020/02/10/install-keycloak/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.b90a1cc1.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="Keycloak安装和使用" />
<meta property="og:description" content="压缩包安装 参考 https://github.com/keycloak/keycloak-quickstarts/tree/latest/scripts 脚本下载安装： 1 2 3 4 5 6 7 8 9 10 export VERSION=`curl -s https://repo1.maven.org/maven2/org/keycloak/keycloak-server-dist/ | sed -e &#39;s/&lt;[^&gt;]*&gt;//g&#39; | grep -i final | cut -d &#39;/&#39; -f1 | tail -n1` export KEYCLOAK=&#34;keycloak-${VERSION}&#34; ARCHIVE=&#34;${KEYCLOAK}.tar.gz&#34; DIST=&#34;keycloak-server-dist&#34; URL=&#34;https://repo1.maven.org/maven2/org/keycloak/$DIST/${VERSION}/$DIST-${VERSION}.tar.gz&#34; curl -o $ARCHIVE $URL tar xzf $ARCHIVE rm -f $ARCHIVE 创建admin账号，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.javachen.space/2020/02/10/install-keycloak/" />
<meta property="article:published_time" content="2020-02-10T00:00:00&#43;08:00"/>
<meta property="article:modified_time" content="2020-02-10T00:00:00&#43;08:00"/>

<meta itemprop="name" content="Keycloak安装和使用">
<meta itemprop="description" content="压缩包安装 参考 https://github.com/keycloak/keycloak-quickstarts/tree/latest/scripts 脚本下载安装： 1 2 3 4 5 6 7 8 9 10 export VERSION=`curl -s https://repo1.maven.org/maven2/org/keycloak/keycloak-server-dist/ | sed -e &#39;s/&lt;[^&gt;]*&gt;//g&#39; | grep -i final | cut -d &#39;/&#39; -f1 | tail -n1` export KEYCLOAK=&#34;keycloak-${VERSION}&#34; ARCHIVE=&#34;${KEYCLOAK}.tar.gz&#34; DIST=&#34;keycloak-server-dist&#34; URL=&#34;https://repo1.maven.org/maven2/org/keycloak/$DIST/${VERSION}/$DIST-${VERSION}.tar.gz&#34; curl -o $ARCHIVE $URL tar xzf $ARCHIVE rm -f $ARCHIVE 创建admin账号，">


<meta itemprop="datePublished" content="2020-02-10T00:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2020-02-10T00:00:00&#43;08:00" />
<meta itemprop="wordCount" content="5905">



<meta itemprop="keywords" content="keycloak," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Keycloak安装和使用"/>
<meta name="twitter:description" content="压缩包安装 参考 https://github.com/keycloak/keycloak-quickstarts/tree/latest/scripts 脚本下载安装： 1 2 3 4 5 6 7 8 9 10 export VERSION=`curl -s https://repo1.maven.org/maven2/org/keycloak/keycloak-server-dist/ | sed -e &#39;s/&lt;[^&gt;]*&gt;//g&#39; | grep -i final | cut -d &#39;/&#39; -f1 | tail -n1` export KEYCLOAK=&#34;keycloak-${VERSION}&#34; ARCHIVE=&#34;${KEYCLOAK}.tar.gz&#34; DIST=&#34;keycloak-server-dist&#34; URL=&#34;https://repo1.maven.org/maven2/org/keycloak/$DIST/${VERSION}/$DIST-${VERSION}.tar.gz&#34; curl -o $ARCHIVE $URL tar xzf $ARCHIVE rm -f $ARCHIVE 创建admin账号，"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">JavaChen Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">JavaChen Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Keycloak安装和使用</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-02-10 </span>
        <div class="post-category">
            <a href="/categories/devops/"> devops </a>
            </div>
          <span class="more-meta"> 约 5905 字 </span>
          <span class="more-meta"> 预计阅读 12 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#压缩包安装">压缩包安装</a></li>
<li><a href="#docker安装">Docker安装</a></li>
<li><a href="#docker-compose安装">docker-compose安装</a></li>
<li><a href="#helm安装">Helm安装</a></li>
<li><a href="#使用">使用</a>
<ul>
<li><a href="#登陆">登陆</a></li>
<li><a href="#创建-realm">创建 Realm</a></li>
<li><a href="#创建角色">创建角色</a></li>
<li><a href="#创建用户">创建用户</a></li>
<li><a href="#创建client">创建client</a></li>
<li><a href="#集成ldap">集成LDAP</a></li>
<li><a href="#集成github">集成Github</a></li>
<li><a href="#openid-connect-and-oauth-2-0">OpenID Connect and OAuth 2.0</a>
<ul>
<li><a href="#endpoints">Endpoints</a></li>
<li><a href="#authorization-code-flow">Authorization Code Flow</a></li>
<li><a href="#implicit-flow">Implicit Flow</a></li>
</ul></li>
<li><a href="#admin-rest-api">Admin REST API</a>
<ul>
<li><a href="#鉴权">鉴权</a></li>
<li><a href="#查看用户">查看用户</a></li>
</ul></li>
<li><a href="#admin-cli">Admin CLI</a>
<ul>
<li><a href="#鉴权-1">鉴权</a></li>
<li><a href="#realm">Realm</a></li>
<li><a href="#role">Role</a></li>
<li><a href="#client">Client</a></li>
<li><a href="#user">User</a></li>
<li><a href="#group">Group</a></li>
</ul></li>
<li><a href="#导出和导入">导出和导入</a></li>
</ul></li>
<li><a href="#测试示例">测试示例</a>
<ul>
<li><a href="#命令行创建realm">命令行创建realm</a></li>
<li><a href="#通过导入创建realm">通过导入创建realm</a></li>
</ul></li>
<li><a href="#参考文章">参考文章</a></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="压缩包安装">压缩包安装</h1>

<p>参考 <a href="https://github.com/keycloak/keycloak-quickstarts/tree/latest/scripts">https://github.com/keycloak/keycloak-quickstarts/tree/latest/scripts</a> 脚本下载安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">VERSION</span><span class="o">=</span><span class="sb">`</span>curl -s https://repo1.maven.org/maven2/org/keycloak/keycloak-server-dist/ <span class="p">|</span> sed -e <span class="s1">&#39;s/&lt;[^&gt;]*&gt;//g&#39;</span> <span class="p">|</span> grep -i final <span class="p">|</span> cut -d <span class="s1">&#39;/&#39;</span> -f1 <span class="p">|</span> tail -n1<span class="sb">`</span>
<span class="nb">export</span> <span class="nv">KEYCLOAK</span><span class="o">=</span><span class="s2">&#34;keycloak-</span><span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span><span class="s2">&#34;</span>

<span class="nv">ARCHIVE</span><span class="o">=</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">KEYCLOAK</span><span class="si">}</span><span class="s2">.tar.gz&#34;</span>
<span class="nv">DIST</span><span class="o">=</span><span class="s2">&#34;keycloak-server-dist&#34;</span>
<span class="nv">URL</span><span class="o">=</span><span class="s2">&#34;https://repo1.maven.org/maven2/org/keycloak/</span><span class="nv">$DIST</span><span class="s2">/</span><span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span><span class="s2">/</span><span class="nv">$DIST</span><span class="s2">-</span><span class="si">${</span><span class="nv">VERSION</span><span class="si">}</span><span class="s2">.tar.gz&#34;</span>

curl -o <span class="nv">$ARCHIVE</span> <span class="nv">$URL</span>
tar xzf <span class="nv">$ARCHIVE</span>
rm -f <span class="nv">$ARCHIVE</span></code></pre></td></tr></table>
</div>
</div>
<p>创建admin账号，设置密码是admin123</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">$KEYCLOAK</span>/bin/add-user-keycloak.sh -u admin -p admin</code></pre></td></tr></table>
</div>
</div>
<p>启动：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">$KEYCLOAK</span>/bin/standalone.sh -Djava.net.preferIPv4Stack<span class="o">=</span><span class="nb">true</span> &gt; keycloak.log <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>

<span class="c1"># 修改端口</span>
<span class="c1"># $KEYCLOAK/bin/standalone.sh -Djava.net.preferIPv4Stack=true \</span>
<span class="c1">#    -Djboss.socket.binding.port-offset=100 &gt; keycloak.log 2&gt;&amp;1 &amp;</span></code></pre></td></tr></table>
</div>
</div>
<p>访问 <a href="http://192.168.56.21:8080/auth/admin/">http://192.168.56.21:8080/auth/admin/</a> ，登陆Admin Console，输入用户名和密码admin。</p>

<h1 id="docker安装">Docker安装</h1>

<p>安装Postgres数据库：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker run -d --name postgres -p <span class="m">5432</span>:5432 -e <span class="nv">POSTGRES_PASSWORD</span><span class="o">=</span><span class="m">123456</span> postgres

docker <span class="nb">exec</span> -it postgres psql -Upostgres -w -c <span class="s2">&#34;CREATE DATABASE keycloak WITH OWNER postgres;&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>使用docker安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker run -d <span class="se">\
</span><span class="se"></span>  --name keycloak <span class="se">\
</span><span class="se"></span>  -e <span class="nv">KEYCLOAK_USER</span><span class="o">=</span>admin <span class="se">\
</span><span class="se"></span>  -e <span class="nv">KEYCLOAK_PASSWORD</span><span class="o">=</span>admin123 <span class="se">\
</span><span class="se"></span>  -e <span class="nv">DB_VENDOR</span><span class="o">=</span>POSTGRES <span class="se">\
</span><span class="se"></span>  -e <span class="nv">DB_ADDR</span><span class="o">=</span><span class="m">192</span>.168.1.111 <span class="se">\
</span><span class="se"></span>  -e <span class="nv">DB_PORT</span><span class="o">=</span><span class="m">5432</span> <span class="se">\
</span><span class="se"></span>  -e <span class="nv">DB_DATABASE</span><span class="o">=</span>keycloak <span class="se">\
</span><span class="se"></span>  -e <span class="nv">DB_USER</span><span class="o">=</span>postgres <span class="se">\
</span><span class="se"></span>  -e <span class="nv">DB_PASSWORD</span><span class="o">=</span><span class="m">123456</span> <span class="se">\
</span><span class="se"></span>  -e <span class="nv">JDBC_PARAMS</span><span class="o">=</span><span class="s1">&#39;connectTimeout=30&#39;</span> <span class="se">\
</span><span class="se"></span>  -p <span class="m">8080</span>:8080 <span class="se">\
</span><span class="se"></span>  jboss/keycloak</code></pre></td></tr></table>
</div>
</div>
<p>在此之后，我们只需登录到容器并导航到<code>bin</code>文件夹。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">docker exec -it keycloak /bin/bash
cd keycloak/bin</pre></td></tr></table>
</div>
</div>
<p>我们需要从CLI客户端登录keycloak服务器，之后我们不再需要身份验证：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">./kcadm.sh config credentials --server http://localhost:8080/auth --realm master --user admin --password admin123</code></pre></td></tr></table>
</div>
</div>
<h1 id="docker-compose安装">docker-compose安装</h1>

<p>参考 <a href="https://github.com/keycloak/keycloak-containers/blob/master/docker-compose-examples">https://github.com/keycloak/keycloak-containers/blob/master/docker-compose-examples</a> ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dockerfile" data-lang="dockerfile">version: <span class="s1">&#39;3&#39;</span><span class="err">
</span><span class="err">
</span><span class="err"></span>services:<span class="err">
</span><span class="err"></span>  postgres:<span class="err">
</span><span class="err"></span>      image: postgres<span class="err">
</span><span class="err"></span>      volumes:<span class="err">
</span><span class="err"></span>        - ./data:/var/lib/postgresql/data<span class="err">
</span><span class="err"></span>      environment:<span class="err">
</span><span class="err"></span>        POSTGRES_DB: keycloak<span class="err">
</span><span class="err"></span>        POSTGRES_USER: admin<span class="err">
</span><span class="err"></span>        POSTGRES_PASSWORD: <span class="m">123456</span><span class="err">
</span><span class="err"></span>  keycloak:<span class="err">
</span><span class="err"></span>      image: quay.io/keycloak/keycloak:latest<span class="err">
</span><span class="err"></span>      environment:<span class="err">
</span><span class="err"></span>        DB_VENDOR: POSTGRES<span class="err">
</span><span class="err"></span>        DB_ADDR: postgres<span class="err">
</span><span class="err"></span>        DB_DATABASE: keycloak<span class="err">
</span><span class="err"></span>        DB_USER: keycloak<span class="err">
</span><span class="err"></span>        DB_SCHEMA: public<span class="err">
</span><span class="err"></span>        DB_PASSWORD: <span class="m">123456</span><span class="err">
</span><span class="err"></span>        KEYCLOAK_USER: admin<span class="err">
</span><span class="err"></span>        KEYCLOAK_PASSWORD: admin123<span class="err">
</span><span class="err"></span>        <span class="c1"># Uncomment the line below if you want to specify JDBC parameters. The parameter below is just an example, and it shouldn&#39;t be used in production without knowledge. It is highly recommended that you read the PostgreSQL JDBC driver documentation in order to use it.</span><span class="err">
</span><span class="err"></span>        <span class="c1">#JDBC_PARAMS: &#34;ssl=true&#34;</span><span class="err">
</span><span class="err"></span>      ports:<span class="err">
</span><span class="err"></span>        - <span class="m">8080</span>:8080<span class="err">
</span><span class="err"></span>      depends_on:<span class="err">
</span><span class="err"></span>        - postgres</code></pre></td></tr></table>
</div>
</div>
<h1 id="helm安装">Helm安装</h1>

<p>创建命名空间：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kubectl create namespace keycloak</code></pre></td></tr></table>
</div>
</div>
<p>创建TLS证书：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt; EOF | kubectl create -f -   
</span><span class="s">apiVersion: cert-manager.io/v1alpha2
</span><span class="s">kind: Certificate
</span><span class="s">metadata:
</span><span class="s">  name: keycloak-test-javachen-com-cn-cert
</span><span class="s">  namespace: keycloak
</span><span class="s">spec:
</span><span class="s">  secretName: keycloak-test-javachen-com-cn-cert
</span><span class="s">  renewBefore: 720h
</span><span class="s">  dnsNames:
</span><span class="s">  - &#34;keycloak.javachen.com&#34;
</span><span class="s">  - &#34;keycloak.demorealm.javachen.com&#34;
</span><span class="s">  issuerRef:
</span><span class="s">    name: cert-manager-webhook-dnspod-cluster-issuer
</span><span class="s">    kind: ClusterIssuer
</span><span class="s">EOF</span></code></pre></td></tr></table>
</div>
</div>
<p>添加chart：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">git clone https://github.com/javachen/charts
<span class="nb">cd</span> charts</code></pre></td></tr></table>
</div>
</div>
<p>创建values文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">cat <span class="s">&lt;&lt;EOF &gt; keycloak-values.yaml
</span><span class="s">keycloak:
</span><span class="s">  image: 
</span><span class="s">    tag: 8.0.2
</span><span class="s">  username: admin
</span><span class="s">  password: admin123
</span><span class="s">  extraArgs: &#34;-Dkeycloak.profile.feature.upload_scripts=enabled&#34;
</span><span class="s">  persistence:
</span><span class="s">    deployPostgres: false
</span><span class="s">    dbVendor: postgres
</span><span class="s">    dbName: keycloak
</span><span class="s">    dbHost: 192.168.1.111
</span><span class="s">    dbPort: 5432 
</span><span class="s">    dbUser: postgres
</span><span class="s">    dbPassword: &#34;123456&#34;
</span><span class="s">  ingress:
</span><span class="s">    enabled: true
</span><span class="s">    annotations:
</span><span class="s">      kubernetes.io/ingress.class: nginx
</span><span class="s">      nginx.ingress.kubernetes.io/ssl-redirect: &#34;true&#34;
</span><span class="s">      nginx.ingress.kubernetes.io/proxy-body-size: 100m
</span><span class="s">    hosts:
</span><span class="s">      - keycloak.javachen.com
</span><span class="s">      - keycloak.test.javachen.com
</span><span class="s">    tls:
</span><span class="s">      - secretName: keycloak-test-javachen-com-cn-cert
</span><span class="s">        hosts:
</span><span class="s">          - keycloak.javachen.com
</span><span class="s">          - keycloak.test.javachen.com
</span><span class="s">EOF</span></code></pre></td></tr></table>
</div>
</div>
<p>开启一些实验特效，参考：<a href="https://www.keycloak.org/docs/latest/server_installation/#profiles">https://www.keycloak.org/docs/latest/server_installation/#profiles</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">extraArgs: <span class="s2">&#34;-Dkeycloak.profile.feature.upload_scripts=enabled&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>helm3安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">helm install keycloak -n keycloak -f keycloak-values.yaml ./keycloak</code></pre></td></tr></table>
</div>
</div>
<p>卸载：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">helm del keycloak -n keycloak </code></pre></td></tr></table>
</div>
</div>
<h1 id="使用">使用</h1>

<h2 id="登陆">登陆</h2>

<p>访问 <a href="http://localhost:8080">http://localhost:8080</a> ，跳转到欢迎页面：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtv1ti3ddj31gb0u044t.jpg" alt="image-20200212195153727" /></p>

<p>点击 Administration Console ，进入登陆页面，输入前面设置的用户名和密码：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtv3nhkkij319q0u0n2i.jpg" alt="image-20200212195342596" /></p>

<p>登陆后进入 Master Realm页面：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtv4t2zvjj31ee0u0dlq.jpg" alt="image-20200212195449483" /></p>

<p>为保护不同的应用，通常创建不同的Realm，各Realm间的数据和配置是独立的。初始创建的Realm为Master，Master是最高级别的Realm。Master Realm内的admin用户（授予admin角色的用户）拥有查看和管理任何其它realm的权限。因此，不推荐使用master realm管理用户和应用，而应仅供超级管理员来创建和管理realm。</p>

<h2 id="创建-realm">创建 Realm</h2>

<p>每个realm有专用的管理控制台，可以设置自已的管理员账号，可以创建一个新的Realm：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtv5q4x36j31f60u0dlr.jpg" alt="image-20200212195542516" /></p>

<p>如果启用User-Managed Access，则在Account页面可以看到My Resources：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbty74yhbij31ya0ogn11.jpg" alt="image-20200212214049514" /></p>

<p>输入名称demo：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtv6xs9iij31jb0u0tbc.jpg" alt="image-20200212195652348" /></p>

<p>点击创建按钮：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtv7t2wq1j31cy0u00yk.jpg" alt="image-20200212195742561" /></p>

<p>设置登陆：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbty2ai4m7j31gu0u0dln.jpg" alt="image-20200212213612182" /></p>

<p>Require SSL有三个选项：all requests、external requests、none，默认为external requests，在生产环境中应配置为all requests。</p>

<ul>
<li>all requests： 所有请求都需通过HTTPS访问</li>
<li>external requests： localhost和私有IP不需通过HTTPS访问</li>
<li>none：任何客户端都不需HTTPS</li>
</ul>

<p>设置邮箱：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbty46vl24j31ay0u00zx.jpg" alt="image-20200212213800533" /></p>

<p>设置主题和国际化：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbty4pis5nj31fc0u0jxj.jpg" alt="image-20200212213830665" /></p>

<h2 id="创建角色">创建角色</h2>

<p>Role分为两种级别：Realm、Client，默认Realm Role：offline_access、uma_authorization。
OpenID规范中定义了：</p>

<ul>
<li><p>offline access，用户登录获得offline token，当用户退出后offline token仍可使用。在很多场景中是非常有用的，比如每日离线备份数据。要获得offline token除需offline_access角色外，还需指定offline_access Scope。默认，offline token不会过期，但需每30天刷新一次。</p></li>

<li><p>uma_authorization：User-Managed Access</p></li>
</ul>

<p>这里，创建一个Realm角色 user：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtv9ofgq0j31d30u0dk3.jpg" alt="image-20200212195931009" /></p>

<h2 id="创建用户">创建用户</h2>

<p>创建一个用户 user：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtv8rxfplj31fg0u0tdn.jpg" alt="image-20200212195838022" /></p>

<p>保存之后，设置密码并关闭 Temporary，表示密码不是临时的。注意：如果设置了 Temporary，则下次登录时候要求修改密码。</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtvbspwq2j31ct0u0q8l.jpg" alt="image-20200212200132432" /></p>

<p>创建用户之后，可以访问 <a href="http://localhost:8080/auth/realms/demo/account">http://localhost:8080/auth/realms/demo/account</a> ，输入创建的用户名user和密码123456：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtvejtnojj31if0u078t.jpg" alt="image-20200212200411431" /></p>

<p>登陆之后，可以设置邮箱和用户名：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtvg2hm4rj31ue0rgtbo.jpg" alt="image-20200212200539391" /></p>

<p>也可以修改密码：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtvgx73fdj31ts0qstbf.jpg" alt="image-20200212200628377" /></p>

<p>查看登陆的session：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtvhgtjrbj31v00o0dip.jpg" alt="image-20200212200659937" /></p>

<p>查看应用访问权限：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtvhv0rflj31u80nadj7.jpg" alt="image-20200212200722649" /></p>

<h2 id="创建client">创建client</h2>

<p>Client是realm中受信任的应用。</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtyund9dqj31qy0o078r.jpg" alt="image-20200212220327116" /></p>

<p>默认有以下几个client：</p>

<ul>
<li>admin-cli：admin cli客户端</li>
<li>account：用户管理的client，可以设置邮箱、修改密码</li>
<li>broker：</li>
<li>realm-management： 预置了realm管理角色，创建realm管理员时需要分配这些角色</li>
<li>security-admin-console： realm管理控制台</li>
</ul>

<p>创建一个客户端，名称为 app：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtvjdx1tjj31ss0rgtcj.jpg" alt="image-20200212200850279" /></p>

<p>保存之后，设置Valid Redirect URIs和Web Origins：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtwggs3rdj31bp0u0q9t.jpg" alt="image-20200212204037536" /></p>

<p>参数说明：</p>

<ul>
<li><p>Client ID：客户端id</p></li>

<li><p>Name：显示的名称</p></li>

<li><p>Description：备注说明</p></li>

<li><p>Enabled：是否启用</p></li>

<li><p>Consent Required：是否启用Consent</p></li>

<li><p>Login Theme：登陆主题</p></li>

<li><p>Client Protocol：客户端协议：openid-connect、saml</p></li>

<li><p>Access Type：访问类型：confidential、public、bearer-only</p>

<ul>
<li>如果设置为public，则有以下参数：</li>
<li>Standard Flow Enabled：即OAuth 2.0规范中的Authorization Code Flow，推荐使用的认证流程，安全性高。keycloak验证用户后附加一次性、临时的Authorization Code重定向到浏览器，浏览器凭此Code与keycloak交换token（identity、access和refresh token）</li>
<li>Implicit Flow Enabled：keycloak验证用户后直接返回identity和access token</li>
<li>Direct Access Grants Enabled：REST client使用用户名和秘密访获取token的方式，使用HTTP Post请求，响应结果包含access和refresh token</li>
<li>Root URL：</li>
<li>Valid Redirect URIs：重定向地址</li>
<li>Base URL：应用的首页地址</li>
<li>Admin URL：</li>
<li>Web Origins：允许跨域地址</li>
<li>如果设置为confidential，则在public基础上增加下面两个参数：</li>
<li>Service Accounts Enabled：</li>
<li>Authorization Enabled：</li>
<li>如果设置为bearer-only，则仅仅有下面参数：</li>
<li>Admin URL</li>
</ul></li>
</ul>

<blockquote>
<p><strong>Note:</strong> Standard Flow is Keycloak&rsquo;s name for the OpenID Connect <a href="https://tools.ietf.org/html/rfc6749#section-1.3.1">Authorization Code Flow</a>.</p>
</blockquote>

<h2 id="集成ldap">集成LDAP</h2>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbsb5bx6ygj31qg0sqq9f.jpg" alt="image-20200211113746806" /></p>

<p>集成Openldap，Vendor设置为Other：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbsb6z03s8j31ay0u07b8.jpg" alt="image-20200211113921753" /></p>

<p>设置邮箱已验证：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbsb87htjhj31jc0tyjva.jpg" alt="image-20200211114033086" /></p>

<h2 id="集成github">集成Github</h2>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbsbajgfquj318a0u0tl6.jpg" alt="image-20200211114247423" /></p>

<p>在Github中创建一个应用，然后设置Client ID和Client Secret：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbsbbgqkk4j31dk0u07at.jpg" alt="image-20200211114341125" /></p>

<h2 id="openid-connect-and-oauth-2-0">OpenID Connect and OAuth 2.0</h2>

<h3 id="endpoints">Endpoints</h3>

<p>查看Endpoints：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">curl http://localhost:8080/auth/realms/demo/.well-known/openid-configuration</code></pre></td></tr></table>
</div>
</div>
<p>返回如下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;issuer&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8080/auth/realms/demo&#34;</span><span class="p">,</span>
    <span class="nt">&#34;authorization_endpoint&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8080/auth/realms/development/protocol/openid-connect/auth&#34;</span><span class="p">,</span>
    <span class="nt">&#34;token_endpoint&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8080/auth/realms/demo/protocol/openid-connect/token&#34;</span><span class="p">,</span>
    <span class="nt">&#34;token_introspection_endpoint&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8080/auth/realms/demo/protocol/openid-connect/token/introspect&#34;</span><span class="p">,</span>
    <span class="nt">&#34;userinfo_endpoint&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8080/auth/realms/demo/protocol/openid-connect/userinfo&#34;</span><span class="p">,</span>
    <span class="nt">&#34;end_session_endpoint&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8080/auth/realms/demo/protocol/openid-connect/logout&#34;</span><span class="p">,</span>
    <span class="nt">&#34;jwks_uri&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8080/auth/realms/demo/protocol/openid-connect/certs&#34;</span><span class="p">,</span>
    <span class="nt">&#34;check_session_iframe&#34;</span><span class="p">:</span> <span class="s2">&#34;http://localhost:8080/auth/realms/demo/protocol/openid-connect/login-status-iframe.html&#34;</span><span class="p">,</span>
    
    <span class="err">...</span>
    
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="authorization-code-flow">Authorization Code Flow</h3>

<p>The <a href="https://www.keycloak.org/docs/latest/server_admin/index.html#authorization-code-flow">Authorization Code Flow</a> is a browser-based protocol that makes heavy use of browser redirects to obtain an identity token and an access token.</p>

<p>请求授权：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">http://localhost:8080/auth/realms/demo/protocol/openid-connect/auth?response_type=code&amp;client_id=app&amp;redirect_uri=http://localhost:8081/authorization-code/callback</pre></td></tr></table>
</div>
</div>
<p>跳转到登陆页面：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtw62s56cj31j90u0n19.jpg" alt="image-20200212203038408" /></p>

<p>登陆之后，返回内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">http://localhost:8081/authorization-code/callback?session_state<span class="o">=</span>46d1eaae-06b0-4746-a4ed-25d8a4c897b2<span class="p">&amp;</span><span class="nv">code</span><span class="o">=</span>b0f35d63-5a4f-488c-94e9-e2c49f59778f.46d1eaae-06b0-4746-a4ed-25d8a4c897b2.72025168-043b-4605-8555-bfb43a7f4310</code></pre></td></tr></table>
</div>
</div>
<p>获取access token：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">curl -X POST -H <span class="s2">&#34;Content-Type: application/x-www-form-urlencoded&#34;</span> -d <span class="s2">&#34;grant_type=authorization_code&amp;code=b0f35d63-5a4f-488c-94e9-e2c49f59778f.46d1eaae-06b0-4746-a4ed-25d8a4c897b2.72025168-043b-4605-8555-bfb43a7f4310&amp;redirect_uri=http://localhost:8081/authorization-code/callback&amp;client_id=app&amp;client_secret=dc970dbc-b938-48fa-933d-fe8b0ebff4a5&#34;</span> http://localhost:8080/auth/realms/demo/protocol/openid-connect/token</code></pre></td></tr></table>
</div>
</div>
<p>返回内容大概如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;access_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldU ...&#34;</span><span class="p">,</span>
    <span class="nt">&#34;expires_in&#34;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
    <span class="nt">&#34;refresh_expires_in&#34;</span><span class="p">:</span> <span class="mi">1800</span><span class="p">,</span>
    <span class="nt">&#34;refresh_token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSld ...&#34;</span><span class="p">,</span>
    <span class="nt">&#34;token_type&#34;</span><span class="p">:</span> <span class="s2">&#34;bearer&#34;</span><span class="p">,</span>
    <span class="nt">&#34;not-before-policy&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&#34;session_state&#34;</span><span class="p">:</span> <span class="s2">&#34;04c1e2e4-e6a2-460f-841a-83ef532b01d8&#34;</span><span class="p">,</span>
    <span class="nt">&#34;scope&#34;</span><span class="p">:</span> <span class="s2">&#34;email profile&#34;</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="implicit-flow">Implicit Flow</h3>

<p>The <a href="https://www.keycloak.org/docs/latest/server_admin/index.html#implicit-flow">Implicit Flow</a> is similar to the Authorization Code Flow, however, there are fewer requests and no refresh tokens involved.</p>

<p>请求授权：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">http://localhost:8080/auth/realms/demo/protocol/openid-connect/auth?response_type=token&amp;client_id=sapp&amp;redirect_uri=http://localhost:8081/implicit/callback</pre></td></tr></table>
</div>
</div>
<p>跳转到登陆页面，输入用户名和密码，然后返回：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">http://localhost:8081/implicit/callback#session_state=71a1c19e-7f17-4d54-a18b-5f58801b6cee&amp;access_token=eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI1RS1qR0lsRGRwZ2puaEp6YmRTM1hYZVpXWkNtUlVCODVTbmZwN&amp;token_type=bearer&amp;expires_in=900</pre></td></tr></table>
</div>
</div>
<h2 id="admin-rest-api">Admin REST API</h2>

<h3 id="鉴权">鉴权</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">ACCESS_TOKEN</span><span class="o">=</span><span class="k">$(</span>curl -X POST <span class="s1">&#39;http://localhost:8080/auth/realms/master/protocol/openid-connect/token&#39;</span> <span class="se">\
</span><span class="se"></span>  -H <span class="s2">&#34;Content-Type: application/x-www-form-urlencoded&#34;</span> <span class="se">\
</span><span class="se"></span>  -d <span class="s2">&#34;username=admin&#34;</span> <span class="se">\
</span><span class="se"></span>  -d <span class="s1">&#39;password=admin123&#39;</span> <span class="se">\
</span><span class="se"></span>  -d <span class="s1">&#39;grant_type=password&#39;</span> <span class="se">\
</span><span class="se"></span>  -d <span class="s1">&#39;client_id=admin-cli&#39;</span> <span class="p">|</span> jq -r <span class="s1">&#39;.access_token&#39;</span><span class="k">)</span></code></pre></td></tr></table>
</div>
</div>
<ul>
<li>注意：设置 admin-cli 的 <code>Access Type to</code> 为confidential</li>
</ul>

<h3 id="查看用户">查看用户</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">curl -X GET &#39;http://localhost:8080/auth/admin/realms/demo/users&#39; \
  -H &#34;Accept: application/json&#34; \
  -H &#34;Authorization: Bearer $ACCESS_TOKEN&#34; | jq .</pre></td></tr></table>
</div>
</div>
<h2 id="admin-cli">Admin CLI</h2>

<p>设置环境变量，如果设docker安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker <span class="nb">exec</span> -it keycloak /bin/bash

$ <span class="nb">export</span> <span class="nv">KEYCLOAK_HOME</span><span class="o">=</span>/opt/jboss/keycloak
$ <span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$KEYCLOAK_HOME</span>/bin
$ kcadm.sh</code></pre></td></tr></table>
</div>
</div>
<h3 id="鉴权-1">鉴权</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh config credentials --server http://localhost:8080/auth --realm master --user admin --client admin-cli --password admin123</code></pre></td></tr></table>
</div>
</div>
<h3 id="realm">Realm</h3>

<p>创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh create realms -s realm=test -s enabled=true

kcadm.sh create realms -f demorealm.json

kcadm.sh create realms -f - &lt;&lt; EOF
{ &#34;realm&#34;: &#34;demorealm&#34;, &#34;enabled&#34;: true }
EOF</pre></td></tr></table>
</div>
</div>
<p>查看：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh get realms --no-config --server http://localhost:8080/auth --realm master --user admin --password admin123

kcadm.sh get realms --fields realm,enabled

kcadm.sh get realms --fields realm --format csv --noquotes

kcadm.sh get keys -r demorealm</code></pre></td></tr></table>
</div>
</div>
<p>查看指定realm：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh get realms/master</code></pre></td></tr></table>
</div>
</div>
<p>更新：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh update realms/demorealm -s <span class="nv">enabled</span><span class="o">=</span><span class="nb">false</span>

<span class="c1">#先保存，编辑后再更新</span>
kcadm.sh get realms/demorealm &gt; demorealm.json
vi demorealm.json
kcadm.sh update realms/demorealm -f demorealm.json

kcadm.sh update realms/demorealm -s <span class="nv">registrationAllowed</span><span class="o">=</span><span class="nb">true</span> -s <span class="nv">registrationEmailAsUsername</span><span class="o">=</span><span class="nb">true</span> -s <span class="nv">rememberMe</span><span class="o">=</span><span class="nb">true</span> -s <span class="nv">verifyEmail</span><span class="o">=</span><span class="nb">true</span> -s <span class="nv">resetPasswordAllowed</span><span class="o">=</span><span class="nb">true</span> -s <span class="nv">editUsernameAllowed</span><span class="o">=</span>true</code></pre></td></tr></table>
</div>
</div>
<p>删除：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh delete realms/demorealm</code></pre></td></tr></table>
</div>
</div>
<p>导入文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh create partialImport -r demorealm -s <span class="nv">ifResourceExists</span><span class="o">=</span>FAIL -o -f demorealm.json</code></pre></td></tr></table>
</div>
</div>
<p>设置密码策略：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh update realms/demorealm -s <span class="s1">&#39;passwordPolicy=&#34;hashIterations and specialChars and upperCase and digits and notUsername and length&#34;&#39;</span>

<span class="c1">#查看</span>
kcadm.sh get realms/demorealm --fields passwordPolicy</code></pre></td></tr></table>
</div>
</div>
<h3 id="role">Role</h3>

<p>创建Realm角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh create roles -r demorealm -s name=user -s &#39;description=Regular user with limited set of permissions&#39;</pre></td></tr></table>
</div>
</div>
<p>创建client角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh get clients -r demorealm --fields id,clientId
kcadm.sh create clients/a95b6af3-0bdc-4878-ae2e-6d61a4eca9a0/roles -r demorealm -s name=editor -s &#39;description=Editor can edit, and publish any article&#39;</pre></td></tr></table>
</div>
</div>
<p>查看Realm角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh get roles -r demorealm
kcadm.sh get-roles -r demorealm

kcadm.sh get-roles -r demorealm --rname testrole
kcadm.sh get-roles -r demorealm --rname testrole --effective
kcadm.sh get-roles -r demorealm --rname testrole --available</pre></td></tr></table>
</div>
</div>
<p>查看client角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh get-roles -r demorealm --cclientid realm-management

kcadm.sh get-roles -r demorealm --rname testrole -cclientid realm-management
kcadm.sh get-roles -r demorealm --rname testrole -cclientid realm-management --effective
kcadm.sh get-roles -r demorealm --rname testrole -cclientid realm-management --available</pre></td></tr></table>
</div>
</div>
<p>查看指定Realm角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh get roles/user -r demorealm</pre></td></tr></table>
</div>
</div>
<p>查看指定client角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh get-roles -r demorealm --cclientid realm-management --rolename manage-clients</pre></td></tr></table>
</div>
</div>
<p>更新Realm角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh update roles/user -r demorealm -s &#39;description=Role representing a regular user&#39;</pre></td></tr></table>
</div>
</div>
<p>更新client角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh update clients/a95b6af3-0bdc-4878-ae2e-6d61a4eca9a0/roles/editor -r demorealm -s &#39;description=User that can edit, and publish articles&#39;</pre></td></tr></table>
</div>
</div>
<p>删除Realm角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh delete roles/user -r demorealm</pre></td></tr></table>
</div>
</div>
<p>删除client角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh delete clients/a95b6af3-0bdc-4878-ae2e-6d61a4eca9a0/roles/editor -r demorealm</pre></td></tr></table>
</div>
</div>
<p>添加或者删除Realm角色到另一个角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh add-roles --rname testrole --rolename user -r demorealm
kcadm.sh remove-roles --rname testrole --rolename user -r demorealm</code></pre></td></tr></table>
</div>
</div>
<p>添加client角色到realm角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh add-roles -r demorealm --rname testrole --cclientid realm-management --rolename create-client --rolename view-users</pre></td></tr></table>
</div>
</div>
<p>添加client角色到client角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh get-roles -r demorealm --cclientid demorealm-client --rolename operations
kcadm.sh add-roles -r demorealm --cclientid demorealm-client --rid fc400897-ef6a-4e8c-872b-1581b7fa8a71 --rolename support
kcadm.sh get-roles --rid fc400897-ef6a-4e8c-872b-1581b7fa8a71 --all</pre></td></tr></table>
</div>
</div>
<p>从组合角色删除一个client角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh remove-roles -r demorealm --rname testrole --cclientid realm-management --rolename create-client --rolename view-users</pre></td></tr></table>
</div>
</div>
<p>添加或者删除一个client角色到组</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ kcadm.sh add-roles -r demorealm --gname Group --cclientid realm-management --rolename create-client --rolename view-users

$ kcadm.sh remove-roles -r demorealm --gname Group --cclientid realm-management --rolename create-client --rolename view-users</code></pre></td></tr></table>
</div>
</div>
<h3 id="client">Client</h3>

<p>创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh create clients -r demorealm -s <span class="nv">clientId</span><span class="o">=</span>myapp -s <span class="nv">enabled</span><span class="o">=</span><span class="nb">true</span>

kcadm.sh create clients -r demorealm -s <span class="nv">clientId</span><span class="o">=</span>myapp -s <span class="nv">enabled</span><span class="o">=</span><span class="nb">true</span> -s <span class="nv">clientAuthenticatorType</span><span class="o">=</span>client-secret -s <span class="nv">secret</span><span class="o">=</span>d0b8122f-8dfb-46b7-b68a-f5cc4e25d000</code></pre></td></tr></table>
</div>
</div>
<p>查看：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh get clients -r demorealm --fields id,clientId

kcadm.sh get clients/c7b8547f-e748-4333-95d0-410b76b3f4a3 -r demorealm

kcadm.sh get clients/<span class="nv">$CID</span>/client-secret

kcadm.sh get clients/c7b8547f-e748-4333-95d0-410b76b3f4a3/installation/providers/keycloak-oidc-keycloak-json -r demorealm</code></pre></td></tr></table>
</div>
</div>
<p>更新：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh update clients/c7b8547f-e748-4333-95d0-410b76b3f4a3 -r demorealm -s enabled=false -s publicClient=true -s &#39;redirectUris=[&#34;http://localhost:8080/myapp/*&#34;]&#39; -s baseUrl=http://localhost:8080/myapp -s adminUrl=http://localhost:8080/myapp</pre></td></tr></table>
</div>
</div>
<p>删除：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh delete clients/c7b8547f-e748-4333-95d0-410b76b3f4a3 -r demorealm</pre></td></tr></table>
</div>
</div>
<p>添加或删除client service account：service-account-CLIENT_ID</p>

<h3 id="user">User</h3>

<p>创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh create users -r demorealm -s username=testuser -s enabled=true</pre></td></tr></table>
</div>
</div>
<p>查看用户：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh get users -r demorealm

kcadm.sh get users -r demorealm --offset 0 --limit 1000

kcadm.sh get users -r demorealm -q email=google.com
kcadm.sh get users -r demorealm -q username=testuser

kcadm.sh get users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2 -r demorealm</pre></td></tr></table>
</div>
</div>
<p>更新：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh update users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2 -r demorealm -s &#39;requiredActions=[&#34;VERIFY_EMAIL&#34;,&#34;UPDATE_PROFILE&#34;,&#34;CONFIGURE_TOTP&#34;,&#34;UPDATE_PASSWORD&#34;]&#39;</pre></td></tr></table>
</div>
</div>
<p>删除：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh delete users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2 -r demorealm</pre></td></tr></table>
</div>
</div>
<p>设置密码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh set-password -r demorealm --username user --new-password <span class="m">654321</span> --temporary

kcadm.sh update users/0ba7a3fd-6fd8-48cd-a60b-2e8fd82d56e2/reset-password -r demorealm -s <span class="nv">type</span><span class="o">=</span>password -s <span class="nv">value</span><span class="o">=</span><span class="m">654321</span> -s <span class="nv">temporary</span><span class="o">=</span><span class="nb">true</span> -n</code></pre></td></tr></table>
</div>
</div>
<p>查看某个用户的realm角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh get-roles -r demorealm --uusername testuser
kcadm.sh get-roles -r demorealm --uusername testuser --effective
kcadm.sh get-roles -r demorealm --uusername testuser --available</pre></td></tr></table>
</div>
</div>
<p>查看某个用户的client角色：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh get-roles -r demorealm --uusername testuser --cclientid realm-management
kcadm.sh get-roles -r demorealm --uusername testuser --cclientid realm-management --effective
kcadm.sh get-roles -r demorealm --uusername testuser --cclientid realm-management --available</pre></td></tr></table>
</div>
</div>
<p>添加或删除realm角色给用户：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh add-roles --uusername testuser --rolename user -r demorealm
kcadm.sh remove-roles --uusername testuser --rolename user -r demorealm</pre></td></tr></table>
</div>
</div>
<p>添加或删除client角色给用户：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh add-roles -r demorealm --uusername testuser --cclientid realm-management --rolename create-client --rolename view-users
kcadm.sh remove-roles -r demorealm --uusername testuser --cclientid realm-management --rolename create-client --rolename view-users</pre></td></tr></table>
</div>
</div>
<p>查看用户session：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm get users/6da5ab89-3397-4205-afaa-e201ff638f9e/sessions</pre></td></tr></table>
</div>
</div>
<p>退出某个session：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh delete sessions/d0eaa7cc-8c5d-489d-811a-69d3c4ec84d1</pre></td></tr></table>
</div>
</div>
<p>退出所有session：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh create users/6da5ab89-3397-4205-afaa-e201ff638f9e/logout -r demorealm -s realm=demorealm -s user=6da5ab89-3397-4205-afaa-e201ff638f9e</pre></td></tr></table>
</div>
</div>
<h3 id="group">Group</h3>

<p>创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kcadm.sh create groups -r demorealm -s <span class="nv">name</span><span class="o">=</span>Group

kcadm.sh create groups/51204821-0580-46db-8f2d-27106c6b5ded/children -r demorealm -s <span class="nv">name</span><span class="o">=</span>SubGroup</code></pre></td></tr></table>
</div>
</div>
<p>查看：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh get groups -r demorealm
kcadm.sh get groups/51204821-0580-46db-8f2d-27106c6b5ded -r demorealm

kcadm.sh get users/b544f379-5fc4-49e5-8a8d-5cfb71f46f53/groups -r demorealm

kcadm.sh get-roles -r demorealm --gname Group
kcadm.sh get-roles -r demorealm --gname Group --effective
kcadm.sh get-roles -r demorealm --gname Group --available

kcadm.sh get-roles -r demorealm --gname Group --cclientid realm-management
kcadm.sh get-roles -r demorealm --gname Group --cclientid realm-management --effective
kcadm.sh get-roles -r demorealm --gname Group --cclientid realm-management --available</pre></td></tr></table>
</div>
</div>
<p>更新：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh update groups/51204821-0580-46db-8f2d-27106c6b5ded -s &#39;attributes.email=[&#34;group@example.com&#34;]&#39; -r demorealm</pre></td></tr></table>
</div>
</div>
<p>删除：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh delete groups/51204821-0580-46db-8f2d-27106c6b5ded -r demorealm</pre></td></tr></table>
</div>
</div>
<p>移动组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh create groups/51204821-0580-46db-8f2d-27106c6b5ded/children -r demorealm -s id=08d410c6-d585-4059-bb07-54dcb92c5094</pre></td></tr></table>
</div>
</div>
<p>添加或删除：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">kcadm.sh update users/b544f379-5fc4-49e5-8a8d-5cfb71f46f53/groups/ce01117a-7426-4670-a29a-5c118056fe20 -r demorealm -s realm=demorealm -s userId=b544f379-5fc4-49e5-8a8d-5cfb71f46f53 -s groupId=ce01117a-7426-4670-a29a-5c118056fe20 -n

kcadm.sh delete users/b544f379-5fc4-49e5-8a8d-5cfb71f46f53/groups/ce01117a-7426-4670-a29a-5c118056fe20 -r demorealm</pre></td></tr></table>
</div>
</div>
<h2 id="导出和导入">导出和导入</h2>

<p>用docker导出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker <span class="nb">exec</span> -it keycloak /opt/jboss/keycloak/bin/standalone.sh <span class="se">\
</span><span class="se"></span>  -Djboss.socket.binding.port-offset<span class="o">=</span><span class="m">100</span> <span class="se">\
</span><span class="se"></span>  -Dkeycloak.migration.action<span class="o">=</span><span class="nb">export</span> <span class="se">\
</span><span class="se"></span>  -Dkeycloak.migration.provider<span class="o">=</span>singleFile <span class="se">\
</span><span class="se"></span>  -Dkeycloak.migration.file<span class="o">=</span>/data/keycloak-export.json</code></pre></td></tr></table>
</div>
</div>
<p>用docker导入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker container stop keycloak
docker container rm keycloak

docker run -d --name keycloak <span class="se">\
</span><span class="se"></span>  -p <span class="m">8080</span>:8080 <span class="se">\
</span><span class="se"></span>  -v ./data:/data <span class="se">\
</span><span class="se"></span>  -e <span class="nv">KEYCLOAK_USER</span><span class="o">=</span>admin <span class="se">\
</span><span class="se"></span>  -e <span class="nv">KEYCLOAK_PASSWORD</span><span class="o">=</span>admin123 <span class="se">\
</span><span class="se"></span>  jboss/keycloak
  
docker <span class="nb">exec</span> -it keycloak /opt/jboss/keycloak/bin/standalone.sh <span class="se">\
</span><span class="se"></span>  -Djboss.socket.binding.port-offset<span class="o">=</span><span class="m">100</span> <span class="se">\
</span><span class="se"></span>  -Dkeycloak.migration.action<span class="o">=</span>import <span class="se">\
</span><span class="se"></span>  -Dkeycloak.migration.provider<span class="o">=</span>singleFile <span class="se">\
</span><span class="se"></span>  -Dkeycloak.migration.file<span class="o">=</span>/data/keycloak-export.json</code></pre></td></tr></table>
</div>
</div>
<p>从浏览器导入，创建Realm时候，上传文件：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtwt9uttkj31p20s2wgy.jpg" alt="image-20200212205256259" /></p>

<p>使用Import导入：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbtwsdrnkrj313y0u0dke.jpg" alt="image-20200212205204862" /></p>

<h1 id="测试示例">测试示例</h1>

<h2 id="命令行创建realm">命令行创建realm</h2>

<p>这里使用命令行创建，先登陆：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ kubectl <span class="nb">exec</span> -it pod/keycloak-0 -n keycloak -- bash
bash-4.4$ <span class="nb">cd</span> /opt/jboss/keycloak/bin
bash-4.4$ ./kcadm.sh config credentials --server http://localhost:8080/auth --realm master --user admin --password admin123</code></pre></td></tr></table>
</div>
</div>
<p>创建realm，名称为demorealm：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">./kcadm.sh create realms -s realm=test -s enabled=true</pre></td></tr></table>
</div>
</div>
<p>创建两个客户端：client-cli、client-rest：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 注意2个选项：publicClient=true和 directAccessGrantsEnabled=true。第一个使这个客户端公开，这意味着我们的cURL客户端可以在不提供任何秘密的情况下启动登录。第二个使我们能够使用用户名和密码直接登录。</span>
$ ./kcadm.sh create clients -r demorealm -s <span class="nv">clientId</span><span class="o">=</span>client-cli -s <span class="nv">enabled</span><span class="o">=</span><span class="nb">true</span> -s <span class="nv">publicClient</span><span class="o">=</span><span class="nb">true</span> -s <span class="nv">baseUrl</span><span class="o">=</span>http://localhost:8080 -s <span class="nv">adminUrl</span><span class="o">=</span>http://localhost:8080 -s <span class="nv">directAccessGrantsEnabled</span><span class="o">=</span><span class="nb">true</span>
Created new client with id <span class="s1">&#39;5b276dc0-fc52-4580-bb80-5c7c08f58ab6&#39;</span>

<span class="c1"># bearerOnly=true告诉Keycloak客户端永远不会启动登录过程，但是当它收到Bearer令牌时，它将检查所述令牌的有效性。</span>
$ ./kcadm.sh create clients -r demorealm -s <span class="nv">clientId</span><span class="o">=</span>client-rest -s <span class="nv">enabled</span><span class="o">=</span><span class="nb">true</span> -s <span class="nv">baseUrl</span><span class="o">=</span>http://localhost:8080 -s <span class="nv">bearerOnly</span><span class="o">=</span><span class="nb">true</span>
Created new client with id <span class="s1">&#39;c85662e8-9979-492f-8251-c517624abe6b&#39;</span></code></pre></td></tr></table>
</div>
</div>
<p>创建两个realm角色：admin、user</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 注意client后的id是我们创建客户端输出的id</span>
./kcadm.sh create roles -r demorealm -s <span class="nv">name</span><span class="o">=</span>admin -s <span class="s1">&#39;description=Admin role&#39;</span>
./kcadm.sh create roles -r demorealm -s <span class="nv">name</span><span class="o">=</span>user -s <span class="s1">&#39;description=User role&#39;</span></code></pre></td></tr></table>
</div>
</div>
<p>获取 client-rest 客户端的配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">./kcadm.sh get clients/c85662e8-9979-492f-8251-c517624abe6b/installation/providers/keycloak-oidc-keycloak-json -r demorealm</code></pre></td></tr></table>
</div>
</div>
<p>应该返回类似于此的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;realm&#34;</span> <span class="p">:</span> <span class="s2">&#34;demorealm&#34;</span><span class="p">,</span>
  <span class="nt">&#34;bearer-only&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&#34;auth-server-url&#34;</span> <span class="p">:</span> <span class="s2">&#34;http:////localhost:8080/auth/&#34;</span><span class="p">,</span>
  <span class="nt">&#34;ssl-required&#34;</span> <span class="p">:</span> <span class="s2">&#34;external&#34;</span><span class="p">,</span>
  <span class="nt">&#34;resource&#34;</span> <span class="p">:</span> <span class="s2">&#34;client-rest&#34;</span><span class="p">,</span>
  <span class="nt">&#34;verify-token-audience&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&#34;use-resource-role-mappings&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&#34;confidential-port&#34;</span> <span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>创建两个用户：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 创建admin用户</span>
./kcadm.sh create users -r demorealm -s <span class="nv">username</span><span class="o">=</span>admin -s <span class="nv">enabled</span><span class="o">=</span><span class="nb">true</span>
<span class="c1"># 设置admin密码</span>
./kcadm.sh set-password -r demorealm --username admin --new-password admin --temporary
<span class="c1"># 追加到realm admin角色中</span>
./kcadm.sh add-roles -r demorealm --uusername<span class="o">=</span>admin --rolename admin

<span class="c1"># 创建user用户</span>
./kcadm.sh create users -r demorealm -s <span class="nv">username</span><span class="o">=</span>user -s <span class="nv">enabled</span><span class="o">=</span><span class="nb">true</span>
<span class="c1"># 设置user密码</span>
./kcadm.sh set-password -r demorealm --username user --new-password admin --temporary
<span class="c1"># 追加到realm user角色中：</span>
./kcadm.sh add-roles -r demorealm --uusername<span class="o">=</span>user --rolename user</code></pre></td></tr></table>
</div>
</div>
<h2 id="通过导入创建realm">通过导入创建realm</h2>

<p>创建一个配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;realm&#34;</span><span class="p">:</span> <span class="s2">&#34;demo&#34;</span><span class="p">,</span>
  <span class="nt">&#34;displayName&#34;</span><span class="p">:</span> <span class="s2">&#34;测试应用&#34;</span><span class="p">,</span>
  <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&#34;rememberMe&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&#34;verifyEmail&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&#34;loginWithEmailAllowed&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&#34;internationalizationEnabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&#34;supportedLocales&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&#34;en&#34;</span><span class="p">,</span>
    <span class="s2">&#34;zh-CN&#34;</span>
  <span class="p">],</span>
  <span class="nt">&#34;defaultLocale&#34;</span><span class="p">:</span> <span class="s2">&#34;zh-CN&#34;</span><span class="p">,</span>
  <span class="nt">&#34;requiredCredentials&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&#34;password&#34;</span>
  <span class="p">],</span>
  <span class="nt">&#34;smtpServer&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;XXXXXX&#34;</span><span class="p">,</span>
    <span class="nt">&#34;starttls&#34;</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span>
    <span class="nt">&#34;auth&#34;</span><span class="p">:</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span>
    <span class="nt">&#34;port&#34;</span><span class="p">:</span> <span class="s2">&#34;25&#34;</span><span class="p">,</span>
    <span class="nt">&#34;host&#34;</span><span class="p">:</span> <span class="s2">&#34;smtp.exmail.qq.com&#34;</span><span class="p">,</span>
    <span class="nt">&#34;replyTo&#34;</span><span class="p">:</span> <span class="s2">&#34;noreply@javachen.com&#34;</span><span class="p">,</span>
    <span class="nt">&#34;from&#34;</span><span class="p">:</span> <span class="s2">&#34;noreply@javachen.com&#34;</span><span class="p">,</span>
    <span class="nt">&#34;envelopeFrom&#34;</span><span class="p">:</span> <span class="s2">&#34;noreply@javachen.com&#34;</span><span class="p">,</span>
    <span class="nt">&#34;ssl&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
    <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;noreply@javachen.com&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;users&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span>
      <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nt">&#34;credentials&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;password&#34;</span><span class="p">,</span>
          <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;123456&#34;</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&#34;realmRoles&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&#34;user&#34;</span>
      <span class="p">],</span>
      <span class="nt">&#34;clientRoles&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;account&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;view-profile&#34;</span><span class="p">,</span> <span class="s2">&#34;manage-account&#34;</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;admin&#34;</span><span class="p">,</span>
      <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nt">&#34;credentials&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;password&#34;</span><span class="p">,</span>
          <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="s2">&#34;123456&#34;</span>
        <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&#34;realmRoles&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&#34;user&#34;</span><span class="p">,</span>
        <span class="s2">&#34;admin&#34;</span>
      <span class="p">],</span>
      <span class="nt">&#34;clientRoles&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;account&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;view-profile&#34;</span><span class="p">,</span> <span class="s2">&#34;manage-account&#34;</span><span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&#34;roles&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;realm&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span>
        <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;User privileges&#34;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;admin&#34;</span><span class="p">,</span>
        <span class="nt">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Admin privileges&#34;</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="nt">&#34;defaultRoles&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&#34;user&#34;</span><span class="p">,</span>
    <span class="s2">&#34;offline_access&#34;</span><span class="p">,</span>
    <span class="s2">&#34;uma_authorization&#34;</span>
  <span class="p">],</span>
  <span class="nt">&#34;clients&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;clientId&#34;</span><span class="p">:</span> <span class="s2">&#34;app-demorealm&#34;</span><span class="p">,</span>
      <span class="nt">&#34;enabled&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nt">&#34;redirectUris&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&#34;http://localhost:8082/*&#34;</span>
      <span class="p">],</span>
      <span class="nt">&#34;secret&#34;</span><span class="p">:</span> <span class="s2">&#34;secret&#34;</span><span class="p">,</span>
      <span class="nt">&#34;directAccessGrantsEnabled&#34;</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>导入上面文件创建realm：</p>

<p><img src="https://tva1.sinaimg.cn/large/0082zybpgy1gbsbfeao26j31k60kedhq.jpg" alt="image-20200211114727499" /></p>

<h1 id="参考文章">参考文章</h1>

<ul>
<li><a href="http://support.supermap.com.cn/DataWarehouse/WebDocHelp/iPortal/iP/iportal_management/Portal_Security/Keycloak_install_config.htm">Keycloak安装与配置</a></li>
<li><a href="https://www.jianshu.com/p/c9b1ecd28813">Keycloak单点登录</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/29127296">浅析Keycloak单点登陆平台</a></li>
<li><a href="http://javafoot.net/index.php/zh/14-keycloak">keyCloak让登陆认证模块失业</a></li>
<li><a href="https://www.zybuluo.com/EggGump/note/1211864">keycloak 基本操作</a></li>
<li><a href="https://gitee.com/itmuch/spring-cloud-yes/blob/master/doc/keycloak-learn/Keycloak搭建手把手操作指南.md">Keycloak搭建手把手操作指南</a></li>
<li><a href="https://www.liangzl.com/get-article-detail-124061.html">Keycloak授权服务指南</a></li>
<li><a href="https://robferguson.org/blog/2019/12/24/getting-started-with-keycloak/">Getting started with Keycloak</a></li>

<li><p><a href="https://developers.redhat.com/blog/2020/01/29/api-login-and-jwt-token-generation-using-keycloak/">API login and JWT token generation using Keycloak</a></p></li>

<li><p>GitHub: <a href="https://github.com/thomasdarimont/awesome-keycloak">A curated list of resources for learning about Keycloak</a></p></li>

<li><p>ForgeRock: <a href="https://backstage.forgerock.com/knowledge/kb/article/a45882528">How do I perform common OAuth 2.0 tasks using curl commands?</a></p></li>

<li><p>Camunda: <a href="https://github.com/camunda/camunda-bpm-identity-keycloak">Keycloak Identity Provider Plugin</a></p></li>

<li><p>Flowable: <a href="https://github.com/flowable/flowable-engine/pull/1447">Open Pull Request (DEC 2018) - Add support for Keycloak</a></p></li>
</ul>

<p>和spring集成：</p>

<ul>
<li><a href="https://juejin.im/entry/5ab4c2bc6fb9a028c06ac234">Keycloak系列(一) — Keycloak集成LDAP</a></li>
<li><a href="https://tech.bejond.org/2018/03/26/Keycloak和Grafana集成实现单点登录/">Keycloak和Grafana集成实现单点登录</a></li>
<li><a href="https://www.zybuluo.com/EggGump/note/1223485">将keycloak用于保护rest资源</a></li>
<li><a href="https://segmentfault.com/a/1190000018190135">Spring Security整合KeyCloak保护Rest API</a></li>
<li><a href="https://blog.csdn.net/Java_fenxiang/article/details/88753957">使用Keycloak实现安全的SpringBoot微服务</a></li>
<li><a href="https://link.zhihu.com/?target=https%3A//github.com/yourwafer/keycloak-sso">基于Springboot, React实现的Demo</a></li>
<li><a href="https://blog.tzxcode.cn/2019/08/08/keycloak1/">springboot2集成oauth2和keycloak以及admin rest api记录</a></li>
<li><a href="http://www.spring4all.com/article/1496">Spring Boot整合Keycloak快速入门指南</a></li>
<li><a href="https://365airsoft.com/zh-CN/questions/1208186/swaggerzhongdekeycloakjicheng">Swagger中的Keycloak集成 </a></li>
<li><a href="https://www.geek-share.com/detail/2783430020.html">Spring Boot/Angular整合Keycloak实现单点登录功能</a>

<br /></li>
</ul>

<p>和kuberntes集成</p>

<ul>
<li><a href="https://juejin.im/post/5da2f1015188256818619137">使用 KeyCloak 对 Kubernetes 进行统一用户管理</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/cloud/library/cl-lo-openid-connect-kubernetes-authentication2/index.html">使用 OpenID Connect Token 进行 Kubernetes 身份认证和授权</a></li>
<li><a href="https://blog.fleeto.us/post/sidecar-oauth-for-kubernetes-apps/">Kubernetes 中用 Sidecar 为应用添加 Oauth 功能</a></li>
<li><a href="https://blog.hdls.me/15647317755993.html">使用 KeyCloak 对 Kubernetes 进行统一用户管理</a></li>
<li><a href="[https://www.kkzxak47.com/2019/07/30/%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95keycloak/](https://www.kkzxak47.com/2019/07/30/使用企业微信登录keycloak/)">使用企业微信 (Identity Provider) 登录Keycloak (Identity Broker) </a></li>
<li><a href="https://www.qingtingip.com/h_187180.html">Keycloak授权服务指南</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">JavaChen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-02-10
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechatpay.jpg">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay.jpg">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/keycloak/">keycloak</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2020/02/11/authentication-with-spring-boot-and-keycloak/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Authentication with Spring Boot and Keycloak</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/2020/02/07/install-openldap-with-docker-and-k8s/">
            <span class="next-text nav-default">容器化部署OpenLdap</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="javachen/javachen.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:junecloud@163.com" class="iconfont icon-email" title="email"></a>
      <a href="http://github.com/javachen" class="iconfont icon-github" title="github"></a>
      <a href="http://weibo.com/chenzhijun" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://space.bilibili.com/287563020/" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://blog.javachen.space/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2009 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">JavaChen</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.e1476869.min.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?7eaf37274cf8796df56903a88389e82f";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>

<script id="baidu_push">
  (function(){
    if (window.location.hostname === 'localhost') return;
    var bp = document.createElement('script'); bp.async = true;
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>




</body>
</html>

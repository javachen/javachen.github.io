<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>容器化部署OpenLdap - 关注Java、Hadoop、Kubernetes和BI</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="JavaChen" /><meta name="description" content="使用Docker安装 使用Docker安装： 1 2 3 4 5 6 7 docker run -it -d --name ldap \ -p 389:389 -p 636:636 \ --env LDAP_ORGANISATION=&amp;#34;JavaChen&amp;#34; \ --env LDAP_DOMAIN=&amp;#34;javachen.com&amp;#34; \ --env LDAP_BASE_DN=dc=javachen,dc=com \ --env LDAP_ADMIN_PASSWORD=&amp;#34;admin&amp;#34; \ osixia/openldap docker-compose.ya" /><meta name="keywords" content="Java, Hadoop, Docker, Kubernetes" />


<meta name="baidu-site-verification" content="OMsbiDfo1G" />



<meta name="generator" content="Hugo 0.54.0 with theme even" />


<link rel="canonical" href="https://blog.javachen.space/2020/02/07/install-openldap-with-docker-and-k8s/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.b90a1cc1.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="容器化部署OpenLdap" />
<meta property="og:description" content="使用Docker安装 使用Docker安装： 1 2 3 4 5 6 7 docker run -it -d --name ldap \ -p 389:389 -p 636:636 \ --env LDAP_ORGANISATION=&#34;JavaChen&#34; \ --env LDAP_DOMAIN=&#34;javachen.com&#34; \ --env LDAP_BASE_DN=dc=javachen,dc=com \ --env LDAP_ADMIN_PASSWORD=&#34;admin&#34; \ osixia/openldap docker-compose.ya" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.javachen.space/2020/02/07/install-openldap-with-docker-and-k8s/" />
<meta property="article:published_time" content="2020-02-07T00:00:00&#43;08:00"/>
<meta property="article:modified_time" content="2020-02-07T00:00:00&#43;08:00"/>

<meta itemprop="name" content="容器化部署OpenLdap">
<meta itemprop="description" content="使用Docker安装 使用Docker安装： 1 2 3 4 5 6 7 docker run -it -d --name ldap \ -p 389:389 -p 636:636 \ --env LDAP_ORGANISATION=&#34;JavaChen&#34; \ --env LDAP_DOMAIN=&#34;javachen.com&#34; \ --env LDAP_BASE_DN=dc=javachen,dc=com \ --env LDAP_ADMIN_PASSWORD=&#34;admin&#34; \ osixia/openldap docker-compose.ya">


<meta itemprop="datePublished" content="2020-02-07T00:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2020-02-07T00:00:00&#43;08:00" />
<meta itemprop="wordCount" content="2538">



<meta itemprop="keywords" content="openlap,docker," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="容器化部署OpenLdap"/>
<meta name="twitter:description" content="使用Docker安装 使用Docker安装： 1 2 3 4 5 6 7 docker run -it -d --name ldap \ -p 389:389 -p 636:636 \ --env LDAP_ORGANISATION=&#34;JavaChen&#34; \ --env LDAP_DOMAIN=&#34;javachen.com&#34; \ --env LDAP_BASE_DN=dc=javachen,dc=com \ --env LDAP_ADMIN_PASSWORD=&#34;admin&#34; \ osixia/openldap docker-compose.ya"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">JavaChen Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">JavaChen Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">容器化部署OpenLdap</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-02-07 </span>
        <div class="post-category">
            <a href="/categories/devops/"> devops </a>
            </div>
          <span class="more-meta"> 约 2538 字 </span>
          <span class="more-meta"> 预计阅读 6 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#使用docker安装">使用Docker安装</a></li>
<li><a href="#使用helm安装">使用Helm安装</a></li>
<li><a href="#初始化数据">初始化数据</a>
<ul>
<li><a href="#创建基本目录">创建基本目录</a></li>
<li><a href="#启用-memberof-特性">启用 memberOf 特性</a></li>
<li><a href="#批量添加系统用户">批量添加系统用户</a></li>
<li><a href="#添加某个用户">添加某个用户</a></li>
<li><a href="#修改密码">修改密码</a></li>
<li><a href="#删除用户">删除用户</a></li>
</ul></li>
<li><a href="#安装管理工具">安装管理工具</a>
<ul>
<li><a href="#docker安装">docker安装</a></li>
<li><a href="#helm安装">Helm安装</a>
<ul>
<li><a href="#安装phpldapadmin">安装phpldapadmin</a></li>
<li><a href="#安装ltb-self-service-password">安装ltb-self-service-password</a></li>
</ul></li>
</ul></li>
<li><a href="#参考文章">参考文章</a></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="使用docker安装">使用Docker安装</h1>

<p>使用Docker安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">docker run -it -d --name ldap <span class="se">\
</span><span class="se"></span>	-p <span class="m">389</span>:389 -p <span class="m">636</span>:636 <span class="se">\
</span><span class="se"></span>	--env <span class="nv">LDAP_ORGANISATION</span><span class="o">=</span><span class="s2">&#34;JavaChen&#34;</span> <span class="se">\
</span><span class="se"></span>	--env <span class="nv">LDAP_DOMAIN</span><span class="o">=</span><span class="s2">&#34;javachen.com&#34;</span> <span class="se">\
</span><span class="se"></span>	--env <span class="nv">LDAP_BASE_DN</span><span class="o">=</span><span class="nv">dc</span><span class="o">=</span>javachen,dc<span class="o">=</span>com <span class="se">\
</span><span class="se"></span>	--env <span class="nv">LDAP_ADMIN_PASSWORD</span><span class="o">=</span><span class="s2">&#34;admin&#34;</span> <span class="se">\
</span><span class="se"></span>	osixia/openldap</code></pre></td></tr></table>
</div>
</div>
<p>docker-compose.yaml：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span><span class="w">
</span><span class="w"></span>services<span class="p">:</span><span class="w">
</span><span class="w">  </span>openldap<span class="p">:</span><span class="w">
</span><span class="w">    </span>image<span class="p">:</span><span class="w"> </span>osixia/openldap<span class="w">
</span><span class="w">    </span>container_name<span class="p">:</span><span class="w"> </span>openldap<span class="w">
</span><span class="w">    </span>command<span class="p">:</span><span class="w"> </span><span class="s2">&#34;--loglevel debug&#34;</span><span class="w">
</span><span class="w">    </span>ports<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;389:389&#34;</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span><span class="s2">&#34;636:636&#34;</span><span class="w">
</span><span class="w">    </span>volumes<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./data/certs<span class="p">:</span>/container/service/slapd/assets/certs<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./data/etc<span class="p">:</span>/etc/ldap/slapd.d<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./data/var<span class="p">:</span>/var/lib/ldap<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>./data/run<span class="p">:</span>/container/run<span class="w">
</span><span class="w">    </span>environment<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>LDAP_ORGANISATION=JavaChen<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>LDAP_DOMAIN=javachen.com<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>LDAP_ADMIN_PASSWORD=admin<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>LDAP_CONFIG_PASSWORD=config<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>LDAP_BACKEND=hdb<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>LDAP_TLS=<span class="kc">false</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>LDAP_TLS_CA_CRT_FILENAME=ca.crt<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>LDAP_TLS_CRT_FILENAME=ldap.crt<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>LDAP_TLS_KEY_FILENAME=ldap.key<span class="w">
</span><span class="w">    </span>restart<span class="p">:</span><span class="w"> </span>always</code></pre></td></tr></table>
</div>
</div>
<h1 id="使用helm安装">使用Helm安装</h1>

<p>创建命名空间：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kubectl create namespace openldap</code></pre></td></tr></table>
</div>
</div>
<p>添加helm仓库：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">helm repo add stable https://kubernetes-charts.storage.googleapis.com/
helm repo update</code></pre></td></tr></table>
</div>
</div>
<p>编写values文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">cat &gt; openldap-values.yaml <span class="s">&lt;&lt;EOF
</span><span class="s">image:
</span><span class="s">  tag: 1.3.0
</span><span class="s">tls:
</span><span class="s">  enabled: false
</span><span class="s">env:
</span><span class="s">  LDAP_ORGANISATION: &#34;javachen&#34;
</span><span class="s">  LDAP_DOMAIN: &#34;javachen.com&#34;
</span><span class="s">  LDAP_BACKEND: &#34;hdb&#34;
</span><span class="s">  LDAP_TLS: &#34;false&#34;
</span><span class="s">  LDAP_TLS_ENFORCE: &#34;false&#34;
</span><span class="s">  LDAP_REMOVE_CONFIG_AFTER_SETUP: &#34;true&#34;  
</span><span class="s">
</span><span class="s">adminPassword: admin
</span><span class="s">configPassword: config
</span><span class="s">
</span><span class="s">persistence:
</span><span class="s">  enabled: true
</span><span class="s">  storageClass: &#34;ceph-rbd&#34;
</span><span class="s">  size: 1Gi
</span><span class="s">EOF</span></code></pre></td></tr></table>
</div>
</div>
<p>使用Helm3部署：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">helm install openldap -n openldap -f openldap-values.yaml stable/openldap</code></pre></td></tr></table>
</div>
</div>
<p>可以根据helm安装提示获取openldap的admin密码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kubectl get secret -n openldap openldap <span class="se">\
</span><span class="se"></span>	-o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.LDAP_ADMIN_PASSWORD}&#34;</span><span class="p">|</span>base64 --decode<span class="p">;</span> <span class="nb">echo</span>  

kubectl get secret -n openldap openldap <span class="se">\
</span><span class="se"></span>	-o <span class="nv">jsonpath</span><span class="o">=</span><span class="s2">&#34;{.data.LDAP_CONFIG_PASSWORD}&#34;</span><span class="p">|</span>base64 --decode<span class="p">;</span> echo</code></pre></td></tr></table>
</div>
</div>
<p>默认情况下openladp只能在kubernetes集群上通信，这里将服务转发端口：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kubectl port-forward svc/openldap -n openldap <span class="m">389</span>:389</code></pre></td></tr></table>
</div>
</div>
<p>测试本地端口，验证下，端口已经成功暴露给了集群外：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">telnet localhost <span class="m">389</span>
Trying <span class="m">127</span>.0.0.1...
Connected to localhost.
Escape character is <span class="s1">&#39;^]&#39;</span>.</code></pre></td></tr></table>
</div>
</div>
<p>也使用nodeport的方式进行端口开放：直接修改集群openldap service</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">kubectl edit -n openldap svc openldap</code></pre></td></tr></table>
</div>
</div>
<p>添加nodePort: 30389 和nodePort: 30636 并将type修改为NodePort ，默认情况下kubernetes开放的端口为30000-32768，需要开放其他端口需要修改kube-apiserver启动参数 查看主机端口开放情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ netstat -tnpl <span class="p">|</span>grep :30389 
tcp6       <span class="m">0</span>      <span class="m">0</span> :::30389                :::*                    LISTEN      -</code></pre></td></tr></table>
</div>
</div>
<p>测试：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ldapsearch -x -H ldap://127.0.0.1:30389 -b <span class="s2">&#34;dc=javachen,dc=com&#34;</span>

ldapsearch -LLL -W -x -D <span class="s2">&#34;cn=admin,dc=javachen,dc=com&#34;</span> <span class="se">\
</span><span class="se"></span>	-H ldap://127.0.0.1:30389 -b <span class="s2">&#34;dc=javachen,dc=com&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="初始化数据">初始化数据</h1>

<h2 id="创建基本目录">创建基本目录</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">cat &gt; basedomain.ldif <span class="s">&lt;&lt;EOF
</span><span class="s">dn: dc=javachen,dc=com
</span><span class="s">objectClass: top
</span><span class="s">objectClass: dcObject
</span><span class="s">objectclass: organization
</span><span class="s">o: javachen
</span><span class="s">dc: javachen
</span><span class="s">
</span><span class="s">dn: cn=admin,dc=javachen,dc=com
</span><span class="s">objectClass: organizationalRole
</span><span class="s">cn: admin
</span><span class="s">description: Directory Manager
</span><span class="s">
</span><span class="s">dn: ou=People,dc=javachen,dc=com
</span><span class="s">objectClass: organizationalUnit
</span><span class="s">ou: People
</span><span class="s">
</span><span class="s">dn: ou=Group,dc=javachen,dc=com
</span><span class="s">objectClass: organizationalUnit
</span><span class="s">ou: Group
</span><span class="s">
</span><span class="s">dn: cn=jira,ou=Group,dc=javachen,dc=com
</span><span class="s">objectClass: groupOfUniqueNames
</span><span class="s">cn: jira
</span><span class="s">uniqueMember:
</span><span class="s">EOF</span></code></pre></td></tr></table>
</div>
</div>
<p>运行命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ldapadd -c -h localhost -p <span class="m">30389</span> -x -D <span class="nv">cn</span><span class="o">=</span>admin,dc<span class="o">=</span>javachen,dc<span class="o">=</span>com -w admin -f basedomain.ldif</code></pre></td></tr></table>
</div>
</div>
<h2 id="启用-memberof-特性">启用 memberOf 特性</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># memberof.ldif</span>
dn: <span class="nv">cn</span><span class="o">=</span>module,cn<span class="o">=</span>config
cn: module
objectClass: olcModuleList
olcModuleLoad: memberof.la
olcModulePath: /usr/lib64/openldap

dn: <span class="nv">olcOverlay</span><span class="o">=</span>memberof,olcDatabase<span class="o">={</span><span class="m">1</span><span class="o">}</span>hdb,cn<span class="o">=</span>config
objectClass: olcConfig
objectClass: olcMemberOf
objectClass: olcOverlayConfig
objectClass: top
olcOverlay: memberof
olcMemberOfDangling: ignore
olcMemberOfRefInt: TRUE
olcMemberOfGroupOC: groupOfUniqueNames                      
olcMemberOfMemberAD: uniqueMember                           
olcMemberOfMemberOfAD: memberOf</code></pre></td></tr></table>
</div>
</div>
<p>接着使用 <code>ldapadd</code> 命令将其导入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ldapadd -Y EXTERNAL -H ldapi:/// -f memberof.ldif</code></pre></td></tr></table>
</div>
</div>
<p>参考：</p>

<ul>
<li><a href="https://www.jianshu.com/p/c877b317f294">Centos 7 Openldap利用memberof属性动态管理用户主机访问权限</a></li>
<li><a href="https://www.adimian.com/blog/2014/10/how-to-enable-memberof-using-openldap/">How to enable MemberOf using OpenLDAP</a></li>
<li><a href="https://mayanbin.com/post/enable-memberof-in-openldap.html">如何启用 OpenLDAP 的 memberOf 特性</a></li>
</ul>

<h2 id="批量添加系统用户">批量添加系统用户</h2>

<p>创建 add_system_users.sh 文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="c1"># 提取UID为1000-9999的本地用户和组</span>
<span class="c1"># 这里是一个示例，将“SUFFIX=***”替换为自己的域名</span>

<span class="nv">SUFFIX</span><span class="o">=</span><span class="s1">&#39;dc=javachen,dc=com&#39;</span>
<span class="nv">LDIF</span><span class="o">=</span><span class="s1">&#39;ldapusers.ldif&#39;</span>

<span class="nb">echo</span> -n &gt; <span class="nv">$LDIF</span>
<span class="nv">GROUP_IDS</span><span class="o">=()</span>
grep <span class="s2">&#34;x:[1-9][0-9][0-9][0-9]:&#34;</span> /etc/passwd <span class="p">|</span> <span class="o">(</span><span class="k">while</span> <span class="nb">read</span> TARGET_USER
<span class="k">do</span>
    <span class="nv">USER_ID</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$TARGET_USER</span><span class="s2">&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f1<span class="k">)</span><span class="s2">&#34;</span>

    <span class="nv">USER_NAME</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$TARGET_USER</span><span class="s2">&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f5 <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f1,2<span class="k">)</span><span class="s2">&#34;</span>
    <span class="o">[</span> ! <span class="s2">&#34;</span><span class="nv">$USER_NAME</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">USER_NAME</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$USER_ID</span><span class="s2">&#34;</span>

    <span class="nv">LDAP_SN</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$USER_NAME</span><span class="s2">&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f2<span class="k">)</span><span class="s2">&#34;</span>
    <span class="o">[</span> ! <span class="s2">&#34;</span><span class="nv">$LDAP_SN</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">LDAP_SN</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$USER_NAME</span><span class="s2">&#34;</span>

    <span class="nv">LASTCHANGE_FLAG</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>grep <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER_ID</span><span class="si">}</span><span class="s2">:&#34;</span> /etc/shadow <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f3<span class="k">)</span><span class="s2">&#34;</span>
    <span class="o">[</span> ! <span class="s2">&#34;</span><span class="nv">$LASTCHANGE_FLAG</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">LASTCHANGE_FLAG</span><span class="o">=</span><span class="s2">&#34;0&#34;</span>

    <span class="nv">SHADOW_FLAG</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>grep <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER_ID</span><span class="si">}</span><span class="s2">:&#34;</span> /etc/shadow <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f9<span class="k">)</span><span class="s2">&#34;</span>
    <span class="o">[</span> ! <span class="s2">&#34;</span><span class="nv">$SHADOW_FLAG</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">SHADOW_FLAG</span><span class="o">=</span><span class="s2">&#34;0&#34;</span>

    <span class="nv">GROUP_ID</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$TARGET_USER</span><span class="s2">&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f4<span class="k">)</span><span class="s2">&#34;</span>
    <span class="o">[</span> ! <span class="s2">&#34;</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">GROUP_IDS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="p">|</span> grep <span class="s2">&#34;</span><span class="nv">$GROUP_ID</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>    	<span class="nv">GROUP_IDS</span><span class="o">=(</span><span class="s2">&#34;</span><span class="si">${</span><span class="nv">GROUP_IDS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$GROUP_ID</span><span class="s2">&#34;</span><span class="o">)</span>

    <span class="nb">echo</span> <span class="s2">&#34;dn: uid=</span><span class="nv">$USER_ID</span><span class="s2">,ou=People,</span><span class="nv">$SUFFIX</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;objectClass: inetOrgPerson&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;objectClass: posixAccount&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;objectClass: shadowAccount&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;sn: </span><span class="nv">$LDAP_SN</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;givenName: </span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$USER_NAME</span><span class="s2">&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span><span class="k">)</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;cn: </span><span class="nv">$USER_NAME</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;displayName: </span><span class="nv">$USER_NAME</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;uidNumber: </span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$TARGET_USER</span><span class="s2">&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f3<span class="k">)</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;gidNumber: </span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$TARGET_USER</span><span class="s2">&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f4<span class="k">)</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;userPassword: {crypt}</span><span class="k">$(</span>grep <span class="s2">&#34;</span><span class="si">${</span><span class="nv">USER_ID</span><span class="si">}</span><span class="s2">:&#34;</span> /etc/shadow<span class="p">|</span>cut -d<span class="s1">&#39;:&#39;</span> -f2<span class="k">)</span><span class="s2">&#34;</span>&gt;&gt;<span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;gecos: </span><span class="nv">$USER_NAME</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;loginShell: </span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$TARGET_USER</span><span class="s2">&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f7<span class="k">)</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;homeDirectory: </span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$TARGET_USER</span><span class="s2">&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f6<span class="k">)</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;shadowExpire: </span><span class="k">$(</span>passwd -S <span class="s2">&#34;</span><span class="nv">$USER_ID</span><span class="s2">&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $7}&#39;</span><span class="k">)</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;shadowFlag: </span><span class="nv">$SHADOW_FLAG</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;shadowWarning: </span><span class="k">$(</span>passwd -S <span class="s2">&#34;</span><span class="nv">$USER_ID</span><span class="s2">&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $6}&#39;</span><span class="k">)</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;shadowMin: </span><span class="k">$(</span>passwd -S <span class="s2">&#34;</span><span class="nv">$USER_ID</span><span class="s2">&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $4}&#39;</span><span class="k">)</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;shadowMax: </span><span class="k">$(</span>passwd -S <span class="s2">&#34;</span><span class="nv">$USER_ID</span><span class="s2">&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;{print $5}&#39;</span><span class="k">)</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;shadowLastChange: </span><span class="nv">$LASTCHANGE_FLAG</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> &gt;&gt; <span class="nv">$LDIF</span>
<span class="k">done</span>

<span class="k">for</span> TARGET_GROUP_ID in <span class="s2">&#34;</span><span class="si">${</span><span class="nv">GROUP_IDS</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&#34;</span>
<span class="k">do</span>
    <span class="nv">LDAP_CN</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>grep <span class="s2">&#34;:</span><span class="si">${</span><span class="nv">TARGET_GROUP_ID</span><span class="si">}</span><span class="s2">:&#34;</span> /etc/group <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f1<span class="k">)</span><span class="s2">&#34;</span>

    <span class="nb">echo</span> <span class="s2">&#34;dn: cn=</span><span class="nv">$LDAP_CN</span><span class="s2">,ou=Group,</span><span class="nv">$SUFFIX</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;objectClass: posixGroup&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;cn: </span><span class="nv">$LDAP_CN</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="nb">echo</span> <span class="s2">&#34;gidNumber: </span><span class="nv">$TARGET_GROUP_ID</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>

    <span class="k">for</span> MEMBER_UID in <span class="k">$(</span>grep <span class="s2">&#34;:</span><span class="si">${</span><span class="nv">TARGET_GROUP_ID</span><span class="si">}</span><span class="s2">:&#34;</span> /etc/passwd <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f1,3<span class="k">)</span>
    <span class="k">do</span>
        <span class="nv">UID_NUM</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$MEMBER_UID</span><span class="s2">&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f2<span class="k">)</span>
        <span class="o">[</span> <span class="nv">$UID_NUM</span> -ge <span class="m">1000</span> -a <span class="nv">$UID_NUM</span> -le <span class="m">9999</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span><span class="se"></span>        	<span class="nb">echo</span> <span class="s2">&#34;memberUid: </span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$MEMBER_UID</span><span class="s2">&#34;</span> <span class="p">|</span> cut -d<span class="s1">&#39;:&#39;</span> -f1<span class="k">)</span><span class="s2">&#34;</span> &gt;&gt; <span class="nv">$LDIF</span>
    <span class="k">done</span>
    <span class="nb">echo</span> &gt;&gt; <span class="nv">$LDIF</span>
<span class="k">done</span>
<span class="o">)</span></code></pre></td></tr></table>
</div>
</div>
<p>运行脚本，生成ldapusers.ldif文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sh add_system_users.sh</code></pre></td></tr></table>
</div>
</div>
<h2 id="添加某个用户">添加某个用户</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="c1"># const</span>
<span class="nv">LDAP_SERVER_IP</span><span class="o">=</span><span class="s2">&#34;localhost&#34;</span>
<span class="nv">LDAP_SERVER_PORT</span><span class="o">=</span><span class="s2">&#34;30389&#34;</span>
<span class="nv">LDAP_ADMIN_USER</span><span class="o">=</span><span class="s2">&#34;cn=admin,dc=javachen,dc=com&#34;</span>
<span class="nv">LDAP_ADMIN_PASS</span><span class="o">=</span><span class="s2">&#34;admin&#34;</span>

<span class="k">if</span> <span class="o">[</span> x<span class="s2">&#34;</span><span class="nv">$#</span><span class="s2">&#34;</span> !<span class="o">=</span> x<span class="s2">&#34;3&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> &lt;username&gt; &lt;realname&gt;&#34;</span>
    <span class="nb">exit</span> -1
<span class="k">fi</span>

<span class="c1"># param</span>
<span class="nv">USER_ID</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
<span class="nv">SN</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
<span class="nv">NAME</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$3</span><span class="s2">&#34;</span>
<span class="nv">PASSWORD</span><span class="o">=</span><span class="s2">&#34;123456&#34;</span>
<span class="nv">ENCRYPT_PASSWORD</span><span class="o">=</span><span class="k">$(</span>slappasswd -h <span class="o">{</span>ssha<span class="o">}</span> -s <span class="s2">&#34;</span><span class="nv">$PASSWORD</span><span class="s2">&#34;</span><span class="k">)</span>

<span class="c1"># add count &amp; group</span> 
cat <span class="s">&lt;&lt;EOF | ldapmodify -c -h $LDAP_SERVER_IP -p $LDAP_SERVER_PORT \
</span><span class="s">    -w $LDAP_ADMIN_PASS -D $LDAP_ADMIN_USER 
</span><span class="s">dn: cn=$USER_ID,ou=People,javachen,dc=com
</span><span class="s">changetype: add
</span><span class="s">objectClass: top
</span><span class="s">objectClass: person
</span><span class="s">objectClass: organizationalPerson
</span><span class="s">objectClass: inetOrgPerson
</span><span class="s">cn: $USER_ID
</span><span class="s">sn: $SN
</span><span class="s">givenName: $NAME
</span><span class="s">displayName: $SN$NAME
</span><span class="s">mail: $USER_ID@javachen.com
</span><span class="s">userPassword: $ENCRYPT_PASSWORD
</span><span class="s">
</span><span class="s">dn: cn=jira,ou=Group,javachen,dc=com
</span><span class="s">changetype: modify
</span><span class="s">add: uniqueMember
</span><span class="s">uniqueMember: cn=$USER_ID,ou=People,javachen,dc=com
</span><span class="s">EOF</span></code></pre></td></tr></table>
</div>
</div>
<p>可以创建一个文件，批量添加：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">cat &gt; users.txt <span class="s">&lt;&lt;EOF
</span><span class="s">zhangshan  张 三
</span><span class="s">EOF</span></code></pre></td></tr></table>
</div>
</div>
<p>batch_add_from_file.sh：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span><span class="k">while</span> <span class="nb">read</span> line
<span class="k">do</span>
    ./add_user.sh <span class="nv">$line</span>
<span class="k">done</span> &lt; users.txt</code></pre></td></tr></table>
</div>
</div>
<p>运行脚本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">chmod +x add_user.sh
sh batch_add_from_file.sh</code></pre></td></tr></table>
</div>
</div>
<h2 id="修改密码">修改密码</h2>

<p>modify_password.sh：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="c1"># const</span>
<span class="nv">LDAP_SERVER_IP</span><span class="o">=</span><span class="s2">&#34;localhost&#34;</span>
<span class="nv">LDAP_SERVER_PORT</span><span class="o">=</span><span class="s2">&#34;30389&#34;</span>
<span class="nv">LDAP_ADMIN_USER</span><span class="o">=</span><span class="s2">&#34;cn=admin,dc=javachen,dc=com&#34;</span>
<span class="nv">LDAP_ADMIN_PASS</span><span class="o">=</span><span class="s2">&#34;admin&#34;</span>

<span class="k">if</span> <span class="o">[</span> x<span class="s2">&#34;</span><span class="nv">$#</span><span class="s2">&#34;</span> !<span class="o">=</span> x<span class="s2">&#34;2&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> &lt;username&gt; &lt;newPassword&gt;&#34;</span>
    <span class="nb">exit</span> -1
<span class="k">fi</span>

<span class="c1"># param</span>
<span class="nv">USERNAME</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
<span class="nv">PASSWORD</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span>
<span class="nv">ENCRYPT_PASSWORD</span><span class="o">=</span><span class="k">$(</span>slappasswd -h <span class="o">{</span>ssha<span class="o">}</span> -s <span class="s2">&#34;</span><span class="nv">$PASSWORD</span><span class="s2">&#34;</span><span class="k">)</span>

<span class="c1"># modify</span>
cat <span class="s">&lt;&lt;EOF | ldapmodify -c -h $LDAP_SERVER_IP -p $LDAP_SERVER_PORT \
</span><span class="s">	-w $LDAP_ADMIN_PASS -D $LDAP_ADMIN_USER 
</span><span class="s">dn: cn=$USERNAME,ou=People,dc=javachen,dc=com
</span><span class="s">changetype: modify
</span><span class="s">replace: userPassword
</span><span class="s">userPassword: $ENCRYPT_PASSWORD
</span><span class="s">EOF</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="删除用户">删除用户</h2>

<p>del_user.sh：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="c1"># const</span>
<span class="nv">LDAP_SERVER_IP</span><span class="o">=</span><span class="s2">&#34;localhost&#34;</span>
<span class="nv">LDAP_SERVER_PORT</span><span class="o">=</span><span class="s2">&#34;30389&#34;</span>
<span class="nv">LDAP_ADMIN_USER</span><span class="o">=</span><span class="s2">&#34;cn=admin,dc=javachen,dc=com&#34;</span>
<span class="nv">LDAP_ADMIN_PASS</span><span class="o">=</span><span class="s2">&#34;admin&#34;</span>

<span class="k">if</span> <span class="o">[</span> x<span class="s2">&#34;</span><span class="nv">$#</span><span class="s2">&#34;</span> !<span class="o">=</span> x<span class="s2">&#34;1&#34;</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&#34;Usage: </span><span class="nv">$0</span><span class="s2"> &lt;username&gt;&#34;</span>
    <span class="nb">exit</span> -1
<span class="k">fi</span>

<span class="c1"># param</span>
<span class="nv">USERNAME</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>

<span class="c1"># delete user</span> 
ldapdelete -c -h <span class="nv">$LDAP_SERVER_IP</span> -p <span class="nv">$LDAP_SERVER_PORT</span> <span class="se">\
</span><span class="se"></span>	-w <span class="nv">$LDAP_ADMIN_PASS</span> -D <span class="nv">$LDAP_ADMIN_USER</span> <span class="s2">&#34;cn=</span><span class="nv">$USERNAME</span><span class="s2">,ou=People,dc=javachen,dc=com&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="安装管理工具">安装管理工具</h1>

<h2 id="docker安装">docker安装</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">version: <span class="s2">&#34;3.7&#34;</span>

services:
  openldap:
    image: osixia/openldap
    container_name: openldap
    command: <span class="s2">&#34;--loglevel debug&#34;</span>
    ports:
      - <span class="s2">&#34;389:389&#34;</span>
      - <span class="s2">&#34;636:636&#34;</span>
    volumes:
      - ./data/certs:/container/service/slapd/assets/certs
      - ./data/etc:/etc/ldap/slapd.d
      - ./data/var:/var/lib/ldap
      - ./data/run:/container/run
    environment:
      - <span class="nv">LDAP_ORGANISATION</span><span class="o">=</span>JavaChen
      - <span class="nv">LDAP_DOMAIN</span><span class="o">=</span>javachen.com
      - <span class="nv">LDAP_ADMIN_PASSWORD</span><span class="o">=</span>admin
      - <span class="nv">LDAP_CONFIG_PASSWORD</span><span class="o">=</span>config
      - <span class="nv">LDAP_BACKEND</span><span class="o">=</span>hdb
      - <span class="nv">LDAP_TLS</span><span class="o">=</span><span class="nb">false</span>
      - <span class="nv">LDAP_TLS_CA_CRT_FILENAME</span><span class="o">=</span>ca.crt
      - <span class="nv">LDAP_TLS_CRT_FILENAME</span><span class="o">=</span>ldap.crt
      - <span class="nv">LDAP_TLS_KEY_FILENAME</span><span class="o">=</span>ldap.key
    restart: always

  phpldapadmin:
    image: osixia/phpldapadmin
    container_name: phpldapadmin
    command: <span class="s2">&#34;--loglevel debug&#34;</span>
    ports:
      - <span class="s2">&#34;8080:80&#34;</span>
    environment:
      - <span class="nv">PHPLDAPADMIN_LDAP_HOSTS</span><span class="o">=</span><span class="s2">&#34;#PYTHON2BASH:[{&#39;openldap&#39;: [{&#39;server&#39;: [{&#39;tls&#39;: False,&#39;port&#39;:30389}] }] }]&#34;</span>
      - <span class="nv">PHPLDAPADMIN_HTTPS</span><span class="o">=</span><span class="nb">false</span>
    depends_on:
      - openldap
    restart: always

  ldap-ssp:
    image: tiredofit/self-service-password:latest
    container_name: ldap-ssp
    ports:
      - <span class="s2">&#34;8081:80&#34;</span>
    volumes:
      - ./data/:/www/ssp
      - ./logs/:/www/logs
    environment:
      - <span class="nv">LDAP_SERVER</span><span class="o">=</span>ldap://openldap
      - <span class="nv">LDAP_STARTTLS</span><span class="o">=</span><span class="nb">false</span>
      - <span class="nv">LDAP_BINDDN</span><span class="o">=</span><span class="nv">cn</span><span class="o">=</span>admin,dc<span class="o">=</span>javachen,dc<span class="o">=</span>com
      - <span class="nv">LDAP_BINDPASS</span><span class="o">=</span>admin
      - <span class="nv">LDAP_BASE_SEARCH</span><span class="o">=</span><span class="nv">ou</span><span class="o">=</span>People,dc<span class="o">=</span>javachen,dc<span class="o">=</span>com
      - <span class="nv">LDAP_LOGIN_ATTRIBUTE</span><span class="o">=</span>cn
      - <span class="nv">LDAP_FULLNAME_ATTRIBUTE</span><span class="o">=</span>cn
      - <span class="nv">PASSWORD_HASH</span><span class="o">=</span>SSHA
      - <span class="nv">PASSWORD_MIN_LENGTH</span><span class="o">=</span><span class="m">0</span>
      - <span class="nv">PASSWORD_MAX_LENGTH</span><span class="o">=</span><span class="m">0</span>
      - <span class="nv">PASSWORD_MIN_LOWERCASE</span><span class="o">=</span><span class="m">0</span>
      - <span class="nv">PASSWORD_MIN_UPPERCASE</span><span class="o">=</span><span class="m">0</span>
      - <span class="nv">PASSWORD_MIN_DIGIT</span><span class="o">=</span><span class="m">0</span>
      - <span class="nv">PASSWORD_MIN_SPECIAL</span><span class="o">=</span><span class="m">0</span>
      - <span class="nv">QUESTIONS_ENABLED</span><span class="o">=</span><span class="nb">false</span>
      - <span class="nv">MAIL_FROM</span><span class="o">=</span>noreply@example.com
      - <span class="nv">MAIL_FROM_NAME</span><span class="o">=</span>Password Admin
      - <span class="nv">NOTIFY_ON_CHANGE</span><span class="o">=</span><span class="nb">true</span>
      - <span class="nv">SMTP_HOST</span><span class="o">=</span>smtp.example.com
      - <span class="nv">SMTP_AUTH_ON</span><span class="o">=</span><span class="nb">true</span>
      - <span class="nv">SMTP_USER</span><span class="o">=</span>noreply@example.com
      - <span class="nv">SMTP_PASS</span><span class="o">=</span>smtppassword
      - <span class="nv">SMTP_PORT</span><span class="o">=</span><span class="m">25</span>
      - <span class="nv">IS_BEHIND_PROXY</span><span class="o">=</span><span class="nb">false</span>
      - <span class="nv">SECRETEKEY</span><span class="o">=</span>secretkey123
    restart: always
    depends_on:
      - openldap</code></pre></td></tr></table>
</div>
</div>
<h2 id="helm安装">Helm安装</h2>

<h3 id="安装phpldapadmin">安装phpldapadmin</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">git clone https://github.com/javachen/charts.git
<span class="nb">cd</span> charts

kubectl create namespace phpldapadmin

cat <span class="s">&lt;&lt; EOF | kubectl create -f -   
</span><span class="s">apiVersion: cert-manager.io/v1alpha2
</span><span class="s">kind: Certificate
</span><span class="s">metadata:
</span><span class="s">  name: phpldapadmin-test-javachen-com-cn-cert
</span><span class="s">  namespace: phpldapadmin
</span><span class="s">spec:
</span><span class="s">  secretName: phpldapadmin-test-javachen-com-cn-cert
</span><span class="s">  renewBefore: 720h
</span><span class="s">  dnsNames:
</span><span class="s">  - &#34;*.javachen.com.cn&#34;
</span><span class="s">  - &#34;*.test.javachen.com.cn&#34;
</span><span class="s">  issuerRef:
</span><span class="s">    name: cert-manager-webhook-dnspod-cluster-issuer
</span><span class="s">    kind: ClusterIssuer
</span><span class="s">EOF</span></code></pre></td></tr></table>
</div>
</div>
<p>创建values文件phpldapadmin-values.yaml：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">cat &gt;phpldapadmin-values.yaml <span class="s">&lt;&lt;EOF
</span><span class="s">ingress:
</span><span class="s">  enabled: true
</span><span class="s">  annotations:
</span><span class="s">    kubernetes.io/ingress.class: nginx
</span><span class="s">    nginx.ingress.kubernetes.io/ssl-redirect: &#34;true&#34;
</span><span class="s">    nginx.ingress.kubernetes.io/proxy-body-size: 100m
</span><span class="s">  hosts:
</span><span class="s">    - phpldapadmin.javachen.com
</span><span class="s">    - phpldapadmin.test.javachen.com
</span><span class="s">  tls:
</span><span class="s">    - secretName: phpldapadmin-test-javachen-com-cn-cert
</span><span class="s">      hosts:
</span><span class="s">        - phpldapadmin.javachen.com
</span><span class="s">        - phpldapadmin.test.javachen.com
</span><span class="s">env:
</span><span class="s">  - name: PHPLDAPADMIN_LDAP_HOSTS
</span><span class="s">    value: &#34;#PYTHON2BASH:[{&#39;192.168.1.111&#39;: [{&#39;server&#39;: [{&#39;tls&#39;: False,&#39;port&#39;:30389}] }] }]&#34;
</span><span class="s">  - name: PHPLDAPADMIN_HTTPS
</span><span class="s">    value: &#34;false&#34;
</span><span class="s">EOF</span></code></pre></td></tr></table>
</div>
</div>
<p>使用helm3安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">helm install phpldapadmin -n phpldapadmin -f phpldapadmin-values.yaml ./phpldapadmin</pre></td></tr></table>
</div>
</div>
<p>卸载：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">helm del phpldapadmin -n phpldapadmin</code></pre></td></tr></table>
</div>
</div>
<h3 id="安装ltb-self-service-password">安装ltb-self-service-password</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">git clone https://github.com/javachen/charts.git
<span class="nb">cd</span> charts

kubectl create namespace ldap-ssp

cat <span class="s">&lt;&lt; EOF | kubectl create -f -   
</span><span class="s">apiVersion: cert-manager.io/v1alpha2
</span><span class="s">kind: Certificate
</span><span class="s">metadata:
</span><span class="s">  name: ldap-ssp-test-javachen-com-cn-cert
</span><span class="s">  namespace: ldap-ssp
</span><span class="s">spec:
</span><span class="s">  secretName: ldap-ssp-test-javachen-com-cn-cert
</span><span class="s">  renewBefore: 720h
</span><span class="s">  dnsNames:
</span><span class="s">  - &#34;*.javachen.com&#34;
</span><span class="s">  - &#34;*.test.javachen.com&#34;
</span><span class="s">  issuerRef:
</span><span class="s">    name: cert-manager-webhook-dnspod-cluster-issuer
</span><span class="s">    kind: ClusterIssuer
</span><span class="s">EOF</span></code></pre></td></tr></table>
</div>
</div>
<p>创建values文件ldap-ssp-values.yaml：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">cat &gt;ldap-ssp-values.yaml <span class="s">&lt;&lt;EOF
</span><span class="s">ingress:
</span><span class="s">  enabled: true
</span><span class="s">  annotations:
</span><span class="s">    kubernetes.io/ingress.class: nginx
</span><span class="s">    nginx.ingress.kubernetes.io/ssl-redirect: &#34;true&#34;
</span><span class="s">    nginx.ingress.kubernetes.io/proxy-body-size: 100m
</span><span class="s">  hosts:
</span><span class="s">    - ldap-ssp.javachen.com
</span><span class="s">    - ldap-ssp.test.javachen.com
</span><span class="s">  tls:
</span><span class="s">    - secretName: ldap-ssp-test-javachen-com-cn-cert
</span><span class="s">      hosts:
</span><span class="s">        - ldap-ssp.javachen.com
</span><span class="s">        - ldap-ssp.test.javachen.com
</span><span class="s">
</span><span class="s">env:
</span><span class="s">  - name: LDAP_SERVER
</span><span class="s">    value: &#34;ldap://192.168.1.111:30389&#34;
</span><span class="s">  - name: LDAP_STARTTLS
</span><span class="s">    value: &#34;false&#34;
</span><span class="s">  - name: LDAP_BINDDN
</span><span class="s">    value: &#34;cn=admin,dc=javachen,dc=com&#34;
</span><span class="s">  - name: LDAP_BINDPASS
</span><span class="s">    value: &#34;admin&#34;
</span><span class="s">  - name: LDAP_BASE_SEARCH
</span><span class="s">    value: &#34;ou=People,dc=javachen,dc=com&#34;
</span><span class="s">  - name: LDAP_LOGIN_ATTRIBUTE
</span><span class="s">    value: &#34;cn&#34;
</span><span class="s">  - name: PASSWORD_HASH
</span><span class="s">    value: &#34;SSHA&#34;
</span><span class="s">  - name: PASSWORD_MAX_LENGTH
</span><span class="s">    value: &#34;64&#34;
</span><span class="s">  - name: PASSWORD_MIN_LENGTH
</span><span class="s">    value: &#34;8&#34;
</span><span class="s">  - name: PASSWORD_MIN_UPPERCASE
</span><span class="s">    value: &#34;1&#34;
</span><span class="s">  - name: PASSWORD_MIN_SPECIAL
</span><span class="s">    value: &#34;1&#34;
</span><span class="s">  - name: QUESTIONS_ENABLED
</span><span class="s">    value: &#34;false&#34;
</span><span class="s">  - name: MAIL_FROM
</span><span class="s">    value: &#34;noreply@javachen.com&#34;
</span><span class="s">  - name: NOTIFY_ON_CHANGE
</span><span class="s">    value: &#34;true&#34;
</span><span class="s">  - name: SMTP_HOST
</span><span class="s">    value: &#34;smtp.exmail.qq.com&#34;
</span><span class="s">  - name: SMTP_AUTH_ON
</span><span class="s">    value: &#34;true&#34;
</span><span class="s">  - name: SMTP_USER
</span><span class="s">    value: &#34;noreply@javachen.com&#34;
</span><span class="s">  - name: SMTP_PASS
</span><span class="s">    value: &#34;Czj617ws&#34;
</span><span class="s">  - name: SMTP_PORT
</span><span class="s">    value: &#34;25&#34;
</span><span class="s">  - name: SECRETEKEY
</span><span class="s">    value: &#34;secret123456&#34;
</span><span class="s">  - name: IS_BEHIND_PROXY
</span><span class="s">    value: &#34;true&#34;
</span><span class="s">EOF</span></code></pre></td></tr></table>
</div>
</div>
<p>使用helm3安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">helm install ldap-ssp -n ldap-ssp -f ldap-ssp-values.yaml ./ldap-self-service-password</code></pre></td></tr></table>
</div>
</div>
<p>卸载：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">helm del ldap-ssp -n ldap-ssp </code></pre></td></tr></table>
</div>
</div>
<h1 id="参考文章">参考文章</h1>

<ul>
<li><p><a href="https://mayanbin.com/post/openldap-in-centos-7.html">CentOS 7 环境下 OpenLDAP 的安装与配置</a></p></li>

<li><p><a href="https://jaseywang.me/2017/03/04/全网统一账户实践/">全网统一账户实践</a></p></li>

<li><p><a href="https://www.luochunhui.com/blog/openldap/">OpenLdap管理</a></p></li>

<li><p><a href="https://linuxtechlab.com/openldap-complete-guide-install-configure-ldap-centos-rhel/">OpenLDAP: Complete guide to install &amp; configure LDAP on CentOS/RHEL</a></p></li>

<li><p><a href="https://coder4.com/homs_online/toolchain/ldap.html">LDAP 内部账号管理系统</a></p></li>

<li><p><a href="https://www.k8sz.com/post/kubernetesldap/">kubernetes之LDAP安装</a></p></li>

<li><p><a href="https://www.lisenet.com/2016/setup-ldap-authentication-on-centos-7/">Set up LDAP Authentication with nslcd on CentOS 7</a></p></li>

<li><p><a href="https://github.com/JermineHu/5G-AIoT-Infrastructure-Architecture/tree/master/openldap">https://github.com/JermineHu/5G-AIoT-Infrastructure-Architecture/tree/master/openldap</a></p></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">JavaChen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-02-07
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechatpay.jpg">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay.jpg">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/openlap/">openlap</a>
          <a href="/tags/docker/">docker</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/2020/02/06/install-confluence/">
            <span class="next-text nav-default">安装Confluence</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="javachen/javachen.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:junecloud@163.com" class="iconfont icon-email" title="email"></a>
      <a href="http://github.com/javachen" class="iconfont icon-github" title="github"></a>
      <a href="http://weibo.com/chenzhijun" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://space.bilibili.com/287563020/" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="https://blog.javachen.space/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2009 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">JavaChen</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.e1476869.min.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?7eaf37274cf8796df56903a88389e82f";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>

<script id="baidu_push">
  (function(){
    if (window.location.hostname === 'localhost') return;
    var bp = document.createElement('script'); bp.async = true;
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>




</body>
</html>

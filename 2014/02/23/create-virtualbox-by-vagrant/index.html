<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>使用Vagrant创建虚拟机 - JavaChen Blog - Ramblings of a coder</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="JavaChen" /><meta name="description" content="Vagrant是一款用来构建虚拟开发环境的工具，非常适合 php/python/ruby/java 这类语言开发 web 应用，使用Vagrant可以快速的搭建虚拟机并安装自己的一些应用。" /><meta name="keywords" content="Java, Hadoop, Docker" />


<meta name="baidu-site-verification" content="OMsbiDfo1G" />



<meta name="generator" content="Hugo 0.58.3 with theme even" />


<link rel="canonical" href="http://javachen.github.io/2014/02/23/create-virtualbox-by-vagrant/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.5d87ca31.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">
<link rel="stylesheet" href="/css/custom.css">


<meta property="og:title" content="使用Vagrant创建虚拟机" />
<meta property="og:description" content="Vagrant是一款用来构建虚拟开发环境的工具，非常适合 php/python/ruby/java 这类语言开发 web 应用，使用Vagrant可以快速的搭建虚拟机并安装自己的一些应用。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://javachen.github.io/2014/02/23/create-virtualbox-by-vagrant/" />
<meta property="article:published_time" content="2014-02-23T08:00:00+08:00" />
<meta property="article:modified_time" content="2014-02-23T08:00:00+08:00" />
<meta itemprop="name" content="使用Vagrant创建虚拟机">
<meta itemprop="description" content="Vagrant是一款用来构建虚拟开发环境的工具，非常适合 php/python/ruby/java 这类语言开发 web 应用，使用Vagrant可以快速的搭建虚拟机并安装自己的一些应用。">


<meta itemprop="datePublished" content="2014-02-23T08:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2014-02-23T08:00:00&#43;08:00" />
<meta itemprop="wordCount" content="7124">



<meta itemprop="keywords" content="vagrant," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用Vagrant创建虚拟机"/>
<meta name="twitter:description" content="Vagrant是一款用来构建虚拟开发环境的工具，非常适合 php/python/ruby/java 这类语言开发 web 应用，使用Vagrant可以快速的搭建虚拟机并安装自己的一些应用。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">JavaChen Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">JavaChen Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">使用Vagrant创建虚拟机</h1>

      <div class="post-meta">
        <span class="post-time"> 2014-02-23 </span>
        <div class="post-category">
            <a href="/categories/devops/"> devops </a>
            </div>
          <span class="more-meta"> 约 7124 字 </span>
          <span class="more-meta"> 预计阅读 15 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#1-安装virtualbox">1、安装VirtualBox</a></li>
<li><a href="#2-安装vagrant并添加镜像">2、安装Vagrant并添加镜像</a></li>
<li><a href="#3-创建一个虚拟机">3、创建一个虚拟机</a></li>
<li><a href="#4-vagrantfile配置说明">4、Vagrantfile配置说明</a>
<ul>
<li><a href="#box设置">box设置</a></li>
<li><a href="#hostname设置"><strong>hostname设置</strong></a></li>
<li><a href="#虚拟机网络设置">虚拟机网络设置</a>
<ul>
<li><a href="#宿主机与虚机共享同步目录">宿主机与虚机共享同步目录</a></li>
</ul></li>
<li><a href="#定义虚拟机节点名称">定义虚拟机节点名称</a></li>
<li><a href="#通用数据">通用数据</a></li>
<li><a href="#配置信息">配置信息</a></li>
<li><a href="#提供者配置">提供者配置</a></li>
<li><a href="#一组相同配置的vm">一组相同配置的vm</a></li>
<li><a href="#provision任务">provision任务</a></li>
</ul></li>
<li><a href="#5-插件">5、插件</a>
<ul>
<li>
<ul>
<li><a href="#5-1-vagrant-hostmanager">5.1、 vagrant-hostmanager</a></li>
<li><a href="#5-2-vagrant-vbguest">5.2、vagrant-vbguest</a></li>
<li><a href="#5-3-vagrant-bindfs">5.3、vagrant-bindfs</a></li>
</ul></li>
</ul></li>
<li><a href="#6-实验例子">6、实验例子</a>
<ul>
<li>
<ul>
<li><a href="#6-1-搭建一个每台机器不同配置的实验环境">6.1、搭建一个每台机器不同配置的实验环境</a></li>
<li><a href="#6-2-批量搭建一组服务器">6.2、批量搭建一组服务器</a></li>
</ul></li>
</ul></li>
<li><a href="#7-参考文章">7、参考文章</a></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="1-安装virtualbox">1、安装VirtualBox</h1>

<p>下载地址：<a href="https://www.virtualbox.org/wiki/Downloads/">https://www.virtualbox.org/wiki/Downloads/</a></p>

<blockquote>
<p>提示：虽然 Vagrant 也支持 VMware，不过 VMware 是收费的，对应的 Vagrant 版本也是收费的</p>
</blockquote>

<h1 id="2-安装vagrant并添加镜像">2、安装Vagrant并添加镜像</h1>

<p>下载安装包：<a href="http://downloads.vagrantup.com/">http://downloads.vagrantup.com/</a>，然后安装。</p>

<p>vagrant提供了很多已经打包的box，你可以去<a href="https://app.vagrantup.com/boxes/search">网站</a>搜索你想要的box,例如<code>centos/7</code> 的box，可以通过<code>vagrant</code>自动下载：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ mkdir centos7
$ vagrant init centos/7</code></pre></td></tr></table>
</div>
</div>
<p>也可以手动下载再添加：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ wget https://github.com/CommanderK5/packer-centos-template/<span class="se">\
</span><span class="se"></span>releases/download/0.7.2/vagrant-centos-7.2.box

$ vagrant box add centos7.2 vagrant-centos-7.2.box</code></pre></td></tr></table>
</div>
</div>
<p>镜像都被安装在 <code>~/.vagrant.d/boxes</code> 目录下面，可以查看安装了哪些镜像：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">vagrant box list
centos/7          <span class="o">(</span>virtualbox, <span class="m">1902</span>.01<span class="o">)</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="3-创建一个虚拟机">3、创建一个虚拟机</h1>

<p>先创建一个目录：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ mkdir -p ~/vagrant/centos7</code></pre></td></tr></table>
</div>
</div>
<p>初始化:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">cd</span> ~/vagrant/centos7

<span class="c1"># 如果本地没有centos/7镜像，则第一次使用会从远程下载</span>
$ vagrant init centos/7
A <span class="sb">`</span>Vagrantfile<span class="sb">`</span> has been placed in this directory. You are now
ready to <span class="sb">`</span>vagrant up<span class="sb">`</span> your first virtual environment! Please <span class="nb">read</span>
the comments in the Vagrantfile as well as documentation on
<span class="sb">`</span>vagrantup.com<span class="sb">`</span> <span class="k">for</span> more information on using Vagrant.</code></pre></td></tr></table>
</div>
</div>
<p>在当前目录生成了 Vagrantfile 文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>

<span class="c1"># All Vagrant configuration is done below. The &#34;2&#34; in Vagrant.configure</span>
<span class="c1"># configures the configuration version (we support older styles for</span>
<span class="c1"># backwards compatibility). Please don&#39;t change it unless you know what</span>
<span class="c1"># you&#39;re doing.</span>
Vagrant.configure<span class="o">(</span><span class="s2">&#34;2&#34;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
  <span class="c1"># The most common configuration options are documented and commented below.</span>
  <span class="c1"># For a complete reference, please see the online documentation at</span>
  <span class="c1"># https://docs.vagrantup.com.</span>

  <span class="c1"># Every Vagrant development environment requires a box. You can search for</span>
  <span class="c1"># boxes at https://vagrantcloud.com/search.</span>
  config.vm.box <span class="o">=</span> <span class="s2">&#34;centos/7&#34;</span>

  <span class="c1"># Disable automatic box update checking. If you disable this, then</span>
  <span class="c1"># boxes will only be checked for updates when the user runs</span>
  <span class="c1"># `vagrant box outdated`. This is not recommended.</span>
  <span class="c1"># config.vm.box_check_update = false</span>

  <span class="c1"># Create a forwarded port mapping which allows access to a specific port</span>
  <span class="c1"># within the machine from a port on the host machine. In the example below,</span>
  <span class="c1"># accessing &#34;localhost:8080&#34; will access port 80 on the guest machine.</span>
  <span class="c1"># NOTE: This will enable public access to the opened port</span>
  <span class="c1"># config.vm.network &#34;forwarded_port&#34;, guest: 80, host: 8080</span>

  <span class="c1"># Create a forwarded port mapping which allows access to a specific port</span>
  <span class="c1"># within the machine from a port on the host machine and only allow access</span>
  <span class="c1"># via 127.0.0.1 to disable public access</span>
  <span class="c1"># config.vm.network &#34;forwarded_port&#34;, guest: 80, host: 8080, host_ip: &#34;127.0.0.1&#34;</span>

  <span class="c1"># Create a private network, which allows host-only access to the machine</span>
  <span class="c1"># using a specific IP.</span>
  <span class="c1"># config.vm.network &#34;private_network&#34;, ip: &#34;192.168.33.10&#34;</span>

  <span class="c1"># Create a public network, which generally matched to bridged network.</span>
  <span class="c1"># Bridged networks make the machine appear as another physical device on</span>
  <span class="c1"># your network.</span>
  <span class="c1"># config.vm.network &#34;public_network&#34;</span>

  <span class="c1"># Share an additional folder to the guest VM. The first argument is</span>
  <span class="c1"># the path on the host to the actual folder. The second argument is</span>
  <span class="c1"># the path on the guest to mount the folder. And the optional third</span>
  <span class="c1"># argument is a set of non-required options.</span>
  <span class="c1"># config.vm.synced_folder &#34;../data&#34;, &#34;/vagrant_data&#34;</span>

  <span class="c1"># Provider-specific configuration so you can fine-tune various</span>
  <span class="c1"># backing providers for Vagrant. These expose provider-specific options.</span>
  <span class="c1"># Example for VirtualBox:</span>
  #
  <span class="c1"># config.vm.provider &#34;virtualbox&#34; do |vb|</span>
  <span class="c1">#   # Display the VirtualBox GUI when booting the machine</span>
  <span class="c1">#   vb.gui = true</span>
  #
  <span class="c1">#   # Customize the amount of memory on the VM:</span>
  <span class="c1">#   vb.memory = &#34;1024&#34;</span>
  <span class="c1"># end</span>
  #
  <span class="c1"># View the documentation for the provider you are using for more</span>
  <span class="c1"># information on available options.</span>

  <span class="c1"># Enable provisioning with a shell script. Additional provisioners such as</span>
  <span class="c1"># Puppet, Chef, Ansible, Salt, and Docker are also available. Please see the</span>
  <span class="c1"># documentation for more information about their specific syntax and use.</span>
  <span class="c1"># config.vm.provision &#34;shell&#34;, inline: \&lt;&lt;-SHELL</span>
  <span class="c1">#   apt-get update</span>
  <span class="c1">#   apt-get install -y apache2</span>
  <span class="c1"># SHELL</span>
end</code></pre></td></tr></table>
</div>
</div>
<p>启动虚拟机：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ vagrant up
Bringing machine <span class="s1">&#39;default&#39;</span> up with <span class="s1">&#39;virtualbox&#39;</span> provider...
<span class="o">==</span>&gt; default: Importing base box <span class="s1">&#39;centos/7&#39;</span>...
<span class="o">==</span>&gt; default: Matching MAC address <span class="k">for</span> NAT networking...
<span class="o">==</span>&gt; default: Checking <span class="k">if</span> box <span class="s1">&#39;centos/7&#39;</span> version <span class="s1">&#39;1902.01&#39;</span> is up to date...
<span class="o">==</span>&gt; default: Setting the name of the VM: <span class="nv">centos7_default_1560316234686_30302</span>
<span class="o">==</span>&gt; default: Fixed port collision <span class="k">for</span> <span class="nv">22</span> <span class="o">=</span>&gt; <span class="m">2222</span>. Now on port <span class="m">2202</span>.
<span class="o">==</span>&gt; default: Clearing any previously <span class="nb">set</span> network interfaces...
<span class="o">==</span>&gt; default: Preparing network interfaces based on configuration...
    default: Adapter <span class="m">1</span>: <span class="nv">nat</span>
<span class="o">==</span>&gt; default: Forwarding ports...
    default: <span class="m">22</span> <span class="o">(</span>guest<span class="o">)</span> <span class="o">=</span>&gt; <span class="m">2202</span> <span class="o">(</span>host<span class="o">)</span> <span class="o">(</span>adapter <span class="m">1</span><span class="o">)</span>
<span class="o">==</span>&gt; default: Booting VM...
<span class="o">==</span>&gt; default: Waiting <span class="k">for</span> machine to boot. This may take a few minutes...
    default: SSH address: <span class="m">127</span>.0.0.1:2202
    default: SSH username: vagrant
    default: SSH auth method: private key
    default:
    default: Vagrant insecure key detected. Vagrant will automatically replace
    default: this with a newly generated keypair <span class="k">for</span> better security.
    default:
    default: Inserting generated public key within guest...
    default: Removing insecure key from the guest <span class="k">if</span> it<span class="se">\&#39;</span>s present...
    default: Key inserted! Disconnecting and reconnecting using new SSH key...
<span class="o">==</span>&gt; default: Machine booted and ready!
<span class="o">==</span>&gt; default: Checking <span class="k">for</span> guest additions in VM...
    default: No guest additions were detected on the base box <span class="k">for</span> this VM! Guest
    default: additions are required <span class="k">for</span> forwarded ports, shared folders, host only
    default: networking, and more. If SSH fails on this machine, please install
    default: the guest additions and repackage the box to <span class="k">continue</span>.
    default:
    default: This is not an error message<span class="p">;</span> everything may <span class="k">continue</span> to work properly,
    default: in which <span class="k">case</span> you may ignore this message.
<span class="o">==</span>&gt; default: Rsyncing folder: /Users/june/vagrant/centos7/ <span class="o">=</span>&gt; /vagrant</code></pre></td></tr></table>
</div>
</div>
<p>你会看到终端显示了启动过程，启动完成后，我们就可以用 SSH 登录虚拟机了，剩下的步骤就是在虚拟机里配置你要运行的各种环境和参数了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ vagrant ssh  
$ <span class="nb">cd</span> /vagrant  </code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ vagrant ssh-config
Host default
  HostName <span class="m">127</span>.0.0.1
  User vagrant
  Port <span class="m">2222</span>
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile /Users/june/workspace/vagrant/devops/.vagrant/machines/default/virtualbox/private_key
  IdentitiesOnly yes
  LogLevel FATAL</code></pre></td></tr></table>
</div>
</div>
<blockquote>
<p>注意：vagrant将PasswordAuthentication设置为no了，这样就无法通过密码登陆，也不能设置root用户无密码登陆到其他节点，需要改成false</p>
</blockquote>

<p>scp 拷贝文件到虚拟机：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">scp -i /Users/june/workspace/vagrant/devops/.vagrant/machines/default/virtualbox/private_key test.sql vagrant@192.168.56.100:~</code></pre></td></tr></table>
</div>
</div>
<h1 id="4-vagrantfile配置说明">4、Vagrantfile配置说明</h1>

<p>Vagrant 初始化成功后，会在初始化的目录里生成一个 Vagrantfile 的配置文件，可以修改配置文件进行个性化的定制。</p>

<ul>
<li><code>config.vm.box</code>：使用的镜像名称</li>
<li><code>config.vm.hostname</code>：配置虚拟机主机名</li>
<li><code>config.vm.network</code>：这是配置虚拟机网络，由于比较复杂，我们其后单独讨论</li>
<li><code>config.vm.synced_folder</code>：除了默认的目录绑定外，还可以手动指定绑定</li>
<li><code>config.ssh.username</code>：默认的用户是vagrant，从官方下载的box往往使用的是这个用户名。如果是自定制的box，所使用的用户名可能会有所不同，通过这个配置设定所用的用户名。</li>
<li><code>config.vm.provision</code>：我们可以通过这个配置在虚拟机第一次启动的时候进行一些安装配置。</li>
</ul>

<h2 id="box设置">box设置</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">config.vm.box = &#34;centos/7&#34;</pre></td></tr></table>
</div>
</div>
<p>该名称是再使用<code>vagrant init</code> 中后面跟的名字。</p>

<h2 id="hostname设置"><strong>hostname设置</strong></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">config.vm.hostname = &#34;node1&#34;</pre></td></tr></table>
</div>
</div>
<p>设置hostname非常重要，因为当我们有很多台虚拟服务器的时候，都是依靠hostname來做识别的。比如，我安装了node1、node2两台虚拟机，再启动时，我可以通过vagrant up node1来指定只启动哪一台。</p>

<h2 id="虚拟机网络设置">虚拟机网络设置</h2>

<p>Vagrant的网络连接方式有三种：
- <code>NAT</code> : 缺省创建，用于让vm可以通过host转发访问局域网甚至互联网。
- <code>host-only</code> : 只有主机可以访问vm，其他机器无法访问它。
- <code>bridge</code> : 此模式下vm就像局域网中的一台独立的机器，可以被其他机器访问。
- <code>forwarded_port</code>：端口转发</p>

<p>说明：</p>

<ul>
<li><p>默认所有主机都会创建一个NAT网络作为eth0的网络，ip地址是自动分配的。</p></li>

<li><p>写了ip就是静态ip地址，没写ip就会dhcp自动分配一个地址。</p></li>

<li><p>如果写了多条网络配置，那么就是配置多个网络，服务器会自动多几个网卡。当然，默认的NAT网络的eth0还在（作为vagrant ssh命令登录使用的网络，还有yum更新的网络），自己写的配置文件，从上到下依次匹配eth1、eth2等。</p></li>
</ul>

<p>配置host-only网络：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 指定ip</span>
config.vm.network :private_network, ip: <span class="s2">&#34;192.168.56.10&#34;</span>

<span class="c1"># IP可以不指定，而是采用dhcp自动生成的方式</span>
config.vm.network <span class="s2">&#34;private_network&#34;</span>, type: <span class="s2">&#34;dhcp&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>创建一个bridge桥接网络：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 指定IP</span>
config.vm.network <span class="s2">&#34;public_network&#34;</span>, ip: <span class="s2">&#34;192.168.56.17&#34;</span>

<span class="c1">#创建一个bridge桥接网络，指定桥接适配器</span>
config.vm.network <span class="s2">&#34;public_network&#34;</span>, bridge: <span class="s2">&#34;en0: Wi-Fi (AirPort)&#34;</span>

<span class="c1">#创建一个bridge桥接网络，不指定桥接适配器</span>
config.vm.network <span class="s2">&#34;public_network&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>端口转发设置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">config.vm.network :forwarded_port, guest: <span class="m">80</span>, host: <span class="m">8080</span></code></pre></td></tr></table>
</div>
</div>
<p>上面的配置把宿主机上的8080端口映射到客户虚拟机的80端口，例如你在虚拟机上使用nginx跑了一个Go应用，那么你在host上的浏览器中打开 <a href="http://localhost:8080">http://localhost:8080</a> 时，Vagrant就会把这个请求转发到虚拟机里跑在80端口的nginx服务上。不建议使用该方法，因为涉及端口占用问题，常常导致应用之间不能正常通信，建议使用Host-only和Bridge方式进行设置。</p>

<p>guest和host是必须的，还有几个可选属性：</p>

<ul>
<li><code>guest_ip</code>：字符串，vm指定绑定的Ip，缺省为<code>0.0.0.0</code></li>
<li><code>host_ip</code>：字符串，host指定绑定的Ip，缺省为<code>0.0.0.0</code></li>
<li><code>protocol</code>：字符串，可选TCP或UDP，缺省为TCP</li>
</ul>

<h3 id="宿主机与虚机共享同步目录">宿主机与虚机共享同步目录</h3>

<p>默认宿主机<strong>项目目录</strong>和虚拟机下的<code>**/vagrant**</code>目录同步。</p>

<p>如果还想自定义共享目录，可以参照下面用法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">config.vm.synced_folder &#34;宿主机目录&#34;, &#34;虚机机目录&#34;
    create: true|false, owner: &#34;用户&#34;, group: &#34;用户组&#34;</pre></td></tr></table>
</div>
</div>
<ul>
<li><strong>宿主机目录</strong>一般是写的相对路径。相对的路径是相对的<strong>项目根目录</strong>。例如项目目录为test，那么宿主机目录写<code>&quot;www/&quot;</code>指的就是就是<code>test/www</code>目录。</li>
<li><strong>虚拟目录</strong>是虚拟机上目录，一般写绝对路径。</li>
<li><strong>create: true|false</strong>指的是是否在虚拟机<strong>创建</strong>此目录。</li>

<li><p><strong>owner: &ldquo;用户&rdquo;, group: &ldquo;用户组&rdquo;</strong>指的是指定目录的拥有者和拥有组。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">config.vm.synced_folder &#34;www/&#34;, &#34;/var/www/&#34;,
create: true, owner: &#34;root&#34;, group: &#34;root&#34;</pre></td></tr></table>
</div>
</div></li>
</ul>

<h2 id="定义虚拟机节点名称">定义虚拟机节点名称</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">config.vm.define :mysql <span class="k">do</span> <span class="p">|</span>mysql_config<span class="p">|</span>
<span class="c1"># ...</span>
end</code></pre></td></tr></table>
</div>
</div>
<p>表示在config配置中，定义一个名为mysql的vm配置，该节点下的配置信息命名为mysql_config； 如果该Vagrantfile配置文件只定义了一个vm，这个配置节点层次可忽略。</p>

<p>还可以在一个Vagrantfile文件里建立多个虚拟机，一般情况下，你可以用多主机功能完成以下任务：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">Vagrant.configure<span class="o">(</span><span class="s2">&#34;2&#34;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
 
  config.vm.define <span class="s2">&#34;web&#34;</span> <span class="k">do</span> <span class="p">|</span>web<span class="p">|</span>
    web.vm.box <span class="o">=</span> <span class="s2">&#34;apache&#34;</span>
  end
 
  config.vm.define <span class="s2">&#34;db&#34;</span> <span class="k">do</span> <span class="p">|</span>db<span class="p">|</span>
    db.vm.box <span class="o">=</span> <span class="s2">&#34;mysql&#34;</span>
  end
end</code></pre></td></tr></table>
</div>
</div>
<p>当定义了多主机之后，在使用vagrant命令的时候，就需要加上主机名，例如vagrant ssh web；也有一些命令，如果你不指定特定的主机，那么将会对所有的主机起作用，比如vagrant up；你也可以使用表达式指定特定的主机名，例如vagrant up /follower[0-9]/。</p>

<h2 id="通用数据">通用数据</h2>

<p>设置一些基础数据，供配置信息中调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">app_servers = {
    :service1 =&gt; &#39;192.168.33.20&#39;,
    :service2 =&gt; &#39;192.168.33.21&#39;
}</pre></td></tr></table>
</div>
</div>
<p>这里是定义一个hashmap，以key-value方式来存储vm主机名和ip地址。</p>

<h2 id="配置信息">配置信息</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#指定vm的语言环境，缺省地，会继承host的locale配置</span>
ENV<span class="o">[</span><span class="s2">&#34;LC_ALL&#34;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&#34;en_US.UTF-8&#34;</span> 

Vagrant.configure<span class="o">(</span><span class="s2">&#34;2&#34;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
    <span class="c1"># ...</span>
end</code></pre></td></tr></table>
</div>
</div>
<p>参数2，表示的是当前配置文件使用的vagrant configure版本号为Vagrant 1.1+,如果取值为1，表示为Vagrant 1.0.x Vagrantfiles，旧版本暂不考虑，记住就写2即可。</p>

<h2 id="提供者配置">提供者配置</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">config.vm.provider :virtualbox do |vb|
     # ...
end</pre></td></tr></table>
</div>
</div>
<p>虚机容器提供者配置，对于不同的provider，特有的一些配置，此处配置信息是针对virtualbox定义一个提供者，命名为vb，跟前面一样，这个名字随意取，只要节点内部调用一致即可。</p>

<p>配置信息又分为通用配置和个性化配置，通用配置对于不同provider是通用的，常用的通用配置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">vb.name <span class="o">=</span> <span class="s2">&#34;centos7&#34;</span>
<span class="c1">#指定vm-name，也就是virtualbox管理控制台中的虚机名称。如果不指定该选项会生成</span>
<span class="c1">#一个随机的名字，不容易区分。</span>
vb.gui <span class="o">=</span> <span class="nb">true</span>
<span class="c1"># vagrant up启动时，是否自动打开virtual box的窗口，缺省为false</span>
vb.memory <span class="o">=</span> <span class="s2">&#34;1024&#34;</span>
<span class="c1">#指定vm内存，单位为MB</span>
vb.cpus <span class="o">=</span> <span class="m">2</span>
<span class="c1">#设置CPU个数</span></code></pre></td></tr></table>
</div>
</div>
<p>上面的provider配置是通用的配置，针对不同的虚拟机，还有一些的个性的配置，通过vb.customize配置来定制。</p>

<p>对virtual box的个性化配置，可以参考：VBoxManage modifyvm 命令的使用方法。详细的功能接口和使用说明，可以参考virtualbox官方文档。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#修改vb.name的值</span>
v.customize <span class="o">[</span><span class="s2">&#34;modifyvm&#34;</span>, :id, <span class="s2">&#34;--name&#34;</span>, <span class="s2">&#34;mfsmaster2&#34;</span><span class="o">]</span>
 
<span class="c1">#如修改显存，缺省为8M，如果启动桌面，至少需要10M，如下修改为16M：</span>
vb.customize <span class="o">[</span><span class="s2">&#34;modifyvm&#34;</span>, :id, <span class="s2">&#34;--vram&#34;</span>, <span class="s2">&#34;16&#34;</span><span class="o">]</span>
 
<span class="c1">#调整虚拟机的内存</span>
 vb.customize <span class="o">[</span><span class="s2">&#34;modifyvm&#34;</span>, :id, <span class="s2">&#34;--memory&#34;</span>, <span class="s2">&#34;1024&#34;</span><span class="o">]</span>
 
<span class="c1">#指定虚拟CPU个数</span>
 vb.customize <span class="o">[</span><span class="s2">&#34;modifyvm&#34;</span>, :id, <span class="s2">&#34;--cpus&#34;</span>, <span class="s2">&#34;2&#34;</span><span class="o">]</span>
 
<span class="c1">#增加光驱：</span>
vb.customize <span class="o">[</span><span class="s2">&#34;storageattach&#34;</span>,:id,<span class="s2">&#34;--storagectl&#34;</span>, <span class="s2">&#34;IDE Controller&#34;</span>,
<span class="s2">&#34;--port&#34;</span>,<span class="s2">&#34;0&#34;</span>,<span class="s2">&#34;--device&#34;</span>,<span class="s2">&#34;0&#34;</span>,<span class="s2">&#34;--type&#34;</span>,<span class="s2">&#34;dvddrive&#34;</span>,<span class="s2">&#34;--medium&#34;</span>,
<span class="s2">&#34;/Applications/VirtualBox.app/Contents/MacOS/VBoxGuestAdditions.iso&#34;</span><span class="o">]</span>

<span class="c1">#注：meduim参数不可以为空，如果只挂载驱动器不挂在iso，指定为“emptydrive”。</span>
<span class="c1"># 如果要卸载光驱，medium传入none即可。</span>
<span class="c1"># 从这个指令可以看出，customize方法传入一个json数组，按照顺序传入参数即可。</span>
 
<span class="c1">#json数组传入多个参数</span>
vb.customize <span class="o">[</span><span class="s2">&#34;modifyvm&#34;</span>, :id, <span class="s2">&#34;--name&#34;</span>, “mfsserver3<span class="s2">&#34;, &#34;</span>--memory<span class="s2">&#34;, “2048&#34;</span><span class="o">]</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="一组相同配置的vm">一组相同配置的vm</h2>

<p>前面配置了一组vm的hash map，定义一组vm时，使用如下节点遍历。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1">#遍历app_servers map，将key和value分别赋值给app_server_name和app_server_ip</span>
app_servers.each <span class="k">do</span> <span class="p">|</span>app_server_name, app_server_ip<span class="p">|</span>
     <span class="c1">#针对每一个app_server_name，来配置config.vm.define配置节点</span>
     config.vm.define app_server_name <span class="k">do</span> <span class="p">|</span>app_config<span class="p">|</span>
          <span class="c1"># 此处配置，参考config.vm.define</span>
     end
end</code></pre></td></tr></table>
</div>
</div>
<p>如果不想定义app_servers，下面也是一种方案：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">(</span><span class="m">1</span>..3<span class="o">)</span>.each <span class="k">do</span> <span class="p">|</span>i<span class="p">|</span>
        config.vm.define <span class="s2">&#34;app-#{i}&#34;</span> <span class="k">do</span> <span class="p">|</span>app_config<span class="p">|</span>
        app_config.vm.hostname <span class="o">=</span> <span class="s2">&#34;app-#{i}.vagrant.internal&#34;</span>
        app_config.vm.provider <span class="s2">&#34;virtualbox&#34;</span> <span class="k">do</span> <span class="p">|</span>vb<span class="p">|</span>
            vb.name <span class="o">=</span> app-#<span class="o">{</span>i<span class="o">}</span>
        end
  end
end</code></pre></td></tr></table>
</div>
</div>
<h2 id="provision任务">provision任务</h2>

<p>你可以编写一些命令，让vagrant在启动虚拟机的时候自动执行，这样你就可以省去手动配置环境的时间了。</p>

<p><strong>脚本何时会被执行</strong></p>

<p>● 第一次执行<code>vagrant up</code>命令
● 执行<code>vagrant provision</code>命令
● 执行<code>vagrant reload --provision</code>或者<code>vagrant up --provision</code>命令
● 你也可以在启动虚拟机的时候添加<code>--no-provision</code>参数以阻止脚本被执行</p>

<p><strong>provision任务是什么？</strong></p>

<p>provision任务是预先设置的一些操作指令，格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">config.vm.provision 命令字 json格式参数
 
config.vm.provion 命令字 <span class="k">do</span> <span class="p">|</span>s<span class="p">|</span>
    s.参数名 <span class="o">=</span> 参数值
end</code></pre></td></tr></table>
</div>
</div>
<p>根据任务操作的对象，provisioner可以分为：</p>

<ul>
<li>Shell</li>
<li>File</li>
<li>Ansible</li>
<li>CFEngine</li>
<li>Chef</li>
<li>Docker</li>
<li>Puppet</li>
<li>Salt</li>
</ul>

<p>根据vagrantfile的层次，分为：</p>

<ul>
<li><p>configure级：它定义在 Vagrant.configure(&ldquo;2&rdquo;) 的下一层次，形如： config.vm.provision &hellip;</p></li>

<li><p>vm级：它定义在 config.vm.define &ldquo;web&rdquo; do |web| 的下一层次，web.vm.provision &hellip;</p></li>
</ul>

<p>执行的顺序是先执行configure级任务，再执行vm级任务，即便configure级任务在vm定义的下面才定义。例如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">Vagrant.configure<span class="o">(</span><span class="s2">&#34;2&#34;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
  config.vm.provision <span class="s2">&#34;shell&#34;</span>, inline: <span class="s2">&#34;echo 1&#34;</span>
 
  config.vm.define <span class="s2">&#34;web&#34;</span> <span class="k">do</span> <span class="p">|</span>web<span class="p">|</span>
    web.vm.provision <span class="s2">&#34;shell&#34;</span>, inline: <span class="s2">&#34;echo 2&#34;</span>
  end
 
  config.vm.provision <span class="s2">&#34;shell&#34;</span>, inline: <span class="s2">&#34;echo 3&#34;</span>
end</code></pre></td></tr></table>
</div>
</div>
<p>输出结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html">==&gt; default: &#34;1&#34;
==&gt; default: &#34;2&#34;
==&gt; default: &#34;3&#34;</code></pre></td></tr></table>
</div>
</div>
<p><strong>如何使用</strong></p>

<p>1、单行脚本</p>

<p>helloword只是一个开始，对于inline模式，命令只能在写在一行中。</p>

<p>单行脚本使用的基本格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">config.vm.provision <span class="s2">&#34;shell&#34;</span>, inline: <span class="s2">&#34;echo fendo&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>shell命令的参数还可以写入do &hellip; end代码块中，如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">config.vm.provision <span class="s2">&#34;shell&#34;</span> <span class="k">do</span> <span class="p">|</span>s<span class="p">|</span>
  s.inline <span class="o">=</span> <span class="s2">&#34;echo hello provision.&#34;</span>
end</code></pre></td></tr></table>
</div>
</div>
<p>2、内联脚本</p>

<p>如果要执行脚本较多，可以在Vagrantfile中指定内联脚本，在Vagrant.configure节点外面，写入命名内联脚本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">$script</span> <span class="o">=</span> <span class="s">&lt;&lt;SCRIPT
</span><span class="s">    echo I am provisioning...
</span><span class="s">    echo hello provision.
</span><span class="s">SCRIPT</span></code></pre></td></tr></table>
</div>
</div>
<p>然后，inline调用如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">config.vm.provision <span class="s2">&#34;shell&#34;</span>, inline: <span class="nv">$script</span></code></pre></td></tr></table>
</div>
</div>
<p>3、外部脚本</p>

<p>也可以把代码写入代码文件，并保存在一个shell里，进行调用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">config.vm.provision <span class="s2">&#34;shell&#34;</span>, path: <span class="s2">&#34;script.sh&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="5-插件">5、插件</h1>

<p>插件安装方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">vagrant plugin install xxxx</code></pre></td></tr></table>
</div>
</div>
<h3 id="5-1-vagrant-hostmanager">5.1、 vagrant-hostmanager</h3>

<p>可以实现虚机之间用主机名互相访问，也可以实现宿主机用主机名访问虚机。</p>

<p>安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">vagrant plugin install vagrant-hostmanager</code></pre></td></tr></table>
</div>
</div>
<p>修改Vagrantfile文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">Vagrant.configure<span class="o">(</span><span class="s2">&#34;2&#34;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>

  config.vm.box <span class="o">=</span> <span class="s2">&#34;centos/7&#34;</span>
  config.hostmanager.enabled <span class="o">=</span> <span class="nb">true</span>       <span class="c1"># 启用hostmanager</span>
  config.hostmanager.manage_guest <span class="o">=</span> <span class="nb">true</span>  <span class="c1"># 允许更新虚拟机上的文件</span>
  config.hostmanager.manage_host <span class="o">=</span> <span class="nb">true</span>   <span class="c1"># 允许更新主机上的文件，需要输入密码</span>

  config.vm.define <span class="s2">&#34;node1&#34;</span> <span class="k">do</span> <span class="p">|</span>v<span class="p">|</span>
    v.vm.network <span class="s2">&#34;private_network&#34;</span>, ip: <span class="s2">&#34;192.168.56.11&#34;</span>
    v.vm.network <span class="s2">&#34;public_network&#34;</span>
    v.vm.hostname <span class="o">=</span> <span class="s2">&#34;node1.example.com&#34;</span>
  end

  config.vm.define <span class="s2">&#34;node2&#34;</span> <span class="k">do</span> <span class="p">|</span>v<span class="p">|</span>
    v.vm.network <span class="s2">&#34;private_network&#34;</span>, ip: <span class="s2">&#34;192.168.56.12&#34;</span>
    v.vm.hostname <span class="o">=</span> <span class="s2">&#34;node2.example.com&#34;</span>
  end

  config.vm.define <span class="s2">&#34;node3&#34;</span> <span class="k">do</span> <span class="p">|</span>v<span class="p">|</span>
    v.vm.network <span class="s2">&#34;private_network&#34;</span>, ip: <span class="s2">&#34;192.168.56.13&#34;</span>
    v.vm.hostname <span class="o">=</span> <span class="s2">&#34;node3.example.com&#34;</span>
  end

end</code></pre></td></tr></table>
</div>
</div>
<p>启动虚拟机以后会自动更新虚拟机的主机名，同时也会更新本地主机上的 hosts 文件里的内容。</p>

<p>或者我们也可以手工的去更新，执行命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">vagrant hostmanager</pre></td></tr></table>
</div>
</div>
<p>返回：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">[manager1] Updating /etc/hosts file...
[worker1] Updating /etc/hosts file...
[worker2] Updating /etc/hosts file...</pre></td></tr></table>
</div>
</div>
<h3 id="5-2-vagrant-vbguest">5.2、vagrant-vbguest</h3>

<p>有时候我们发现有些virtualbox无法使用自定义的共享目录，这时候就需要安装vbguest客户端（类似于VMware的client）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">vagrant vbguest --status
vagrant vbguest --do install node1
vagrant vbguest --do install node2
vagrant vbguest --do install node3
vagrant vbguest --status</code></pre></td></tr></table>
</div>
</div>
<p>每次启动虚机都会检查vbguest插件的更新，如果不想更新，修改Vgrantfilew文件，加上这样一条：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">config.vbguest.auto_update <span class="o">=</span> false</code></pre></td></tr></table>
</div>
</div>
<h3 id="5-3-vagrant-bindfs">5.3、vagrant-bindfs</h3>

<p>插件bindfs可以支持多种共享模式，如nfs，samba</p>

<p>命令行下输入：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">vagrant plugin install vagrant-bindfs</code></pre></td></tr></table>
</div>
</div>
<p>修改Vgrantfile文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">config.vm.define <span class="s2">&#34;node1&#34;</span> <span class="k">do</span> <span class="p">|</span>v<span class="p">|</span>
  v.vm.network <span class="s2">&#34;private_network&#34;</span>, ip: <span class="s2">&#34;192.168.56.11&#34;</span>
  v.vm.hostname<span class="o">=</span><span class="s2">&#34;node1.example.com&#34;</span>
  v.vm.synced_folder <span class="s2">&#34;./app&#34;</span> <span class="s2">&#34;/mnt/app-data&#34;</span>, type: <span class="s2">&#34;nfs&#34;</span>
  v.bindfs.bind_folder <span class="s2">&#34;/mnt/app-data&#34;</span> <span class="s2">&#34;/app&#34;</span>
    force_user: <span class="s2">&#34;root&#34;</span>, force_group: <span class="s2">&#34;root&#34;</span>, o: <span class="s2">&#34;noempty&#34;</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="6-实验例子">6、实验例子</h1>

<h3 id="6-1-搭建一个每台机器不同配置的实验环境">6.1、搭建一个每台机器不同配置的实验环境</h3>

<p>用自己做的镜像最好，首先是已经安装了一些常用的包，二是如果是初始镜像，一开始需要安装几个包，比较耽误时间，自己打包的镜像已经安装好了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>

Vagrant.configure<span class="o">(</span><span class="s2">&#34;2&#34;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
  <span class="c1"># Vagrant Global Config</span>
  config.vm.box <span class="o">=</span> <span class="s2">&#34;centos/7&#34;</span>
  config.vm.provision :shell, :path <span class="o">=</span>&gt; <span class="s2">&#34;bootstrap.sh&#34;</span>
  
  config.vm.define <span class="s2">&#34;node1&#34;</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
    config.vm.network <span class="s2">&#34;private_network&#34;</span>, ip: <span class="s2">&#34;192.168.56.11&#34;</span>
    <span class="c1">#添加一个桥接网络</span>
    config.vm.network <span class="s2">&#34;public_network&#34;</span>, bridge: <span class="s2">&#34;en0: Wi-Fi (AirPort)&#34;</span>
    config.vm.hostname <span class="o">=</span> <span class="s2">&#34;server&#34;</span>
  end
  
  config.vm.define <span class="s2">&#34;node2&#34;</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
    v.vm.network <span class="s2">&#34;private_network&#34;</span>, ip: <span class="s2">&#34;192.168.56.12&#34;</span>
    v.vm.hostname <span class="o">=</span> <span class="s2">&#34;node1&#34;</span>
  end
  
  config.vm.define <span class="s2">&#34;node3&#34;</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
    config.vm.network <span class="s2">&#34;private_network&#34;</span>, ip: <span class="s2">&#34;192.168.56.13&#34;</span>
    config.vm.hostname <span class="o">=</span> <span class="s2">&#34;node2&#34;</span>
  end

end</code></pre></td></tr></table>
</div>
</div>
<p>bootstrap.sh：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/usr/bin/env bash
</span><span class="cp"></span>
<span class="c1">#root密码为root</span>
<span class="nb">echo</span> <span class="s1">&#39;root&#39;</span><span class="p">|</span>passwd root --stdin &gt;/dev/null <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
sudo yum install -y wget vim net-tools

cat &gt; /etc/hosts <span class="s">&lt;&lt;EOF
</span><span class="s">127.0.0.1       localhost
</span><span class="s">192.168.56.11 node1 node1.example.com
</span><span class="s">192.168.56.12 node2 node2.example.com
</span><span class="s">192.168.56.13 node3 node3.example.com
</span><span class="s">EOF</span>

<span class="c1"># 关闭selinux</span>
sudo setenforce <span class="m">0</span>
<span class="c1"># 永久禁止selinux</span>
sudo sed -i <span class="s1">&#39;s/SELINUX=enforcing/SELINUX=disabled/g&#39;</span> /etc/selinux/config
<span class="c1"># 删除网卡的信息，否则在其他地方启动会有问题</span>
sudo rm -rf /etc/udev/rules.d/70-persistent-net.rules

sudo <span class="nb">echo</span> <span class="s1">&#39;GATEWAY=192.168.56.1&#39;</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-eth1</code></pre></td></tr></table>
</div>
</div>
<h3 id="6-2-批量搭建一组服务器">6.2、批量搭建一组服务器</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>

Vagrant.configure<span class="o">(</span><span class="s2">&#34;2&#34;</span><span class="o">)</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
  config.vm.box <span class="o">=</span> <span class="s2">&#34;centos/7&#34;</span>
  config.vm.provision :shell, :path <span class="o">=</span>&gt; <span class="s2">&#34;bootstrap.sh&#34;</span>

  <span class="o">(</span><span class="m">1</span>..3<span class="o">)</span>.each <span class="k">do</span> <span class="p">|</span>i<span class="p">|</span>
    config.vm.define <span class="s2">&#34;node#{i}&#34;</span> <span class="k">do</span> <span class="p">|</span>config<span class="p">|</span>
        config.vm.provider <span class="s2">&#34;virtualbox&#34;</span> <span class="k">do</span> <span class="p">|</span>v<span class="p">|</span>
        v.customize <span class="o">[</span><span class="s2">&#34;modifyvm&#34;</span>, :id, <span class="s2">&#34;--name&#34;</span>, <span class="s2">&#34;node#{i}&#34;</span>, 
        <span class="s2">&#34;--memory&#34;</span>, <span class="s2">&#34;1024&#34;</span>,<span class="s1">&#39;--cpus&#39;</span>, <span class="m">1</span><span class="o">]</span>
        v.gui <span class="o">=</span> <span class="nb">false</span>
      end
      config.vm.network <span class="s2">&#34;private_network&#34;</span>, ip: <span class="s2">&#34;192.168.56.1#{i}&#34;</span>
      config.vm.hostname <span class="o">=</span> <span class="s2">&#34;node#{i}&#34;</span>
    end
  end
end</code></pre></td></tr></table>
</div>
</div>
<p>查看node1网卡：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ ifconfig
eth0: <span class="nv">flags</span><span class="o">=</span><span class="m">4163</span>&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
        inet <span class="m">10</span>.0.2.15  netmask <span class="m">255</span>.255.255.0  broadcast <span class="m">10</span>.0.2.255
        inet6 fe80::5054:ff:fe26:1060  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
        ether <span class="m">52</span>:54:00:26:10:60  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets <span class="m">93</span>  bytes <span class="m">10565</span> <span class="o">(</span><span class="m">10</span>.3 KiB<span class="o">)</span>
        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
        TX packets <span class="m">76</span>  bytes <span class="m">9099</span> <span class="o">(</span><span class="m">8</span>.8 KiB<span class="o">)</span>
        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>

eth1: <span class="nv">flags</span><span class="o">=</span><span class="m">4163</span>&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="m">1500</span>
        inet <span class="m">192</span>.168.56.11  netmask <span class="m">255</span>.255.255.0  broadcast <span class="m">192</span>.168.56.255
        inet6 fe80::a00:27ff:feff:2ad1  prefixlen <span class="m">64</span>  scopeid 0x20&lt;link&gt;
        ether <span class="m">08</span>:00:27:ff:2a:d1  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets <span class="m">0</span>  bytes <span class="m">0</span> <span class="o">(</span><span class="m">0</span>.0 B<span class="o">)</span>
        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
        TX packets <span class="m">11</span>  bytes <span class="m">836</span> <span class="o">(</span><span class="m">836</span>.0 B<span class="o">)</span>
        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span>

lo: <span class="nv">flags</span><span class="o">=</span><span class="m">73</span>&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class="m">65536</span>
        inet <span class="m">127</span>.0.0.1  netmask <span class="m">255</span>.0.0.0
        inet6 ::1  prefixlen <span class="m">128</span>  scopeid 0x10&lt;host&gt;
        loop  txqueuelen <span class="m">1000</span>  <span class="o">(</span>Local Loopback<span class="o">)</span>
        RX packets <span class="m">0</span>  bytes <span class="m">0</span> <span class="o">(</span><span class="m">0</span>.0 B<span class="o">)</span>
        RX errors <span class="m">0</span>  dropped <span class="m">0</span>  overruns <span class="m">0</span>  frame <span class="m">0</span>
        TX packets <span class="m">0</span>  bytes <span class="m">0</span> <span class="o">(</span><span class="m">0</span>.0 B<span class="o">)</span>
        TX errors <span class="m">0</span>  dropped <span class="m">0</span> overruns <span class="m">0</span>  carrier <span class="m">0</span>  collisions <span class="m">0</span></code></pre></td></tr></table>
</div>
</div>
<p>eth0：NAT模式</p>

<p>eth1：是hostonly模式</p>

<blockquote>
<p>说明：如果需要配置一个外网ip，可以停机后在virtualbox的设置里面添加网卡3为桥接模式，然后再起到虚拟机。</p>
</blockquote>

<p><strong>修改虚拟机网络</strong></p>

<p>删除每个节点的网卡1，并修改eth0为静态IP：</p>

<p>修改node1节点/etc/sysconfig/network-scripts/ifcfg-eth0：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">DEVICE</span><span class="o">=</span><span class="s2">&#34;eth0&#34;</span>
<span class="nv">BOOTPROTO</span><span class="o">=</span><span class="s2">&#34;static&#34;</span>
<span class="nv">ONBOOT</span><span class="o">=</span><span class="s2">&#34;yes&#34;</span>
<span class="nv">TYPE</span><span class="o">=</span><span class="s2">&#34;Ethernet&#34;</span>
<span class="nv">PERSISTENT_DHCLIENT</span><span class="o">=</span><span class="s2">&#34;yes&#34;</span>
<span class="nv">IPADDR</span><span class="o">=</span><span class="m">192</span>.168.56.11
<span class="nv">NETMASK</span><span class="o">=</span><span class="m">255</span>.255.255.0</code></pre></td></tr></table>
</div>
</div>
<p>node1节点添加一个网卡2设置为桥接模式，并行修改IP为静态IP：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ cat /etc/sysconfig/network-scripts/ifcfg-eth1
<span class="nv">DEVICE</span><span class="o">=</span><span class="s2">&#34;eth1&#34;</span>
<span class="nv">BOOTPROTO</span><span class="o">=</span><span class="s2">&#34;static&#34;</span>
<span class="nv">ONBOOT</span><span class="o">=</span><span class="s2">&#34;yes&#34;</span>
<span class="nv">TYPE</span><span class="o">=</span><span class="s2">&#34;Ethernet&#34;</span>
<span class="nv">PERSISTENT_DHCLIENT</span><span class="o">=</span><span class="s2">&#34;yes&#34;</span>
<span class="nv">IPADDR</span><span class="o">=</span><span class="m">172</span>.20.10.8
<span class="nv">NETMASK</span><span class="o">=</span><span class="m">255</span>.255.255.0</code></pre></td></tr></table>
</div>
</div>
<p>修改node2节点/etc/sysconfig/network-scripts/ifcfg-eth0：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">DEVICE</span><span class="o">=</span><span class="s2">&#34;eth0&#34;</span>
<span class="nv">BOOTPROTO</span><span class="o">=</span><span class="s2">&#34;static&#34;</span>
<span class="nv">ONBOOT</span><span class="o">=</span><span class="s2">&#34;yes&#34;</span>
<span class="nv">TYPE</span><span class="o">=</span><span class="s2">&#34;Ethernet&#34;</span>
<span class="nv">PERSISTENT_DHCLIENT</span><span class="o">=</span><span class="s2">&#34;yes&#34;</span>
<span class="nv">IPADDR</span><span class="o">=</span><span class="m">192</span>.168.56.12
<span class="nv">NETMASK</span><span class="o">=</span><span class="m">255</span>.255.255.0
<span class="nv">GATEWAY</span><span class="o">=</span><span class="m">192</span>.168.56.11</code></pre></td></tr></table>
</div>
</div>
<p>修改node3节点/etc/sysconfig/network-scripts/ifcfg-eth0：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">DEVICE</span><span class="o">=</span><span class="s2">&#34;eth0&#34;</span>
<span class="nv">BOOTPROTO</span><span class="o">=</span><span class="s2">&#34;static&#34;</span>
<span class="nv">ONBOOT</span><span class="o">=</span><span class="s2">&#34;yes&#34;</span>
<span class="nv">TYPE</span><span class="o">=</span><span class="s2">&#34;Ethernet&#34;</span>
<span class="nv">PERSISTENT_DHCLIENT</span><span class="o">=</span><span class="s2">&#34;yes&#34;</span>
<span class="nv">IPADDR</span><span class="o">=</span><span class="m">192</span>.168.56.13
<span class="nv">NETMASK</span><span class="o">=</span><span class="m">255</span>.255.255.0
<span class="nv">GATEWAY</span><span class="o">=</span><span class="m">192</span>.168.56.11</code></pre></td></tr></table>
</div>
</div>
<p>修改完成之后，需要重启网卡：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">ifdown eth0

ifup eth0</code></pre></td></tr></table>
</div>
</div>
<p>因为vagrant ssh`需要连接NAT网卡，故现在无法执行成功，这个时候可以这样访问：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ ssh vagrant@192.168.56.11  -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no -o<span class="se">\
</span><span class="se"></span> <span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null -i .vagrant/machines/node1/virtualbox/private_key

$ ssh vagrant@192.168.56.12  -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no -o<span class="se">\
</span><span class="se"></span><span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null -i .vagrant/machines/node2/virtualbox/private_key

$ ssh vagrant@192.168.56.13  -o <span class="nv">StrictHostKeyChecking</span><span class="o">=</span>no -o<span class="se">\
</span><span class="se"></span><span class="nv">UserKnownHostsFile</span><span class="o">=</span>/dev/null -i .vagrant/machines/node3/virtualbox/private_key</code></pre></td></tr></table>
</div>
</div>
<p>配置yum源：</p>

<p>下载CentOS-7-x86_64-DVD-1810.iso拷贝到vagrant共享目录，在node1节点上配置yum：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">mount /vagrant/CentOS-7-x86_64-DVD-1810.iso /mnt/
rm -rf /etc/yum.repos.d/*
<span class="nb">echo</span> <span class="s2">&#34;
</span><span class="s2">[base]
</span><span class="s2">name=CentOS
</span><span class="s2">baseurl=file:///mnt/
</span><span class="s2">gpgcheck=0
</span><span class="s2">&#34;</span>  &gt; /etc/yum.repos.d/centos7.repo

yum install vsftpd
cp -r /mnt/* /var/ftp/pub
chkconfig vsftpd on
service vsftpd start


<span class="nb">echo</span> <span class="s2">&#34;
</span><span class="s2">[base]
</span><span class="s2">name=CentOS
</span><span class="s2">baseurl=ftp://192.168.56.11/pub/
</span><span class="s2">gpgcheck=0
</span><span class="s2">&#34;</span>  &gt; /etc/yum.repos.d/centos7.repo</code></pre></td></tr></table>
</div>
</div>
<p>在node2和node3上配置centos7.repo。</p>

<h1 id="7-参考文章">7、参考文章</h1>

<p><a href="https://www.jianshu.com/p/d56d42b8d97f">Vagrant&ndash;快速搭建实验环境利器</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">JavaChen</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2014-02-23
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/wechatpay.jpg">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/img/reward/alipay.jpg">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vagrant/">vagrant</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2014/02/26/how-to-install-solr/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Apache Solr介绍及安装</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/2014/02/22/python-introduction-of-basics/">
            <span class="next-text nav-default">Python基础入门</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="javachen/javachen.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:junecloud@163.com" class="iconfont icon-email" title="email"></a>
      <a href="http://github.com/javachen" class="iconfont icon-github" title="github"></a>
      <a href="http://weibo.com/chenzhijun" class="iconfont icon-weibo" title="weibo"></a>
      <a href="https://space.bilibili.com/287563020/" class="iconfont icon-bilibili" title="bilibili"></a>
  <a href="http://javachen.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2009 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">JavaChen</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.20b54c22.min.js"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?7eaf37274cf8796df56903a88389e82f";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>






</body>
</html>
